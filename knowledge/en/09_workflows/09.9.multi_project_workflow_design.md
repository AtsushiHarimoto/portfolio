# Multi-Project Workflow Rule Design Patterns

> **Type**: Workflow
> **Date**: 2026-01-03
> **Source**: Conversation ID (2026-01-03 Session)

---

## Summary

Design Agent rules and workflows that support multiple sub-projects. Through SCOPE path mapping, automatic identification, and error handling mechanisms, ensure the AI accurately locates the working directory and avoids cross-project mishaps.

---

## Background

In a multi-project monorepo architecture, AI Agents need to handle development tasks across different sub-projects. Without a clear SCOPE mapping mechanism, the following problems arise:

1. AI cannot determine the current working directory
2. Relative path references become ambiguous
3. Cross-project mis-operations (e.g., mixed commits)
4. Documentation and code path inconsistencies

---

## Detailed Design

### Core Design Principles

#### 1. SCOPE Path Mapping Table

In every workflow and rule file, explicitly define the mapping between SCOPE and paths:

```markdown
## SCOPE Path Mapping

| Sub-project       | Code Root                            | Doc Root                         | Review Output                           |
| ----------------- | ------------------------------------ | -------------------------------- | --------------------------------------- |
| **API**           | `projects/moyin-gateway/web2api`     | `projects/moyin-gateway/docs`    | `projects/moyin-gateway/docs/review`    |
| **moyin-web**     | `projects/moyin-web`                 | `projects/moyin-web/docs`        | `projects/moyin-web/docs/review`        |
| **moyin-game-v1** | `projects/moyin-game-v1/website`     | `projects/moyin-game-v1/docs`    | `projects/moyin-game-v1/docs/review`    |
| **QA**            | `projects/tests`                     | `projects/tests/docs`            | `projects/tests/docs/review`            |
```

#### 2. Step 0: Confirm Current SCOPE

The first step of every workflow must confirm the current SCOPE:

```markdown
### Step 0: Confirm Current SCOPE

// turbo
Check whether the user request explicitly specifies a sub-project.

**If not explicitly specified**:

- Use `ASK:` to ask the user to select a sub-project
- List all available options

**If already specified**:

- Confirm SCOPE and list corresponding paths
```

#### 3. Path Reference Rules

Relative paths are prohibited; use "SCOPE table lookup" instead:

**Wrong**:

```markdown
Output to the `docs/review/` directory
```

**Correct**:

```markdown
Output to the `[current SCOPE]/docs/review/` directory (refer to the SCOPE Path Mapping Table)
```

#### 4. Cross-SCOPE Detection and Handling

Workflows involving file operations must detect cross-SCOPE changes:

```markdown
**If cross-SCOPE changes exist**:

- List the changed files for each SCOPE
- Use `ASK:` to ask the user whether to handle them separately
- Recommendation: Execute this workflow separately per SCOPE
```

---

## Code/Command Examples

### Example 1: run-dev.md SCOPE Confirmation

```markdown
### Step 0: Confirm Current SCOPE

// turbo
Check whether the user request explicitly specifies a sub-project (API / moyin-web / moyin-game-v1 / QA).

**If not explicitly specified**:

- Use `ASK:` to ask the user: "Which sub-project is this development work targeting?"
- List four options: API, moyin-web, moyin-game-v1, QA

**If already specified**:

- Confirm in the response: "Current SCOPE: [sub-project name]"
- List the corresponding code root, doc root, and review output paths

**Output**: Current SCOPE and corresponding paths.
```

### Example 2: run-archive.md Automatic SCOPE Identification

```markdown
## SCOPE Path Mapping

Automatically identify SCOPE based on changed file paths:

| Path Prefix                  | SCOPE         | Archive Directory Prefix |
| ---------------------------- | ------------- | ----------------------- |
| `projects/moyin-gateway/`    | API           | `SCOPE_API_`            |
| `projects/moyin-web/`        | moyin-web     | `SCOPE_MOYINWEB_`       |
| `projects/moyin-game-v1/`    | moyin-game-v1 | `SCOPE_MOYINGAME_`      |
| `projects/tests/`            | QA            | `SCOPE_QA_`             |
```

---

## Use Cases

- **Scenario 1: Development workflow (run-dev)**
  Confirm the target sub-project to avoid modifying the wrong codebase.

- **Scenario 2: Test workflow (run-qa)**
  Confirm the test target to output test documentation and code to the correct directory.

- **Scenario 3: Code archiving (run-archive)**
  Automatically identify which SCOPE changes belong to, preventing mixed commits.

- **Scenario 4: Style spec check (style-guard)**
  Locate the corresponding theme.css and UI spec documents based on SCOPE.

---

## Related Resources

- [01_project_scope.md](../../../.agent/rules/01_project_scope.md) - Project scope definition
- [run-dev.md](../../../.agent/workflows/run-dev.md) - Development workflow example
- [run-qa.md](../../../.agent/workflows/run-qa.md) - Testing workflow example
- [run-archive.md](../../../.agent/workflows/run-archive.md) - Archive workflow example

---

## Precautions

- **SCOPE mapping table must stay in sync with `01_project_scope.md`**
  Any path changes must be synchronized across all related workflow and rule files.

- **Step 0 must be tagged with `// turbo`**
  Ensures the SCOPE confirmation step executes automatically for better user experience.

- **Relative paths are prohibited**
  All path references must explicitly state "lookup via SCOPE table."

- **Cross-SCOPE changes require ASK**
  Cross-SCOPE changes must never be auto-processed; the user must explicitly choose the handling approach.

---

_This document was auto-generated by `/run-wiki conversation`_
