# 30. 防衛流量海嘯：API 限流演算法大揭秘 (Rate Limiting)

> **類型**: 系統架構防禦與演算法科普
> **重點**: 破除「每分鐘只能戳 10 下」這種天真防禦思維的漏洞。深度探討 Stripe、AWS 與業界頂尖 Gateway (如 Kong) 防範惡意爬蟲與突發暴雪流量的終極武器：**令牌桶 (Token Bucket)** 與 **滑動時間窗 (Sliding Window)** 演算法。

---

## 前言：為何簡單的「計數器」不堪一擊？

初階開發者設計限流機制時，通常會實作 **「固定時間窗 (Fixed Window Counter)」** 演算法：

- 邏輯：在 Redis 裡面設一個 Key `user_123_minute_01`，最大值=10。
- 運作：每次請求就 +1，超過 10 就拒絕。下一分鐘 (`minute_02`) 計數器重置為 0。

❌ **死穴：臨界點雙倍擊穿 (Burst at Edge)**
駭客發現了這個機制的漏洞。他在 `00:00:59` 瞬間發送了 10 個請求 (剛好沒擋)，接著又在 `00:01:00` 瞬間再次發送 10 個請求。
對於伺服器而言，它在「短短一秒鐘」之內承受了 20 次攻擊！這已經超過了你原先預期的負載上限 10 次。你的防線就這樣被「鑽兩分鐘的空隙」給打穿了。

為了徹底解決突發流量與邊界漏洞，架構師們研發了以下神級演算法：

---

## 1. 允許突增火力的蓄水池：令牌桶 (Token Bucket)

這是全宇宙最知名、應用最廣（Amazon, Stripe 提供限流的底層就是它）的演算法。它的強項在於：**我平時限制你，但允許你偶爾生氣爆發一下。**

### 🪣 運作模型

想像系統給每位使用者發配一個「水桶 (Bucket)」。

1. **容量限制 (Capacity)**：水桶最多只能裝 100 枚金幣 (Token)。超過的會掉出桶外丟棄。
2. **固定配發源 (Refill Rate)**：系統會以「每秒 10 枚」的穩定速度，持續往水桶裡扔金幣。
3. **消耗代價**：每次使用者呼叫一次 API，就必須從桶子裡「拿走 1 枚金幣」。如果桶子空了拿不出來，請求就直接回傳 `429 Too Many Requests`。

### 🏎️ 完美的優勢：支援突發流量 (Burst-Friendly)

如果一個使用者平時很乖，5 秒鐘都沒動作，他的水桶累積了 50 枚金幣。
突然，他按下了一個會並行呼叫 API 50 次的重量級操作。因為桶子裡「一次有 50 枚金幣」，系統會瞬間放行這 50 個連線！這是固定時間窗做不到的滑順體驗。
等他耗盡金幣後，他又回歸到「每秒只能戳 10 次」的嚴格限制上。

_(註：與令牌桶相似的還有「漏桶 (Leaky Bucket)」，它能強制定量平滑流出，常用於保護電商資料庫不被壓垮)。_

---

## 2. 封殺臨界點的精密顯微鏡：滑動時間窗 (Sliding Window)

如果你經營的是金融交易系統，連 1 次「突發爆發」都不允許，你追求的是**毫無死角的極致平滑限制**，那請選用這套機制。

### 📜 Sliding Window Log (滑動時間窗日誌)

不再維護單純的數字，而是將每一次請求的「精準 Timestamp (時間戳)」記錄在 Redis 的 `Sorted Set` 內。
當新請求於 `00:01:30` 抵達時：

1. **清理門戶**：刪除陣列中一分鐘前 (比 `00:00:30` 早) 的所有舊時間戳。
2. **算人頭**：如果剩下的時間戳數量大於門檻，抱歉拒絕。反之則放行並補上 `00:01:30` 進入陣列。
   ❌ **缺點**：高併發下，記憶體會因為瘋狂紀錄每個路人的時間戳而原地爆炸 (Memory-Intensive)。

### 🧠 Sliding Window Counter (滑動時間窗計數器 - 終極改良版)

結合了固定窗的「省記憶體」與滑動日誌的「無死角」。
當下一個請求在 `00:01:30` 抵達，系統會：

1. 找出「上一分鐘 (00:00)」的總量 (假如是 5 次)。
2. 找出「這一分鐘目前為止 (00:01)」的總量 (假如是 3 次)。
3. 利用**加權比率**推算過去 60 秒的真實流量：
   `上一分鐘總量 * (100% - 當前已經過的秒數比例 50%) + 當前分鐘總量` = `5 * 0.5 + 3 = 5.5 次`。
   用單純的國中數學，完美抹平了邊界突波，且記憶體開銷趨近於零！

---

## 💡 Vibecoding 工地監工發包訣竅

在使用 AI Agent 架設任何開放入流的 Public API 節點時，務必強制設定限流武器：

> 🗣️ `「你在 Express.js 設定外部 API 的 Rate Limiter 中介軟體時，嚴禁使用單純的 Redis INCR 來實作【固定時間窗】，這會導致我們遭逢邊界突波攻擊而 OOM 宕機。請引入支援【Token Bucket (令牌桶)】演算法之限流套件，並設定 Bucket Capacity 為 50，以包容少部分的前端併發請求突波！」`
