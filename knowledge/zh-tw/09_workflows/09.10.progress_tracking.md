# 大任務進度追蹤機制

> **類型**: 工作流程 / 工具技巧  
> **日期**: 2026-01-11  
> **來源**: 對話 - 任務管理系統建立

---

## 摘要

針對高 Token 消耗或涵蓋跨多個檔案之型任務，實作自動化規模評估、分批執行策略與即時進度追蹤，以防範 Token 超限與任務失控之風險。

---

## 背景

### 歷史痛點

在執行巨型任務時，常遭遇以下瓶頸：

1. **Token 溢出 (Token Max Out)**: 單次執行需涵蓋過多檔案，超出單次上下文之 Token 上限。
2. **進度盲區**: 無法即時觀測任務推進至何種階段。
3. **容錯率低**: 任務中途若發生崩潰，往往需全盤撤銷重來。
4. **耗時難估**: 欠缺量化指標以評估距離任務竣工所需之時間。

### 需求

使用者明確提出需求：

> "執行全域任務時，若系統預估將消耗巨量 Token，必須主動啟動分批機制，並定時於獨立之 Markdown 檔案中更新進度軌跡。"

---

## 詳細內容

### 自動化規模評估 (Automated Scale Assessment)

於任務啟動前，AI 必須強制執行規模前測：

```typescript
interface TaskEstimate {
  type: "small" | "medium" | "large";
  estimatedFiles: number;
  estimatedTokens: number;
  suggestedBatches: number;
}
```

**評量標準**:

- **Small**: ≤ 5 個檔案，預估耗用 < 20k Token → 單次直通執行 (Single-pass)。
- **Medium**: 6-15 個檔案，預估耗用 20k-50k Token → 可選分批執行 (Optional Batching)。
- **Large**: > 15 個檔案，預估耗用 > 50k Token → **強制/強烈建議分批執行 (Mandatory Batching)**。

**評估報告輸出範例**:

```
📊 任務規模評估報告

任務類型: 功能模組重構
預期干涉: 20 個實體檔案
預估 Token 消耗: ~80k
建議執行策略: 分批推進 (Batch Processing)

⚠️ 偵測到大型任務特徵，建議切割為 4 個獨立批次執行。
請問是否立即啟用「進度追蹤器」? (y/n)
```

---

### 進度軌跡檔架構 (Progress Tracker Structure)

**檔案儲存路徑**: `workspace/progress/{TASK_ID}_1.progress.md`

**公版模板**:

```markdown
# {任務名稱} - 執行進度軌跡

## 總體狀態概覽

- 當前狀態: 🚧 執行中 (In Progress)
- 推進進度: 25% (已完成 1/4 批次)
- 啟動時戳: 2026-01-11 02:00
- 預估落幕: 2026-01-11 04:30

## 批次明細追蹤

### ✅ Batch 1/4 - 核心基礎模組 (已結案)

- 干涉檔案: Button.vue, Input.vue, Select.vue
- Token 消耗: ~18k
- 實際耗時: 15 分鐘
- 更新狀態: 已完成 (Completed)

### 🚧 Batch 2/4 - 版面佈局元件 (推進中)

- 干涉檔案: Layout.vue, Grid.vue, Flex.vue
- Token 消耗: ~20k
- 更新狀態: 執行中 (已完成 2/3 檔案)

### ⏳ Batch 3/4 - 表單互動元件 (駐列中)

- 干涉檔案: Form.vue, FormItem.vue, Checkbox.vue
- Token 消耗: ~22k
- 更新狀態: 待命啟動 (Pending)

### ⏳ Batch 4/4 - 文件與知識庫對齊 (駐列中)

- 干涉檔案: README.md, CHANGELOG.md, docs/
- Token 消耗: ~20k
- 更新狀態: 待命啟動 (Pending)
```

---

### 分批切割策略 (Batching Strategy)

#### 指導原則

1. **模組化內聚**: 具備強關聯性與相依性之檔案必須歸斂於同一批次。
2. **負載平衡**: 每批次之 Token 消耗量應盡可能貼近均值，避免單批過載。
3. **相依性排序**: 嚴格遵守「核心底層 → 依賴模組 → 邊緣應用」之實作順序。
4. **文檔延置**: 源碼邏輯全面落實後，方可於最終批次連動更新說明與規格圖文。

#### 批次規劃模擬

**目標任務**: UI 系統全面重構 (總計 20 個檔案，估算 ~80k tokens)

```
Batch 1 (基礎核心層):
  - 目標: Button.vue, Input.vue, Select.vue
  - 負載: ~18k
  - 策略理由: 系統最底層元件，上層元件之絕對依賴。

Batch 2 (板塊佈局層):
  - 目標: Layout.vue, Grid.vue, Flex.vue
  - 負載: ~20k
  - 策略理由: 繼承核心元件之應用層。

Batch 3 (表單互動層):
  - 目標: Form.vue, FormItem.vue, Checkbox.vue, Radio.vue
  - 負載: ~22k
  - 策略理由: 最複雜之前端互動層，且依附於前兩階層之基底。

Batch 4 (文檔對齊層):
  - 目標: README.md, CHANGELOG.md, docs/components/
  - 負載: ~20k
  - 策略理由: 代碼塵埃落定後之知識庫翻新同步。
```

---

### 即時反饋更新機制

每個批次收尾時，系統必須自動觸發進度檔之寫入更新：

1. **狀態燈號轉換**: ⏳ (待命) → 🚧 (執行) → ✅ (完結)。
2. **百分比重算**: 依據已竣工批次精確計算整體百分比。
3. **時間稽核**: 如實記錄每批次之物理耗時。
4. **時間收斂預測**: 經由已完成批次之平均速率，動態校準後續之預估完成時戳。

### 任務結案程序

所有批次宣佈竣工後：

1. 刷新進度檔總狀態為「✅ 已決 (Resolved/Completed)」。
2. 將該進度檔封版並搬移至專屬 ISSUE 歸檔夾或所屬之 Scope 知識庫內。
3. 確保主任務之 `README.md` 引用並超連結至此進度軌跡檔，以備未來溯源。

---

## 工作流 (Workflows) 整合切入點

### 入口：`/inbox`

```
使用者下達 /inbox 指令 → 觸發規模評估 → 若判定為 Large 等級 → 強制彈出詢問是否啟用分批進度追蹤
```

### 入口：`/bg` (Bug 深度探測 Deep Dive)

```
使用者下達 /bg 指令 → 選定 Deep Dive 模式 → 系統判定需波及大範圍檔案 → 彈出啟動進度追蹤詢問
```

### 入口：`/dev` (核心開發)

```
使用者下達 /dev 指令 → 選定 Feature/Refactor 推進 → 觸發規模評估 → 判定為 Large → 自動啟用進度追蹤防護網
```

---

## 實際操作範例

### 範例 1: 跨模組 UI 系統重構

**觸發輸入**:

```
@inbox

指令標的：請徹底重構全套 UI 組件庫系統，全面汰換為並銜接最新的 Design Token，請開始。
```

**系統反饋與推進**:

1. 評估判定: Large (涉及 20 個檔案，預估 ~80k tokens)。
2. 系統建議方案: 切割為 4 批次執行矩陣。
3. 使用者授權: 輸入 `y`。
4. 生成追蹤基底: 建立 `workspace/progress/ISSUE-042_1.progress.md`。
5. 啟動 Batch 1 (基礎核心層) 代碼改寫。
6. 階段性回報更新: 25% → 50% → 75% → 100%。
7. 結案封裝: 歸檔進度紀錄檔至所屬 ISSUE 目錄。

### 範例 2: Bug 深度溯源與大範圍修復

**觸發輸入**:

```
@bg

觀測現象: 讀檔後遊戲進度狀態機無法一致化復原。
策略選擇: 模式 3 (Deep Dive 深度溯源)
```

**系統反饋與推進**:

1. 鋪設證據鏈並剖析根因。
2. 判讀出約 10 個核心模組涉入 Bug 牽連。
3. 評估判定: Medium-Large (~55k tokens)。
4. 系統建議: 詢問是否掛載進度追蹤器，使用者輸入 `y`。
5. 規劃為 3 批次防護修復網。
6. 啟動編碼修復並即時回滾更新進度檔。

---

## 最佳適配場景

- ✅ 大型底層重構作業 (> 15 個實體檔案)。
- ✅ 具備高度蔓延性之系統級 Bug 修復。
- ✅ 大規模邏輯模組或框架遷移 (Migration)。
- ✅ 批次知識庫或 API 文件之巨量翻新。
- ✅ 任何系統預估將逼近或超越 50k tokens 閾值之史詩級 (Epic) 任務。

---

## 核心防護優勢

1. **風險限縮 (Controllability)**: 透過分批推進，規避 Token 爆量引發之系統性失憶與崩潰。
2. **狀態透通 (Visibility)**: 賦予使用者即時的全域上帝視角，抹除「黑箱作業」之不安全感。
3. **災損管控 (Recoverability)**: 若於特定批次發生中斷或邏輯崩潰，僅需重置該批次，無需株連先前已完成之進度。
4. **時程收斂 (Predictability)**: 動態預估收工時程，提供專案管理者準確之時間感。
5. **歷史鑑識 (Traceability)**: 日誌軌跡檔可作為日後優化效能或排錯查驗之重要依據。

---

## 實務注意事項

- ⚠️ **單次負載限制**: 務必確保單一批次之 Token 負載死守於 30k 安全線內。
- ⚠️ **依賴性不可逆**: 嚴防先處理應用層再處理基底層的倒置錯誤。
- ⚠️ **寫入時效**: 每批次結束之斷點，必須立即將狀態 Commit 至檔案系統。
- ⚠️ **封裝紀律**: 任務不得停留在 `workspace/progress/` 中腐敗，結束後必定要執行歸檔搬移。
- ⚠️ **打擾最小化**: 僅於觸發 Large 門檻時方才啟用，以免增添繁瑣之系統介面對話。

---

## 關聯資源指引

- [收件匣工作流規章](../09_workflows/inbox_workflow.md)
- [Bug 深度探測操作守則](../09_workflows/bug_investigation.md)
- [核心開發工作流標準](../09_workflows/dev_workflow.md)
- [任務統籌管理指南](09.6.issue_management_system.md)

---

_本文檔由模組化維護系統自動生成於 2026-01-11_
