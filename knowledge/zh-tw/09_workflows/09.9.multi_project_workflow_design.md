# 多專案 Workflow 規則設計模式

> **類型**: 工作流程  
> **日期**: 2026-01-03  
> **來源**: 對話 ID (2026-01-03 會話)

---

## 摘要

設計支援多子專案的 Agent 規則與工作流，透過 SCOPE 路徑映射、自動識別和錯誤處理機制，確保 AI 能準確定位工作目錄並避免跨專案誤操作。

---

## 背景

在多專案 monorepo 架構中，AI Agent 需要處理不同子專案的開發任務。若缺少明確的 SCOPE 映射機制，會導致：

1. AI 無法確定當前工作目錄
2. 相對路徑引用模糊不清
3. 跨專案誤操作（如混提交）
4. 文檔與代碼路徑不一致

---

## 詳細內容

### 核心設計原則

#### 1. SCOPE 路徑映射表

在每個 workflow 和 rule 文件中，明確定義 SCOPE 與路徑的映射關係：

```markdown
## SCOPE 路徑映射

| 子項目            | 代碼根                              | 文檔根                           | Review 輸出                             |
| ----------------- | ----------------------------------- | -------------------------------- | --------------------------------------- |
| **API**           | `projects/moyin-gateway/web2api`           | `projects/moyin-gateway/docs`           | `projects/moyin-gateway/docs/review`           |
| **moyin-web**     | `projects/moyin-web`             | `projects/moyin-web/docs`     | `projects/moyin-web/docs/review`     |
| **moyin-game-v1** | `projects/moyin-game-v1/website` | `projects/moyin-game-v1/docs` | `projects/moyin-game-v1/docs/review` |
| **QA 工程**       | `projects/tests`                 | `projects/tests/docs`         | `projects/tests/docs/review`         |
```

#### 2. Step 0: 確認當前 SCOPE

每個 workflow 的第一步必須確認當前 SCOPE：

```markdown
### Step 0: 確認當前 SCOPE

// turbo
檢查用戶請求中是否明確指定了子項目。

**若未明確指定**：

- 使用 `ASK:` 詢問用戶選擇子項目
- 列出所有可用選項

**若已明確**：

- 確認 SCOPE 並列出對應路徑
```

#### 3. 路徑引用規範

禁止使用相對路徑，改為「依據 SCOPE 查表」：

❌ **錯誤示範**：

```markdown
輸出到 `docs/review/` 目錄
```

✅ **正確示範**：

```markdown
輸出到 `[當前 SCOPE]/docs/review/` 目錄（參見 SCOPE 路徑映射表）
```

#### 4. 跨 SCOPE 檢測與處理

在涉及文件操作的 workflow 中，必須檢測跨 SCOPE 變更：

```markdown
**若存在跨 SCOPE 變更**：

- 列出各 SCOPE 的變更文件清單
- 使用 `ASK:` 詢問用戶是否分開處理
- 建議：按 SCOPE 分別執行本工作流
```

---

## 代碼/命令範例

### 範例 1：run-dev.md 的 SCOPE 確認

```markdown
### Step 0: 確認當前 SCOPE

// turbo
檢查用戶請求中是否明確指定了子項目（API / moyin-web / moyin-game-v1 / QA）。

**若未明確指定**：

- 使用 `ASK:` 詢問用戶：「本次開發工作針對哪個子項目？」
- 列出四個選項：API、moyin-web、moyin-game-v1、QA 工程

**若已明確**：

- 在回覆中確認：「當前 SCOPE: [子項目名稱]」
- 列出對應的代碼根、文檔根、Review 輸出路徑

**輸出**：當前 SCOPE 及對應路徑。
```

### 範例 2：run-archive.md 的 SCOPE 自動識別

```markdown
## SCOPE 路徑映射

依據變更文件路徑自動識別 SCOPE：

| 路徑前綴                     | SCOPE         | 歸檔目錄前綴       |
| ---------------------------- | ------------- | ------------------ |
| `projects/moyin-gateway/`           | API           | `SCOPE_API_`       |
| `projects/moyin-web/`     | moyin-web     | `SCOPE_MOYINWEB_`  |
| `projects/moyin-game-v1/` | moyin-game-v1 | `SCOPE_MOYINGAME_` |
| `projects/tests/`         | QA            | `SCOPE_QA_`        |
```

---

## 適用場景

- **場景 1：開發工作流（run-dev）**  
  需要確認當前工作的子項目，避免修改錯誤的代碼庫。

- **場景 2：測試工作流（run-qa）**  
  需要確認測試目標，將測試文檔和代碼輸出到正確的目錄。

- **場景 3：代碼歸檔（run-archive）**  
  需要自動識別變更屬於哪個 SCOPE，避免混提交。

- **場景 4：樣式規格檢查（style-guard）**  
  需要根據 SCOPE 找到對應的 theme.css 和 UI 規格文檔。

---

## 相關資源

- [01_project_scope.md](../../../.agent/rules/01_project_scope.md) - 專案範圍定義
- [run-dev.md](../../../.agent/workflows/run-dev.md) - 開發工作流範例
- [run-qa.md](../../../.agent/workflows/run-qa.md) - 測試工作流範例
- [run-archive.md](../../../.agent/workflows/run-archive.md) - 歸檔工作流範例

---

## 注意事項

- ⚠️ **SCOPE 映射表必須與 `01_project_scope.md` 保持一致**  
  任何路徑變更都需要同步更新所有相關 workflow 和 rule 文件。

- ⚠️ **Step 0 必須標記為 `// turbo`**  
  確保 SCOPE 確認步驟能自動執行，提升用戶體驗。

- ⚠️ **禁止使用相對路徑**  
  所有路徑引用都必須明確指出「依據 SCOPE 查表」。

- ⚠️ **跨 SCOPE 變更必須 ASK**  
  不得自動處理跨 SCOPE 的變更，必須讓用戶明確選擇處理方式。

---

_本文檔由 `/run-wiki conversation` 自動生成_
