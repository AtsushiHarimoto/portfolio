# 16. Docker 與伺服器容器化技術 (Docker & Containerization)

> **類型**: 系統環境與佈署架構科普  
> **重點**: 闡述容器化技術如何解決「在本機端運行正常，但伺服器崩潰」之歷史痛點，並解析 Docker 之核心元件與 Compose 編排邏輯。

---

## 前言：消弭開發與維運的環境斷層

在傳統的協作開發中，最令人絕望的推諉之詞莫過於：**「可是程式碼在我的電腦上明明能正常運作呀！」(It works on my machine!)**

引發此現象之根源，在於開發環境結構的破碎與不一致：A 工程師使用 macOS 且配置 Python 3.10 與特定環境變數；B 工程師使用 Windows，Python 升級至 3.12 且遺漏了特定底層 C++ 編譯套件。當源碼移轉部署時，應用程式必然瞬間崩潰。

**Docker 容器化技術** 的問世，正是為了將應用程式連同其「生存環境」進行一比一的絕對封裝，徹底終結此一維運惡夢。

---

## 1. 容器 (Container) 與虛擬機 (Virtual Machine, VM) 之二元對立

為追求環境的絕對隔離，業界曾長期依賴**虛擬機器 (VM)** (如 VMWare 或 VirtualBox)：

- **虛擬機 (VM) 架構**：開發者於實體硬碟中切割出龐大的區塊，**從零開始完整安裝一套獨立的 Guest OS (如 Windows 或 Ubuntu)**。此法雖提供了極高規格的隔離，但極度肥大笨重。啟動單一 VM 往往需耗費數 GB 記憶體與數分鐘之開機程序。

- **Docker 容器架構**：
  容器揚棄了安裝完整作業系統的沉重作法。它猶如一個**「極度輕量化的隔離保鮮盒」**，僅將您的源碼及必須的依賴函式庫 (如 Node.js 執行檔) 打包入內。
  該保鮮盒直接與宿主機 (Host OS) **共享底層之作業系統核心 (Kernel)**。因此，容器之發布單位於幾十 MB 內，啟動耗時僅需毫秒級別，一台常規開發機便能輕易並行數十乃至上百個容器叢集。

---

## 2. Docker 三大核心運作邏輯

### ① Dockerfile：封裝食譜

開發者如何指示 Docker 進行環境封裝？係透過編寫一份名為 `Dockerfile` 之宣告式文字檔：

```dockerfile
# 基準映像：自雲端拉取包含 Node.js v20 之純淨底層環境
FROM node:20
# 宣告該容器內之工作目錄路徑
WORKDIR /app
# 將宿主機內當前目錄的所有源碼拷貝入容器 /app 目錄內
COPY . .
# 觸發依賴解析與安裝
RUN npm install
# 宣告當容器實體化並啟動時，預設執行之後台指令
CMD ["npm", "start"]
```

### ② 映像檔 (Image)：靜態的唯讀模具

Docker 依據 `Dockerfile` 編譯出之產物稱為「映像檔」。它有如光碟機中的安裝光碟或鑄造模具，將底層環境與程式碼凝固鎖死。映像檔具備防篡改之唯讀特性，確保無論將該檔案移轉至全球何處之伺服器，其環境變數皆具備 100% 的決定性 (Deterministic)。

### ③ 容器 (Container)：動態的生命週期實體

當系統載入「映像檔」並投入資源運行時，該執行緒便被稱作「容器」。映像檔是靜態圖紙，容器則是活體建築。利用同一份映像檔，系統可橫向擴展 (Scale out) 生成出五個平行的容器實體，用以承載極端高併發之網路流量。

---

## 3. 叢集指揮交響樂：Docker Compose

隨系統擴張，單純的微服務架構 (如 Moyin 之中樞 Gateway、前端 Web、MongoDB 與 Redis 快取層) 將涉及繁複的多容器啟動順序與內部網路交握綁定。若仰賴人工逐一輸入指令啟動，不僅極易出錯且效率低落。

**Docker Compose** 應運而生：

- 開發者撰寫單份 `docker-compose.yml` 宣告檔，將系統內所有牽涉之容器、依賴先後順序及內部虛擬網路 (Bridge Network) 定義清晰。
- 僅需於終端機執行一鍵指令：
  ```bash
  docker-compose up -d
  ```
- **效益**：編排引擎將自動接管，依序啟動數十個微服務並完成內部端口映射。此為現代系統部署中，落實「基礎設施即代碼 (Infrastructure as Code, IaC)」之第一步。

---

## ✅ Vibecoding 開發部署指令驗收

未來在驅使 AI 建立新的微服務子專案時，若欲確保成品具備高階部署規範，請明確下達下列約定：

- [ ] 🗣️ **「請為此模組配套撰寫 `Dockerfile` 與 `docker-compose.yml`，確保該服務能在容器內一鍵隔離運行，並預留供 Host 機存取之 Mapping Port。」**
- [ ] 🤖 `我明瞭 Docker 容器相較於 VM，具備共用系統核心之極低耗能優勢。`
- [ ] 🤖 `我理解映像檔 (Image) 為跨平台部署不致引發套件衝突的防護底座。`
