# 08. ソフトウェア設計とパターンガイド (Software Design & Patterns Field Guide)

> **種類**: アーキテクチャの知見と開発哲学  (Architectural craft and development philosophy)  
> **重点**: ただ走ればよいという考えを払拭し、SOLID 原則やデザインパターンを AI に結び付けて、保守性の高い企業向けアウトプットを引き出す方法を示します。

---

## 序章: Vibecoding 時代における設計パターン
AI コパイロットや Claude エージェントが一瞬でアプリを組み立てても、GoF のパターンカタログが古びたわけではありません。Vibecoding や意図優先のプロンプトは UI、ビジネスロジック、データアクセスの境界をきっちり保つことを要求します。境界を緩くすると、AI はすべてを千行ファイルに押し込んでしまい、スパゲッティコードを生成してリファクタも AI も幻覚に陥ります。

デザインパターンは廃れておらず、むしろ AI に対する軍規レベルのプロンプト制約として生まれ変わっています。

---

## 1. コアを支える SOLID 物体指向原則 (SOLID Principles)
AI にアーキテクチャを構築させる際、SOLID 原則がモジュールの責務線を引きます。実務で最も引用される二つのルールを示します。

| 原則 | 建築比喩 | Moyin での応用 |
| :--- | :------- | :------------- |
| **単一責任の原則 (Single Responsibility Principle)** | 絶対的な職能分離。クラスやモジュールには変更理由が一つだけあるべきです。 | **API 呼び出しとデータ永続化は分離**：OpenAI API を叩くコードに MongoDB への書き込みを混ぜない。分割すればデータベースのバグを修正しても API 層をいじる必要がありません。 |
| **開放閉鎖の原則 (Open/Closed Principle)** | コアを解剖せずに外部から拡張する。システムは拡張に対して開かれ、修正には閉じていなければなりません。 | **インターフェース契約**：Claude を導入するときは、コア推論エンジンに `if/else` を追加せずに新しい `ClaudeAdapter` クラスを作り、プラグインとして差し込みます。 |

---

## 2. AI を司る三つのパターン
デザインパターンは文法ではなく、プロンプトに使える専門用語です。パターン名を伝えるだけで AI は適切な構造を組んでくれます。

| パターン | シナリオと課題 | Vibecoding プロンプト |
| :------ | :------------- | :-------------------- |
| **ファクトリーパターン (Factory Pattern)** | クライアントが内部構築を知らずにインスタンスを取得したい。 | 🗣️ 「AI 助手よ、LLM プロバイダの工場を実装して。`gpt4` でも `qwen` でも正しい認証トークンを含む接続インスタンスを返して。」 |
| **戦略パターン (Strategy Pattern)** | 複数のアルゴリズムを用意し、実行時に交換する。 | 🗣️「このログイン処理を戦略パターンでリファクタしてください。チェックアウト時に `Google 戦略` と `Apple 戦略` を切り替えられるが、コアは一切変更しないこと。」 |
| **シングルトンパターン (Singleton Pattern)** | リソースを一つだけ保つことで接続枯渇を防ぐ。 | 🗣️「Redis 接続プールはシングルトンであるべきです。ユーザが連打しても数万の接続を作らないようにして。」 |

> 💡 どのシナリオでどのパターンを使うかを暗記する必要はありません。名前を Claude に渡せば、高水準な構造を自動で編んでくれます。

---

## 3. AI ネイティブパターン (AI Native Patterns)
LLM が大量に入り込むと、非決定性を扱うための新しいパターンが必要になります。

| パターン | アーキテクチャ比喩 | Moyin での具体例 |
| :------ | :----------- | :--------------- |
| **エージェント・オーケストレーターパターン (Agent-Orchestrator Pattern)** | プロジェクトマネージャと外部チーム。 | GPT-4 などがタスクを分解し、安価で高速な Worker Agent に死板な仕事を割り振る。Moyin では「環境描写エージェント」「対話生成エージェント」に分担させる。 |
| **RAG パターン (RAG Pattern)** | オープンブック試験。 | 回答前にベクトルDBやファイルから公式資料を引き出して使う。ボタンカラーを説明するときは `06_BRAND_DESIGN` から素材を注入。 |
| **コパイロットパターン (Copilot Pattern)** | AI が提案、人間が承認。 | 自動で悪質投稿の理由をハイライトするが、実行はオペレータが `Approve` を押すまで待機する。 |

---

## ✅ Vibecoder アーキテクトの受け入れチェックリスト
大規模リファクタやマイクロサービス委託時には、以下のような曖昧な発注を避けてください。

- [ ] ❌ `「どんな支払い方法でも処理できる API Gateway を作って。クレカも LinePay も同じファイルにぶち込めばあとは動けばよい。」`  
- [x] ✅ `「API Gateway コンポーネントを構築してください。ルーティングと認証は単一責任の原則に従って分割し、決済処理は戦略パターンを使って ApplePay を追加してもクレジットカードコアに手を入れない構造にしてください。」`  

このような語彙で話せれば、AI はあなたを熟練の航海者と認識し、産業級の設計図を引き渡してくれます。
