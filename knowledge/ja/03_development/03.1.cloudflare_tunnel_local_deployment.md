# 03.1. Cloudflare Tunnel による一時パブリック公開

> **種類**: ツール技術・デプロイ実務  
> **重点**: Cloudflare Tunnel を使ってローカル開発サーバーを安全かつ迅速にインターネットへ露出させ、Webhook やリモートデモ用に使う手順を解説します。

---

## 概要

開発時に `localhost` を外部に開きたい場面は頻出ですが、ポートフォワードや VPN は面倒でセキュリティリスクを伴います。Cloudflare Tunnel は Firewall を開けずに HTTPS トンネル URL を払い出し、公衆 IP なしで安全な一時公開環境を提供します。

---

## 第1章：インストールと即席トンネル

### 1.1 cloudflared を準備

**macOS (Homebrew)**:

```bash
brew install cloudflared
```

**その他 OS**：公式ガイドから対応バイナリを入手してください。  
https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/

### 1.2 クイックトンネルを立てる

アカウント不要で、露出したいポートを指定するだけです：

```bash
cloudflared tunnel --url http://localhost:5173
```

```text
2026-01-06T02:30:00Z INF +----------------------------+
2026-01-06T02:30:00Z INF | Your quick Tunnel ...      |
2026-01-06T02:30:00Z INF | https://random-subdomain-1234.trycloudflare.com |
2026-01-06T02:30:00Z INF +----------------------------+
```

この `*.trycloudflare.com` を外部ユーザーに渡します。

---

## 第2章：ホストポリシーの調整

多くの現代フレームワークは CORS やホスト制限を持つため、トンネル用に緩める必要があります。

### 2.1 Vite（例：Moyin game）

`vite.config.js` を更新：

**選択肢 A（開発向け）**:

```javascript
export default defineConfig({
  server: {
    host: '0.0.0.0',
    allowedHosts: true,
  },
});
```

**選択肢 B（厳格）**:

```javascript
export default defineConfig({
  server: {
    host: '0.0.0.0',
    allowedHosts: ['.trycloudflare.com'],
  },
});
```

### 2.2 Vue CLI / Webpack Dev Server

`vue.config.js` または `webpack.config.js` に：

```javascript
module.exports = {
  devServer: {
    allowedHosts: 'all',
  },
};
```

### 2.3 FastAPI / Moyin gateway

`uvicorn` を `0.0.0.0` バインドすればトンネル側からアクセス可能です。

```bash
uvicorn main:app --host 0.0.0.0 --port 8001
```

本番では `TrustedHostMiddleware` を追加し制限する：

```python
from fastapi.middleware.trustedhost import TrustedHostMiddleware

app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=['localhost', '127.0.0.1', '*.trycloudflare.com'],
)
```

---

## 第3章：実用ワークフロー例

API とフロントを両方トンネルで公開すると、リモート体験がシームレスになります。

**ステップ1：API をトンネル**:

```bash
# ターミナル1：API 起動
cd projects/moyin-gateway/web2api
python main.py

# ターミナル2：トンネル
cloudflared tunnel --url http://localhost:8001
# 例：https://api-xyz.trycloudflare.com
```

**ステップ2：フロントをトンネル**:

```bash
# ターミナル3：Vite 起動
cd projects/moyin-game-v1/website
npm run dev

# ターミナル4：トンネル
cloudflared tunnel --url http://localhost:5173
# 例：https://frontend-abc.trycloudflare.com
```

**ステップ3：環境変数を交換**:

```env
VITE_API_BASE_URL=https://api-xyz.trycloudflare.com
```

---

## 第4章：適用ケースと警戒

### ✅ 推奨用途

- Webhook テスト（Stripe、Line）  
- 複数デバイスでの UI チェック  
- 遠隔デザイナーへのプロトタイプ共有

### ❌ 禁止用途

- セキュアな管理画面を無認証で公開  
- レート制限なしに運用環境として放置

### 進化系：名前付きトンネル

毎回 URL が変わるので、固定のサブドメインが必要なら、Cloudflare アカウントで作成します：

```bash
cloudflared tunnel login
cloudflared tunnel create moyin-dev
cloudflared tunnel route dns moyin-dev dev.moyin.example.com
cloudflared tunnel run moyin-dev
```
