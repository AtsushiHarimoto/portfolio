# 07.6. プロンプトエンジニアリング (Prompt Engineering)：AI を支配するコア法則

> **種類**: 開発ガイドラインと AI 行動制御
> **重点**: プログラムロジック内で精密なシステムプロンプト (System Prompt) を構築し、大規模言語モデルに安定的で構造化された、自己修正能力を持つデータフローの出力を強制する方法を解説します。

---

## 前言：即興劇の俳優としての AI

Moyin のエンジンアーキテクチャにおいて、大規模言語モデル (LLM) はソウルドライビングの中核コンポーネントの役割を果たしています。しかしその本質は、制約のない「即興劇の俳優」に極めて似ています。厳格な脚本規範と演出指示がなければ、その出力は急速に発散し、システムが意図する軌道から逸脱してしまいます。

本ガイドは、精巧に作り込まれた「プロンプト (Prompt)」を通じて、LLM に対する絶対的なエンジニアリング制御と行動収束を実現する方法を伝授します。

---

## 1. デュアルトラックプロンプティング (Dual-Track Prompting) アーキテクチャ

API の通信プロトコルにおいて、2 つの次元のメッセージ階層を明確に定義しています：

### System Prompt (グローバルシステム指示)

- **位置づけ**：「ディレクターの見えないメガホン」。この階層は極めて高いウェイトを持ち、システムバックエンド専用であり、エンドユーザーの干渉を受けません。
- **責務**：
  1. グローバルなワールドビューと NPC のパーソナリティ属性をアンカリングします（例：「あなたの名前はリン・ワン。クールで洞察力に富んでいます...」）。
  2. **エンジニアリング境界制約**：返却フォーマットを強制し、システム解析の崩壊を防止します。

### User Prompt (環境およびプレイヤー入力)

- **位置づけ**：「ステージ上で発生するリアルタイムの台詞とシーン変更」。
- **責務**：急速に変化するインタラクティブ状態を伝達します。例：「【プレイヤー】傘を差し出すことを選択」、または環境パラメータのカプセル化：「【システムイベント】夕方、鐘が鳴る」。

---

## 2. 出力の構造化制御：安定した API スループットの確保 (JSON フォーマットの強制)

大規模言語モデルは生まれつき冗長な前置きへの衝動を持っています。プログラムバックエンドにとって、余計な冒頭の一言（例：「はい、以下がストーリーです：」）でさえ、致命的な `JSON Parse Error` 例外を引き起こします。

### A. 具体的テンプレートマッピング (One-Shot Example)

- **戦術**：口頭での制約だけに頼らないでください。System Prompt の末尾に完璧な JSON 出力例を直接刻み込みます。
- **テンプレート表現**：「以下の構造に準拠した JSON 文字列のみを厳密に出力してください。Markdown タグ、前後の余談、思考プロセスを含めることは**絶対に禁止**です：」

### B. 内在的思考フロー (Hidden Chain of Thought)

AI が深い因果推論（例：プレイヤーの行動が好感度の減少に値するかどうかの判定）を行いつつも、最終出力の純度を汚染しないようにするために：

- **解法**：深い思考メカニズムを持つモデル（例：Grok-thinking または DeepSeek-R1）を有効にしますが、バックエンドのレスポンスインターセプター (Response Interceptor) で正規表現を使用してすべての `<thought>...</thought>` ブロックを強制的に除去し、最終的な JSON ペイロードのみをルーティングに渡します。

### C. 堅牢性と自己修復メカニズム (Robustness & Self-Healing)

モデルには依然として閉じ括弧 `}` の欠落やフィールドの脱落が発生する可能性があります。

- **アーキテクチャ防衛線**：サーバー側に `try-catch` リプレイメカニズムをデプロイします。解析例外をキャッチした場合、ゲートウェイはレスポンスを直接破棄せず、エラー文字列（スタックトレースを含む）を User Prompt にパッケージして AI に再送信します：「あなたの前回の応答は第 4 行で JSON 構造の破損と判定されました。直ちに修復し再送信してください」。実測では、大半の上位モデルがリトライ時に完璧に自己修復します。

---

## 3. よくあるフォーマット崩壊の地雷への対策

プログラミング言語との連携時に、以下のシンボル汚染に特に注意してください：

- **Markdown 文字汚染の禁止**: 一部のモデルは \`\`\`json で文字列を前後に囲む強い習慣を持っています。プロンプト内でこの行為を繰り返し禁止するか、中間層で `string.replace` によるサニタイズ (Sanitize) を強制する必要があります。
- **ダブルクォート地獄 (Double-Quote Hell)**: JSON のキーと値は英語のダブルクォート `"` で囲まれるため、ストーリーの対話でも英語のダブルクォートを使用すると、構文ツリーの切断が直接発生します。
  - **強制対策**：System Prompt に以下を固定記述します：「ナレーションと対話フィールドでは、台詞の区切りに CJK 括弧 `「` と `」` のみを使用してください。英語のクォーテーションの混用は厳禁です。」

---

## 4. サンドボックステストツール (Vibe Tester) の活用

サンドボックスリハーサルなしにソースコードを修正してサーバーを再起動することは絶対に避けてください。Moyin バックエンドには専用の**フロントエンドサンドボックステストインターフェース (Tester)** が装備されています。以下のテストループに従ってください：

1. 開発テストエンドポイント（デフォルトパスは通常 `http://localhost:5173` のサブページ）を開きます。
2. ドロップダウンメニューで検証したい特定のモデル推論プロバイダー (Provider API) に切り替えます。
3. 作成した System Prompt をコンソールパネルに配置し、さまざまな悪意あるプレイヤー入力をシミュレートします。
4. 送信後、`Response RAW Data` のフォーマット純度を直接確認します。

5 ラウンド以上連続で描画崩壊や例外オーバーフローが発生しない場合にのみ、そのプロンプトをパイプラインにコミットする資格があります。
