# 06.1. Moyin 自動化 E2E テスト実践とインフラストラクチャガイド (Automation Basics)

> **種類**: 品質保証 (QA) と自動化テストエンジニアリング  
> **重点**: 従来の手作業によるクリック操作を「自動化ロボット (Playwright)」を雇用することで置き換え、リファクタリングのたびに発生するリグレッションバグ (Regression Bugs / 退行バグ) を徹底的に封殺する方法を解説します。また、ゲームのレンダリングアニメーションがもたらすタイミング検証のボトルネックを突破する、Moyin プロジェクト特有のホワイトボックス動的テストの解決策についても記録します。

---

## 序：自動化 E2E テストとは何か？

高速でイテレーションを繰り返し、高度に複雑化したフロントエンドアプリケーション（特に状態ツリーが山のように積み重なるビジュアルノベルエンジンのコア）において、人間のエンジニアがブラウザ上で手作業で一つ一つクリックして検証することに依存するのは、極めて効率が悪いだけでなく、必ず多くの見落としによる死角を生み出します。
私たちに必要なのは、決して疲れることのない、国防レベルの火力封鎖線です——これこそが、**自動化エンドツーエンドテスト (End-to-End Testing)** が存在する意義なのです。

### 🤖 ターミナル内の幽霊軍団：Playwright

Moyin プロジェクトは、有名な Web テストフレームワークである **Playwright** に委任しました。これは、無給で 24 時間休むことのないフルタイムのロボットテスターを雇い入れ、決して逸脱しない操作規則を書き与えたことと同義です：

1. Chrome/Firefox のコアドライブエンジンをシミュレートし、テストリンクにアクセスする。
2. 厳格な光学的フォームスキャンを実行し、特徴的な CSS タグを追跡し、人間のように正確にボタンを押す。
3. ストーリーのトランジション (移行) 効果を閲覧し、セーブ / ロードのメカニズムにおいて保存状態を検証する。
   もしロボットが、どのミリ秒の瞬間であっても「期待される緑色のチェックマークボックスがレンダリングされていない」ことや「Web ページが不明な致命的エラー (Fatal Error) に遭遇して真っ白な画面でクラッシュした」ことに気づいたなら、ロボットはありのままにログを書き残し、私達の CI (継続的インテグレーション) パイプラインのデプロイボタンを無情にも停止させます。

### 👻 隠された首無し武士 (Headless Mode)

あなたがローカルマシンでテストスクリプトのコマンドを実行した時、「ブラウザのウィンドウが跡形もなく消え去った！」と驚くことでしょう。
慌てる必要はありません。これこそが業界最高峰の **ヘッドレス・ブラウザ・モード (Headless Browser Mode)** なのです。グラフィックカードのリソースを最も消費する表層の UI グラフィックレンダリングロジックを剥ぎ取ることで、この首無しロボットはバックグラウンドのターミナルにて、神鬼の如き圧倒的なスピードで数十セットのシナリオチェックを爆走しながら実行できるようになります。不幸にも赤信号のエラーに遭遇した場合でも、ロボットは殉職する前に、エンジニアの検死用として高解像度のスクリーンショット (遺影) を撮影することを忘れません。

---

## 2. 実戦的戦術：Moyin エンジンのテストのボトルネックを突破する中核特許

Moyin の高度に動的なゲーム環境において、純粋なブラックボックスの E2E ロボットは簡単に盲目の患者へと成り下がってしまいます。私たちは彼らを無敵の存在にするため、以下の 2 つの重要な必殺技を開発しました：

### 🔑 戦術その一：動的マニフェスト詐称注入メカニズム (Dynamic Manifest Injection)

**【環境における難題】**：
Moyin エンジンのアーキテクチャ設計では、システムの汚染を防ぐため、基盤層は同じ ID を持つストーリーパッケージの 2 回目のインポートを完全に拒否します。これは、もし私たちが 1 ラウンド目のテストを通過した後、再び 2 ラウンド目を実行しようとした場合、ロボットは「そのストーリーファイルはすでにデッドロックされて存在している」というエラーに激突し、CI が冪等性 (Idempotency / 再実行可能性) を失うことを意味します。

**【ハッカー的解決策】**：
Playwright の初期準備スクリプトのフック (Hooks) の中に、迎撃と加工を行うアルゴリズムを埋め込みます。私たちはデータベースに送られる Manifest (マニフェスト) 証明書を動的に改ざんしました：

- 元の設定：`ID: Mock_Testing_Story`
- 動的シャッフル：`ID: Mock_Testing_Story_89f2_202611221430` (乱数ハッシュとシステムタイムスタンプの注入)。
  このすり替え工作により、バックエンドエンジンはメモリ詐欺に遭い、毎回の送信を真新しいまっさらな作品のロードとして扱うようになります。これ以降、テストスクリプトは無限の防弾耐久力を獲得しました。

### 🌉 戦術その二：異次元のホワイトボックス架け橋 (White-box Bridge)

**【環境における難題】**：
私たちの VN (ビジュアルノベル) ステージは高精度のトランジション色レンダリングを搭載しているため、このタイミングで Playwright のブラックボックスロボットが「次のセリフをクリックしてください」と強硬に要求した場合、ロボットは空振りをして半透明のマスク上をクリックしてしまい、最終的にタイムアウト待ちによって **Flaky Tests (脆弱な間欠的テストエラー)** を引き起こすことがよくあります。これは私たちの運用・保守チームを虐待しているようなものです。

**【ハッカー的解決策】**：
私たちは、ロボットに盲人象を撫でる (群盲象を評す) ような当てずっぽうな真似を強いることをやめる決断をしました。エンジニアリングチームは特別に、Vue エンジンのビルド段階において、高度な権限を備えたグローバル変数のバックドアインターフェースを開設しました：`window.__MOYIN_TEST__`。これにより、ロボットにはシステムの中核の髄液にまで深く根付いた透視 (X線) の超能力が与えられます：

- DOM タグに依存する必要がなく、Vuex / Pinia の深層の変数を直接読み取り、「現在のフェーズポインタが Phase 4 に入っているかどうか」を検証できます。
- ページめくりを実行する際、マウスのクリックシミュレーションに頼る必要はなく、権限を越えてコア関数を直接呼び出し、アニメーションを強制的に遮断することができます：`__MOYIN_TEST__.forceSkipNext()`。
  アニメーションの遅延がもたらすタイミングの密結合を徹底的に根絶し、テストのパフォーマンスと安定性は神話レベルへの飛躍を遂げました！

---

## 3. テストの軍令と検死・検収レポート (Execution & Post-Mortem)

本プロジェクトのメンバー開発者であるあなたは、必ずしも膨大なテストスイート (例の配列) を記述するスキルを備えている必要はありませんが、部隊を呼び覚まし、彼らが全滅した際に戦死記録を探し出す方法は習得しておかなければなりません：

### ⚔️ 指揮配備コマンド (Launch CLI)

ターミナルで以下のコマンドを叩くことで、即座にすべてのテスト分隊を起動して環境を掃討させます：

```bash
npx playwright test
```

### 🔬 検死と現場検証 (Triaging the Results)

このシステムは「吉報は報せるが、凶報は報せない (サイレント)」という原則を堅持しています。画面いっぱいの白黒のターミナルログが、驚愕の赤色のエラーコードに変わるのを見た瞬間、すぐに以下の場所へ直行してください：

- `tests/e2e/test-results/`：この犯罪現場の封鎖線フォルダに入ってください。あなたはここで、投げ出された致命的な Exception (例外) のスタックトレースを傍受できるだけでなく、システムがクラッシュしたまさにその瞬間に撮影された **現場の高解像度スクリーンショット (Screenshot) / 録画** を取得することができます。これらの証拠を通じて、「CSS のリファクタリングでレイアウトが崩れ、ボタンが可視境界線をオーバーフローしてしまったのか」、それとも「コア Router のルーティング麻痺によるフリーズ・白画面」なのかを迅速に判定することができます。

---

## 💡 Vibecoding 指令

AI エージェントに、ビジュアルノベルや複雑なフロントエンドインタラクションを持つゲームの E2E テストケースを記述させる際：

> 🗣️ `「Playwright を使用してこのエンジンの E2E テストを作成する際、【異次元のホワイトボックス架け橋】手法を必ず採用してください。セリフアニメーションをスキップするために、不安定な DOM のクリックに依存しないでください！ 直接 "window.__MOYIN_TEST__.forceSkipNext()" を呼び出してタイムラインをジャンプさせてください。また、シミュレーションデータを保存する際は、必ず【動的マニフェスト詐称注入】を実施し、ID の末尾にタイムスタンプとハッシュを追加して、CI パイプラインの冪等性 (Idempotency) が破壊されないように保証してください！」`
