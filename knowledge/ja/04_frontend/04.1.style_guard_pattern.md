# 04.1. スタイルガードパターン (Style Guard Pattern)

> **種類**: ベストプラクティス & セーフガード  
> **日付**: 2026-01-03  
> **出典**: 会話ログ (2026-01-03)

---

## 概要

スタイルガードパターンは、AI が UI コンポーネントを生成する際にデザインボキャブラリーから逸脱することを防ぎます。Design Tokens、スコープマッピングテーブル、ASK プロトコルを通すことで、CSS の変更は常に現行テーマと完全一致します。

---

## 1. 背景と課題

LLM を UI 開発に使うと、次のような混乱が頻発します:

1. **Creative Fill**：明示的な指示がないと、AI が独自に HEX コードやパディング、Z-index を捏造します。
2. **Hard-coded Styles**：トークンライブラリーを迂回して数値を直書きし、全体テーマの差し替えを困難にします。
3. **Cross-Project Confusion**：`moyin-web` や `moyin-game-v1` などで個別の `theme.css` を持つため、誤ったファイルを参照してしまいます。

これらはデザインシステムの破壊、リワークの増大、保守性の崩壊につながります。

---

## 2. コアガード原則

### 2.1 Mandatory Token Matching

Vue の scoped style や HTML レベルのスタイルを編集する前に、対象プロジェクトの `theme.css` を参照し、すべての値がトークンに対応しているか確認します。

**チェックリスト**:

- 色 / 背景 / グラデーション：`--ui-*`
- Z-index：`--z-*` または `--ui-z-*`
- スペーシング (margin/padding/gap)：`--ui-gap-*`
- ボーダー半径：`--ui-radius-*`
- シャドウ / グロウ：`--ui-shadow-*`
- 遷移 / デュレーション：`--ui-duration-*`

### 2.2 Scope Mapping Table

ディレクトリの迷子を防ぐため、各コードベースに対応する `theme.css` を明文化しています:

| サブプロジェクト | `theme.css` の絶対パス |
| :------------- | :-------------------- |
| **API Gateway** | 該当なし（バックエンド専用のためスタイル検証をスキップ） |
| **moyin-web** | `projects/moyin-web/src/assets/style/theme.css` |
| **moyin-game-v1** | `projects/moyin-game-v1/website/src/assets/style/theme.css` |
| **QA automation** | 該当なし（スクリプトのみのためスキップ） |

### 2.3 Missing Token ASK Protocol

必要なスタイルが `theme.css` に存在しなければ、ASK を発行して処理を止めます:

```markdown
【SYSTEM ALERT】ASK：以下のスタイルがテーマ・トークンライブラリに存在しません

- `background: linear-gradient(...)`（提案トークン `--ui-card-gradient-bg`）
- `z-index: 998`（提案トークン `--z-modal-blocker`）

【今後の方針】:
A) `theme.css` にトークンを追加（パッチ案を提示します）
B) 最も近い既存トークンに寄せる
C) 一時的に直書きしつつ TODO を残す
```

**禁止事項**:

- ❌ 承認なしに数値を直書きすること
- ❌ とりあえず硬直記述して後回しにすること

### 2.4 Anti-Hallucination Matrix

以下の条件が来たら ASK を挟む:

| エッジ条件 | SOP |
| :--------- | :-- |
| ボタンのサイズが未定義 | ASK で仕様を補完 |
| トークンが欠けている属性 | ASK で拡張 or 妥協確認 |
| デザインとトークンが衝突 | ASK で優先権を確認 |
| md/lg など応答ブレイクポイントが不明 | ASK でモバイル/デスクトップの挙動を整理 |
| 対象スコープに `theme.css` がなくレイアウト依頼あり | ASK でスタイルファイルを初期化するか確認 |

---

## 3. 実務ワークフロー

### 3.1 PLAN：スタイル依存の宣言

Action フェーズに入る前に、使用予定のトークンを書き出します:

```markdown
## PLAN：VN ステージのフォーカス甘さを修正

**対象スコープ**: moyin-game-v1

**依存トークン**:
- `--ui-primary`
- `--ui-panel`
- `--ui-gap-md`
- `--ui-radius-md`

**参照仕様**: `projects/moyin-game-v1/docs/2.DESIGN/2.4.UI_1.1.SPEC.md`
**追加トークン**: なし（既存トークンで足りる）
```

---

## 4. 関連リンク

- [`05_style_guard.md`](../../../.agent/rules/05_style_guard.md) – スタイルガードルールの機械判読版。
- [`03_coding_rules.md`](../../../.agent/rules/03_coding_rules.md) – グローバル CSS 設計ルール。
- [`theme.css`](../../../projects/moyin-game-v1/website/src/assets/style/theme.css) – `moyin-game-v1` のトークン実装。

---

_このドキュメントは Moyin ナレッジシステムによって自動生成・保守されています。_
