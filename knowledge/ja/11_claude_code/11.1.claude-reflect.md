# Claude Reflect 自動ルール蒸留システム

> タイプ：ベストプラクティス（Best Practice）
> 日付：2026-01-19

## 背景

- AI エージェント（Agent）は、配属されたばかりの新人警官のようなもので、同じミスを繰り返しがちです。指摘しても次回にはまた同じ過ちに戻ってしまいます。
- 「口頭での注意だけでモデルに覚えさせる」のは極めて不安定です。「リポジトリ（repo）に書面として残して記憶させる」必要があります。
- `claude-reflect` は、あなたの「上司の指導」を「強制力のあるバージョン管理されたルールファイル」に変換できる強力なツールです。AI 版 ESLint と考えてください。

---

## 結論

- **核心理念**：「場当たり的な指摘」を「ESLint のように強制力のあるルール」に変換し、CLAUDE.md / AGENTS.md / Skills に直接書き込みます。
- **例え話**：警察の監察部門のようなものです。上司から警官への苦情を収集し、毎晩自動的に「警務通則」として編纂。翌日から全署で強制遵守されます。
- **インストール方法**：Claude Code マーケットプレイス（Marketplace）のプラグインであり、pip や npm パッケージではありません。
- **動作原理**：キャプチャ（苦情記録）→ キュー（Queue：案件収集）→ 蒸留（ルール要約）→ 人間レビュー（最終承認）→ 書き込み → Git バージョン管理。
- **適用シーン**：命名規則、ディレクトリ構成、フレームワーク固有のコーディング嗜好、よくあるハマりポイント、固定のリリースプロセス。
- **蒸留原則**：「高頻度 + 安定 + 検証可能」なルールのみを蒸留します。
- **推奨リズム**：毎日退勤前に 30 秒で `/reflect` を実行して締め、週に 5 分で全体整理を行います。

---

## インストール

```bash
# 1. マーケットプレイスソースを追加
/plugin marketplace add bayramannakov/claude-reflect

# 2. プラグインモジュールをインストール（npm install のようなもの）
/plugin install claude-reflect@claude-reflect-marketplace

# 3. Claude Code を再起動してサービスを有効化
```

---

## コマンドリファレンス

### 日次蒸留（退勤時の締め作業）

| コマンド | 用途 | 例え話 |
| -------------------- | ------------------------------- | ------------------------------------------------ |
| `/reflect --review`  | 未処理の学習シグナルを確認       | 今日届いた苦情件数を確認する                      |
| `/reflect --dry-run` | 変更をプレビュー（書き込みなし） | 仮実行（ドラフトを確認、正式発行はしない）        |
| `/reflect`           | 正式に処理してルールを書き込む   | 上司が正式に署名・捺印し、ルールを通則に書き込む  |

### 履歴スキャン

| コマンド | 用途 |
| -------------------------------- | ---------------------------------------- |
| `/reflect --scan-history`        | 過去のセッションをスキャンしてルールを補完 |
| `/reflect --include-tool-errors` | ツールエラーを学習素材に含める             |

### ルールメンテナンス

| コマンド | 用途 |
| -------------------- | ---------------------------------------- |
| `/reflect --targets` | 対象ファイルを確認                        |
| `/reflect --dedupe`  | セマンティック（Semantic）重複排除、類似ルールの統合 |

### スキル発見と改善

| コマンド | 用途 |
| -------------------------------- | ------------------------------ |
| `/reflect-skills`                | 直近 14 日間からパターンを発見  |
| `/reflect-skills --days 30`      | 時間範囲を指定                  |
| `/reflect-skills --all-projects` | 全プロジェクトを分析            |
| `/reflect-skills --dry-run`      | プレビューのみ（書き込みなし）  |

### 補助コマンド

| コマンド | 用途 |
| --------------- | ---------------------- |
| `/skip-reflect` | 現在の学習シグナルをスキップ |
| `/view-queue`   | 未処理キューを確認     |

---

## 動作原理（自動 ESLint ルールジェネレーター）

```
ユーザーが Agent のコードを指摘・修正 → バックグラウンドで自動的に「苦情」をキューに収集 → 退勤前に /reflect を実行
     ↓
AI 監察部門が明確なルール（Always/Never/Prefer/Checklist/Gotchas）に蒸留開始
     ↓
人間がレビューして承認 → CLAUDE.md / AGENTS.md / Skill ファイルに正式書き込み
     ↓
Git Commit でバージョン管理・アップロード → 次回以降すべての新人エージェント（Agent）が読み込んで遵守
```

### ルール書き込み先

| ルール種別 | 書き込み先 |
| ---------- | ------------------------- |
| グローバルルール | `CLAUDE.md` / `AGENTS.md` |
| スキル改善 | `.claude/commands/*.md` |

### スキル改善ルーティング（Skill Improvement Routing）

特定のスキル使用中にエージェントを指摘した場合、苦情は自動的にそのスキルファイルに正確にルーティングされます：

```
/deploy → Claude がテスト実行を忘れる → 上司が叱って修正 → /reflect が /deploy に関連していることを検出
→ .claude/commands/deploy.md に自動的にルール追加：「実行前に必ずユニットテストを実行すること」
```

---

## ベストプラクティス

### 毎日退勤前（30 秒の締め作業）

```bash
/reflect --review
/reflect --dry-run
/reflect
```

### 週次整理（5 分の大掃除）

```bash
/reflect --scan-history
/reflect --dedupe
/reflect-skills --days 7
```

### ルールとして蒸留すべきもの

**蒸留する価値あり**：

- 2 回以上指摘した繰り返しのミス（何度教えてもハマる落とし穴）。
- デバッグ時間を繰り返し浪費する問題。
- 一文で**強力かつ実行可能**な規範として書けるもの（例：「var は絶対に使用しない」）。

**蒸留する価値なし**：

- 一度きりの特殊なバグ。
- 今週の暫定方針で、来週には覆る可能性のあるロジック。
- 非常に主観的で、コードレベルで検証できないルール。

---

## Moyin プロジェクト統合状況

| コンポーネント | 場所 | 説明 |
| ----------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| Workflow    | `.agent/workflows/reflect.md`                                           | Antigravity 専用の `/reflect` バッチワークフロー |
| Codex Skill | `.codex/skills/reflect/SKILL.md`                                        | Codex 専用の reflect スキル                     |
| 設定ドキュメント | `workspace/knowledge/11.claude_code/11.4.11.4.skills_plugins_config.md` | プラグイン設定一覧                               |
| 使用例      | `workspace/knowledge/11.claude_code/11.3.11.3.skills_example.md`        | コマンドクイックリファレンス                      |

---

## アクションチェックリスト

- [ ] 毎日退勤前に `/reflect --review` で苦情を確認 → `/reflect` で締め処理を実行。
- [ ] 週に一度 `/reflect --dedupe` を実行し、期限切れや重複ルールを整理。
- [ ] 月に一度 `/reflect-skills --days 30` を実行し、モジュール化すべき新スキルを発見。
- [ ] CLAUDE.md の変更を Git commit に含め、チーム全体でナレッジを共有。

---

## 参考

- [GitHub: BayramAnnakov/claude-reflect](https://github.com/BayramAnnakov/claude-reflect)
- [Anthropic: Claude Code 公式ドキュメント](https://claude.ai/code)
- [DevelopersDigest メソドロジー](https://www.developersdigest.tech/)
