# AI エージェントのブループリント：4 大汎用設計パターン（Agentic Design Patterns）

**本章の目標**：AI を一人の人間として扱うだけではもう足りません。ソフトウェアエンジニアリング最先端のエージェント 4 大陣形を学び、マネージャーのように「多部門 AI デジタルチーム」を編成しましょう。

---

[第 11 章：AI エージェントと MCP の徹底解説](./11_vibecoding_agent_mcp.md)で、エージェントとは「ツールを使える頭脳（ReAct 推論能力を備えたもの）」であることを学びました。
しかし、AI が本当に複雑なタスク（例えば完全なマイクロサービスの構築）に取り組む場合、単一の頭脳だけでは不十分です。複雑に絡み合う詳細に圧倒されてしまうことは避けられません。

近年、世界中のソフトウェアアーキテクトたちが **「エージェント型 AI 設計パターン（Agentic Design Patterns）」** と呼ばれる 4 つの必須テクニックを体系化しました。

これらのパターンをマスターすれば、真の AI オーケストレーター（Orchestrator）になれます！

---

## 1. リフレクションパターン（Reflection Pattern：自己レビューと自己修正）

- **問題シーン**：AI にカレンダーコンポーネントを書かせたら、めちゃくちゃで動かないコードを渡してきます。「ボス、完成です！」（そしてあなたは激怒しながら 2 時間かけてバグを修正…）
- **リフレクション（Reflection：自己審査）パターンの解決策**：
  AI に「批評者」というもう一つのペルソナ（Persona）を追加します。
  `[作業頭脳]` がコードを書く → `[コンパイラ/検出ツール]` に渡してエラーを発見
  → `[批評頭脳]` がエラーログを読み、容赦なく `[作業頭脳]` を指摘：「変数名のスペルが間違っています。書き直してください！」
  → 二つの頭脳が内部で戦い合い、完璧になった後にはじめて最終的な動作する結果をあなたに提出します。
  > **Moyin での体験**：`/commit` 実行時に Git がコンフリクト（Conflict）を報告した場合、エージェントは自動的にエラーメッセージを読み取り、自らコンフリクトを解消してリトライします。これがリフレクションパターンの威力です！

---

## 2. プランニングパターン（Planning Pattern：構築前の分解）

- **問題シーン**：「注文管理バックエンドを作って！」と指示すると、AI の頭脳がショートし、いきなり `index.html` を書き始めます。途中でバックエンドがないことに気づき、データベースを追加しに戻り、最終的にコードが収拾のつかない状態になります。
- **プランニング（Planning：設計図）パターンの解決策**：
  大規模タスクに直面した場合、AI はコードを書く前に強制的に**一時停止ボタン**を押し、アーキテクト（Architect）に変身してステップバイステップの実行計画を生成します：
  > 1. Express バックエンドの雛形を構築
  > 2. MongoDB のスキーマ（Schema）を定義
  > 3. ログイン API を実装
  > 4. 最後にフロントエンドのログイン画面を作成し API に接続

> **Moyin での体験**：`00_core_protocol` の最も厳格な第一条を覚えていますか？**「必ず計画とチェックリスト（Plan）を先に提示し、OK を得てからファイルを変更（Action）する」**。これがまさに AI にプランニングパターンを実践させるための鉄則です！

---

## 3. マルチエージェント協調パターン（Multi-Agent Collaboration）

- **問題シーン**：単一の AI にプログラミング、UI デザイン、ユニットテストのすべてを担当させます（これはビジュアルデザイナーにデータベース管理を頼むようなものです）。AI は負荷に耐えられずフリーズします。
- **マルチエージェント（Multi-Agent：部門会議）パターンの解決策**：
  複数の専門分野を持つ AI で構成される仮想企業を設立します：
  - `[シニアエンジニア AI]`：コアロジックの実装のみを担当。
  - `[セキュリティレビュー AI]`：エンジニアの出力を精査し脆弱性をチェック。
  - `[QA テスト AI]`：自動テストスクリプトの作成を担当。
    この 3 つの AI が仮想会議室で協議し、堅実なソリューション（Solution）に収束してからクライアントに提示します。（これは AutoGen などのフレームワークが現在行っていることです。）

---

## 4. インテリジェントルーティングパターン（LLM as a Router）

- **問題シーン**：ユーザーが「こんにちは、今何時ですか」と聞いただけなのに、システムが最も高価で賢い `GPT-4o` を呼び出して回答します。これは大砲でハエを叩くようなもので、毎月の API 請求書が悲惨なことになります。
- **ルーター（Router：総合受付）パターンの解決策**：
  極めて安価で超高速な小型「受付 AI ゲートキーパー（Gatekeeper）」を構築します。
  ユーザーがメッセージを送信すると：
  1. 受付がまず質問を確認します。
  2. 「休暇規定は？」→ 安価なローカル小型モデル（Ollama）にルーティング。
  3. 「複雑なアルゴリズムを書いて」→ 高価なハイエンドモデル（Claude 3.5 Sonnet）にルーティング。

> **Moyin での体験**：我々の **I1 Gateway** マイクロサービスは、毎日この地味だけれど重要な受付ルーティングの役割を果たしています！

---

### 検収チェックリスト

この 4 つのパターンを見ると気づくでしょう：**エージェントシステムの設計は、実は企業の人事とプロセス管理の設計そのものです。**

将来の AI パイロット（Pilot）として、以下の原則を座右の銘にしてください：

- [ ] 一人の万能天才に会社全体を任せようとしないことを理解しました（単一 AI への過度な依存を避ける）。
- [ ] AI にコーディング前に設計図を書かせることを理解しました（**プランニング / Planning**）。
- [ ] AI に自動セルフレビューの検証メカニズムを装備させることを理解しました（**リフレクション / Reflection**）。
- [ ] 適切なタスクを適切な部門に配分することを理解しました（**ルーター / Router とマルチエージェント / Multi-Agent**）。
