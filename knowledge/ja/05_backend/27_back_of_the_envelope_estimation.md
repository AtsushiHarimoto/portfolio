# 27. アーキテクトの第六感：封筒の裏の計算 (Back-of-the-envelope Estimation)

> **種類**: システム設計の数学的定量化とメンタルモデル
> **重点**: システム設計面接 (System Design Interview) における永遠の第一関門です。サーバーが毎秒どれだけの砲撃に耐えなければならないかさえ計算できないのであれば、Kafka や Cassandra を使おうと提案する資格がどこにあるのでしょうか？本篇では、シリコンバレーのトップアーキテクトたちがスターバックスのナプキンの上で、素手で帯域幅とサーバー台数を推算する神秘的な武術を解き明かします。

---

## 序：アーキテクチャの設計図を書く前に、まずは「占い」をせよ

「封筒の裏の計算 (Back-of-the-envelope Estimation) とは、単純化された仮定のセットを通じて、妥当なシステムの規模を短時間で導き出すことができる推算技術である。」 —— ByteByteGo (Alex Xu)。

PM から「Twitter に似た投稿とプッシュストリームのシステムを作ってくれ」と発注された時。若手エンジニアはすぐに IDE を開いて CRUD を書き始めます。一方、強靭なアーキテクトは紙とペンを取り、PM に尋ねます：

- 「予想される 1 日のアクティブユーザー数 (DAU) はどれくらいですか？」
- 「各ユーザーは平均して 1 日何件の投稿をしますか？」
  そして、アーキテクトは 3 分以内にあなたにこう告げるでしょう：**「Web サーバーが 50 台、巨大なシャーディングデータベースが 3 つ、そして 30 GB/s の内部ネットワーク機器が必要です。」** これはオカルトではなく、純粋な算数です。

---

## 1. 必須の 3 つの黄金定数

暗算の領域に踏み込む前に、オペレーティングシステムと物理学の天井となる制限をいくつか頭に刻み込んでおく必要があります：

1. **時間の溝**：
   - メモリ (RAM) の読み取り 1MB：$\approx 250\text{ \mu s}$ (マイクロ秒)。
   - ソリッドステートドライブ (SSD) のシーケンシャル読み取り 1MB：$\approx 1\text{ ms}$ (ミリ秒)。
   - アメリカの東海岸から西海岸へのパケット送信 (ラウンドトリップ)：$\approx 150\text{ ms}$。**(これぞネットワーク伝送の神の境界線、光の速度の限界です。これは同時に、私たちが各地に CDN を配置しなければならないという鉄壁の証明でもあります！)**
2. **高並行処理の換算公式：1 日の秒数**
   - 1 日 $= 24 \text{ hr} \times 60 \text{ min} \times 60 \text{ s} \approx \mathbf{100,000 \text{ 秒}}$ (キリの良い数字で計算するのが一番速いです！正確な値は 86400 です)。
3. **データサイズの階段**：
   - 文字 = 1 Byte
   - KB ➡️ MB ➡️ GB ➡️ TB ➡️ PB (それぞれ 1000 倍 / $10^3$ の差があります)。
   - 画像 1 枚は 2MB、1 分間の高画質ショート動画は 50MB として捉えておきます。

---

## 2. 3 分間ナプキン実戦演習：Twitter のスペックを推算する

**📍 [シナリオ]：あなたは、画像を含む投稿の公開をサポートする新しいマイクロブログアプリを設計しようとしています。**

### ステップ A. 大前提 (Assumptions) を固める

- 世界の月間アクティブユーザー数 (MAU) 3 億人。1 日のアクティブユーザー数 (DAU) はその半分として計算します：**1.5 億 (150 Million)**。
- 毎 DAU、毎日純粋なテキストの投稿を 2 件 (1 件あたり 100 Bytes) 行う + 10 人に 1 人が画像 (2 MB) を添付する。

### ステップ B. QPS (スループット - Queries Per Second) を見積もる

サーバーは 1 秒間にどれだけの圧力に耐えられるか？これが Nginx と API Gateway の配置を決定づけます。

- **1 日の総投稿量**：$1.5\text{ 億 DAU} \times 2 = \mathbf{3\text{ 億回のリクエスト / 日}}$。
- **👉 平均 QPS**：$3\text{ 億} \div 100,000\text{ 秒(毎日)} = \mathbf{3,000\text{ リクエスト / 秒}}$。
- **🚨 ピーク QPS (Peak QPS)**：経験則では、ピーク時のトラフィック (突発的な大ニュースなど) は通常、平均値の 2 倍です。したがって、**私たちのシステムは絶対に $6,000 \text{ QPS}$ に耐えられなければなりません！**

_(注：もし一般的な Node.js + Express が 500 QPS に耐えられるとすれば、最低でも 12 台の API サーバーを常備軍として準備しなければならないことがわかります。)_

### ステップ C. ストレージのコストを見積もる

ハードディスクはどれくらいの大きさに切り分けるべきか？私たちはクラウドの容量を買う余裕があるか？

- **純粋なテキストテーブルの容量**：$1.5\text{ 億} \times 2\text{ 投稿} \times 100\text{ Bytes} = \mathbf{30 \text{ GB / 日}}$。(リレーショナルデータベースにとっては全くプレッシャーになりません)。
- **メディアライブラリの爆発的な量 (画像 S3/MinIO)**：$1.5\text{ 億} \times 10\% \text{(確率)} \times 2\text{ MB} = \mathbf{30 \text{ TB / 日}}$。
- **5 年間の総コスト**：$30\text{ TB} \times 365 \times 5 = \mathbf{54,000 \text{ TB} = \mathbf{54 \text{ PB}} !}$
  _(結論：データベースはクラスタの主従バックアップ 1 セットで解決できますが、静的リソースについては、クラウドの大規模オブジェクトストレージ S3 に上げず、CDN も使わず、自分たちでハードディスクを買って構築した場合、この会社は即座に破産して倒産するでしょう。)_

### ステップ D. ネットワーク帯域幅の推算 (Bandwidth)

サーバーなどのハードウェアは CPU/RAM を見るだけでなく、ネットワークカードがパンクしないかどうかも非常に重要です。(通常、アップロードは Ingress、ダウンロードは Egress と呼ばれます)。

- **1 秒間に発生する画像のペイロード量**：上記の 1 日あたり 30 TB $\div 100,000 = \text{ 毎秒 } \mathbf{300 \text{ MB / s}}$ (これは一般的なギガビット光ファイバーネットワークカードにとっては重労働とみなされ、メディア専用のアップロードマイクロサービスを確立する必要があります)。

---

## 💡 Vibecoding 指令

AI に単にどんな機能を書くか伝えるよりも、さらにトップクラスのアプローチは、Claude へのプロンプトの最初の段落に、ご自身の環境の推算パラメータを直接叩きつけることです。あなたが作ろうとしているのがモンスター級のエンジニアリングであると AI が認識した時、その出力ロジックはスクリプトキディからシニアアーキテクトのレベルへと瞬時に飛躍するでしょう：

> 🗣️ `「AI アーキテクトに告ぐ。あなたがこれから構築するフラッシュセールモジュール (Flash Sale) は、予測される Peak QPS が 20,000 に迫り、その 95% が読み取りトラフィックです。私に普通の MySQL 読み書きスクリプトを渡してはなりません！私はこのアーキテクチャの第一層に Redis Cluster を緩衝材として利用し、非同期のメッセージキュー (1 秒間に 5MB 生成されると推測されるメッセージ負荷) を使用して、注文をデータベースに落とし込む際の圧力をオフロードすることを要求します！コード構造は、Node.js + Worker Thread を主軸として、スケーラビリティを備えたクラウドネイティブなソースコードを書き出してください。」`
