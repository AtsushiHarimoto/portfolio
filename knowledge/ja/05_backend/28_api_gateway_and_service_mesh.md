# 28. マイクロサービスの国境警備：API Gateway と Service Mesh

> **種類**: システムアーキテクチャとマイクロサービス間通信の入門
> **重点**: モノリシック (単体) アプリケーションが何百、何千ものマイクロサービスに解体された後、この巨大で混沌としたネットワーク通信をどのように管理するのでしょうか？本篇では、ByteByteGo が極めて重視する 2 つの防衛線：南北 (North-South) トラフィックを守る **API ゲートウェイ (API Gateway)** と、東西 (East-West) トラフィックを暗号化する地下情報網 **サービスメッシュ (Service Mesh)** について明確にします。

---

## 序：マイクロサービスクラスターが制御を失う時

従来のモノリシック (Monolith) アーキテクチャでは、システム内部モジュールの呼び出しは普通のメモリ機能呼び出し (Function Call) であり、安全かつ神速でした。
しかし、システムが 100 個のマイクロサービスに分割され、異なる Docker コンテナに散らばった時、これら 100 個のサービスは HTTP/gRPC を使ってネットワーク上でお互いに大声で叫び合うことを強いられます。

- **認証の災難**：これら 100 個のマイクロサービスは、それぞれが個別に JWT 検証ロジックを書かなければならないのでしょうか？
- **外部のハッカー**：これら 100 個のサービスはすべて、外部のスマホアプリから自由に呼び出せるように IP を公開しなければならないのでしょうか？
- **内部のストリーキング (裸立ち)**：もしハッカーがコンテナの 1 つを突破した場合、イントラネット内で暗号化されていないすべてのマイクロサービスのパケットを丸見えにできるのでしょうか？

これらの問題を解決するために、現代のクラウドネイティブアーキテクチャは物理的に隔離された 2 つの階層の「交通警察」を導入しました。

---

## 1. 国境の最前線で立ちはだかる：API ゲートウェイ (API Gateway)

API Gateway は、外部のインターネット (スマホ、ブラウザ) から内部のデータセンターへ入ってくるトラフィック、つまり **「南北トラフィック (North-South Traffic)」** の処理を専門としています。

### 🛡️ 究極の総合前衛と堀

- **単一のエントリポイント (Single-Entry Point)**：外部のハッカーはもはや 100 個のマイクロサービスの IP を見ることはできません。彼らが見ることができるのは、グローバルで一意の `api.moyin.com` だけです。
- **横断的な懸念事項 (Cross-cutting Concerns) の一括ブロック**：汚いけれども必要な作業をすべて一手に引き受けます！私たちは「注文マイクロサービス」の中に認証ロジックを書く必要はありません。
  - **身元認証 (Auth/JWT)**：Token を持っていない、または Token が期限切れの場合、Gateway は直接あなたを蹴り出します (`401 Unauthorized`)。バックエンドのマイクロサービスは邪魔される機会すらありません。
  - **レート制限と防御 (Rate Limiting)**：各 IP は 1 秒間に 10 回しかつつくことができません。それを超えた場合は直接 `429 Too Many Requests` を食らい、内部クラスターが DDoS トラフィックの津波に飲み込まれないように保証します。
  - **ルーティング転送 (Routing)**：`/api/upload` を画像アップロードクラスターに投げ、`/api/billing` を決済クラスターに引き渡します。

_(業界の代表作：Kong, Nginx, AWS API Gateway)_

---

## 2. 内部の地下情報網：サービスメッシュ (Service Mesh)

Gateway のセキュリティチェックを通過したトラフィックは、イントラネットのマイクロサービスクラスター間に入ります。この時、マイクロサービス A がマイクロサービス B を呼び出すことを **「東西トラフィック (East-West Traffic)」** と呼びます。

初期の頃、エンジニアはマイクロサービス A のコード内に「もし B に繋がらなかったら、3 秒待ってから 3 回 Retry し、最後にエラーを報告する...」と書かなければなりませんでした。これはビジネスロジックをネットワーク底層のクソコードで満たしてしまうだけでなく、言語の不一致問題 (A は Go、B は Python など) も生み出しました。

### 🕵️‍♂️ サイドカープロキシパターン (Sidecar Proxy)

これが Service Mesh (Istio, Envoy など) の無敵の点です。その精神は：**「どのマイクロサービスも自分自身で外部に接続することは許されない！」**というものです。
システムは、各マイクロサービスの真横に極めて軽量な「特務エージェント (Sidecar コンテナ)」を無理やり押し込みます。

- A が B を呼び出したい時、A は横にいる特務エージェントに「B を呼んでくれ」と伝えるだけです。
- 特務エージェント A は、極めて強力に暗号化された **mTLS (相互 TLS)** チャネルを利用して、こっそりと特務エージェント B に連絡します。
- 特務エージェント B が復号化した後、`localhost` を使ってパケットをマイクロサービス B に押し込みます。

### ⚡ 死角ゼロの軍隊式管理

- **ゼロトラストアーキテクチャ (Zero Trust)**：たとえハッカーがイントラネットを突破したとしても、接続を盗聴することはできません。なぜなら、すべての東西トラフィックは Sidecar によって mTLS で完全に暗号化されているからです。
- **究極のサーキットブレーカーとリトライ**：すべての Retry ロジック、タイムアウト設定、さらにはカナリアリリースのためのトラフィック分割 (5% を新しいバージョンの B へ、95% を古いバージョンの B へ送る) まで、**すべて Sidecar が代行します**。マイクロサービス A のエンジニアは、すべてがローカルマシンで起こっていると思い込み、シンプルな API 呼び出しを書くことに専念するだけで済みます。

---

## 💡 Vibecoding 指令

マイクロサービスの複雑で巨大なアーキテクチャに直面した際、AI にタスクを割り当てる時は内と外の境界を明確に引かなければなりません：

> 🗣️ `「この内部の【メール送信マイクロサービス】を記述する際、ソースコードの内部に JWT 検証ロジックやクロスドメインの CORS ヘッダーを実装することは厳禁です！これらの南北のブロッカータスクは、すべてグローバルな【API Gateway (Kong/Nginx など)】に引き上げて統一的に処理してください。内部サービスは完全に裸のままで、純粋なビジネスロジックのみを保持するようにしてください。」`
>
> 🗣️ `「私たちは次に Kubernetes と Istio サービスメッシュ (Service Mesh) を導入するため、あなたが他の内部マイクロサービスを呼び出す gRPC/HTTP 接続スクリプトを書く際は、すべての暴力的なループ Retry メカニズムや断線再接続ロジックを削除してください！隣にいる Sidecar (Envoy) を信頼して、この作業は代理の再試行として彼らに委ねてください。」`
