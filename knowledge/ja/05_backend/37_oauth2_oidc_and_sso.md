# 37. あなたは一体誰？ 認可の大乱闘と SSO の鍵 (OAuth 2.0 / OIDC)

> **種類**: システムアーキテクチャレベルのセキュリティ通信プロトコル
> **重点**: 業界最大の神話である**「OAuth 2.0 はそもそもログインするためのものではない！」**という誤解を打ち破ります。今日のインターネット全体に広がる「Google でログイン (Sign in with Google)」や、オフィスの「シングルサインオン (SSO)」の裏側で、OAuth 2.0 と OpenID Connect (OIDC) が織りなす巨大な認可帝国の構造を深く解析します。

---

## 序：自宅の鍵をサードパーティ製アプリに渡してはいけない

十数年前、あなたが新しいソーシャルメディア (初期のミニゲームサイトなど) に登録しようとした時、サイトはこう尋ねてきました：「あなたの Yahoo メールの ID とパスワードを入力してください。あなたの連絡先の中で誰が同じゲームで遊んでいるかを探してあげます！」
これは極めて恐ろしい惨事です。あなたはほんの 1 人か 2 人の友人を作るために、あなたのプライベートなメールを覗き見たり、さらには銀行のパスワードすらリセットできる「大祭司の鍵」を、そっくりそのままサードパーティ (第三者) に渡していたのです！

このような**「すべてかゼロか」のパスワードのストリーキング (丸裸状態)」**を解決するために、**OAuth 2.0 (オープン認可プロトコル)** が誕生しました。

---

## 1. OAuth 2.0：有効期限付きの「ゲストパス」を発行する

あなたはこの言葉を死ぬほど記憶に刻み込まなければなりません：**OAuth 2.0 が処理するのは「認可 (Authorization)」であり、「あなたが誰であるかの検証 (Authentication / 認証)」は担当していません**。

### 🎟️ ホテルのバレーパーキング係

Moyin App があなたの Google ドライブに 1 時間だけアクセスする権限を得たい時、パスワードを要求することはありません。

1. Moyin App はあなたを Google の玄関口 (認可サーバー / Authorization Server) へとリダイレクト (転送) します。
2. Google はあなたに尋ねます：「Moyin とかいう奴が、あなたの Google ドライブを『読み取り専用』でアクセスしたいと言っています。同意しますか？」
3. あなたが同意ボタンを押すと、Google は直ちに Moyin に対して **`Access Token (アクセストークン)`** と呼ばれる「バレーパーキング用の磁気カード」を発行します。
4. この Access Token を手にすることで、Moyin は今後数時間、あなたの車を自由に走らせる (ファイルを読み取る) ことができます。しかし、Moyin は絶対にあなたのトランクを開ける (Gmail のメールを読む) ことはできません。なぜなら、この磁気カードの権限範囲 (Scope) はガチガチに制限されているからです。

**ここで盲点があります**：この `Access Token` は多くの場合、物理的な IC キーホルダーのようなものであり、その上には**「あなたの名前や顔写真など一切印刷されていない」**のです！Moyin はあなたの車を走らせてはいますが、彼が知っているのは「私には車を運転する権限がある」ということだけです。現在自分が仕えているボス (あなた) がなんていう名前で、メールアドレスが何なのかさえ分かっていないのです！

---

## 2. 身分証明書を身につける：OpenID Connect (OIDC) 降臨

OAuth 2.0 が単なるバレーパーキングの「認可札」に過ぎないのなら、現在世界中の Web サイトにあふれている【Google でログイン (Sign in with Google)】ボタンは、一体どうやって私の名前を知っているのでしょうか？

これは、**OAuth 2.0 の上に構築された「パッチ (拡張) プロトコル」**である、**OpenID Connect (OIDC)** というプロトコルに依存しています。

### 🆔 追加された身分証明書 (ID Token)

OIDC は OAuth 2.0 のフローを巧みに利用していますが、Google があの `Access Token` を発行するのと全く同時に、Google に対して**「『`ID Token`』という名の写真付き身分証明書を一枚余分に押し付けること！」**を強制します。
この `ID Token` は全世界で統一された規格であり、その見た目は誰もがよく知る **JWT (JSON Web Token)** そのものです！

- Moyin App がこの JWT の文字列を解読してみると、中にははっきりとこう書かれています (Claims/クレーム)：
  - `sub`: "87654321" (こいつの宇宙で唯一の固有番号)
  - `name`: "Atsushi Harimoto"
  - `email`: "atsushi@example.com"
  - `iss`: "https://accounts.google.com" (この身分証明書は玉皇大帝たる Google が発行したもので、絶対に本物である！)

Moyin は嬉しそうにあなたの名前を Web ページの右上に印刷し、自社のデータベースにファイルを作成します。これこそが現代の「サードパーティログイン (ソーシャルログイン)」の完全な真実なのです！

---

## 3. 全知全能のグローバルパスポート：SSO (シングルサインオン)

企業内部に 50 種類もの異なる社内システム (休暇申請システム、経費精算システム、会議システムなど) がある場合、従業員が毎日出社するたびに 50 回も ID とパスワードを入力していては完全に崩壊してしまいます。

**SSO (Single Sign-On，シングルサインオン)** とは、「ヘッドクォーター (本部) のシステムで一度ログインしさえすれば、すべての支社ビルの玄関ドアがあなたのために自動で開く」というアーキテクチャの概念です。
現代では、この魔法の多くは、OIDC プロトコルと中央の「ID プロバイダー (IdP, Identity Provider。Auth0、Okta、Microsoft Azure AD など)」の組み合わせによって実現されています。

### 🏰 国境を越えるパスポートの運用 (Central Authentication)

あなたが出社初日、「休暇申請システム `a.com`」を開いた時：

1. `a.com` はあなたを見知らぬ人だと判断し、直ちにあなたを本部の「守衛室 `idp.company.com`」へと蹴り返します。
2. 守衛室はあなたに ID とパスワードを入力するよう求め、`idp.company.com` ドメインの下に保存される Cookie (本部ビザ) を発行します。
3. 守衛室はあなたを `a.com` に送り返し、その際あなたのポケットに 1 枚の `ID Token (JWT)` をねじ込みます。
   午後、あなたは別のドメインの「経費精算システム `b.com`」を開きました：
4. `b.com` もあなたのことを知りません！再びあなたを「守衛室 `idp.company.com`」へと蹴り返します。
5. ここで奇跡が起こります！守衛室はあなたがすでに午前中に発行された「本部ビザ Cookie」を身につけているのを見つけ、何も尋ねることなく、**「1 秒以内に 1 枚の全く新しい ID Token を直接発行し」、あなたを強制的に `b.com` へと弾き返します！**
   あなたの視点から見れば、単に新しい Web ページをクリックして開き、画面がチカッと一瞬光っただけで、あなたは直接経費精算システムに「パスワードなしでログイン」できたように見えるのです。これがクロスドメイン SSO の偉大なる航路です！

---

## 💡 Vibecoding 指令

企業向け、あるいは B2C サイト向けの安全無比な認証の関所を構築するよう AI に命じる際は、あなたのドメインの深さを見せつけてください：

> 🗣️ `「この Moyin バックエンド管理ダッシュボードの認証層を記述する際、データベースのパスワード照合ロジックをゼロから手書きで作成することはやめてください！私たちは全面的に【SSO シングルサインオン アーキテクチャ】を導入します。私たちの IdP (ID プロバイダー) として、Auth0 または Keycloak へ直接接続連携を設定してください。そして、フロントエンドフレームワーク (Vue/React) において、PKCE 拡張属性に基づく【OAuth 2.0 認可コードフロー (Authorization Code Flow)】を不備なく実装し、私たち従業員の Email などの Claims (属性) ロールを含む【OIDC 仕様の ID Token (JWT フォーマット)】を抽出して、ローカルのセッション (Session) を確立するようにしてください！」`
