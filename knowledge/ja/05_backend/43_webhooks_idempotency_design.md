# 43. エンタープライズ級 API 連携の芸術：Webhook と冪等性の防衛線 (Webhook & Idempotency)

> **種類**: API アーキテクチャとシステムインテグレーションセキュリティ
> **重点**: システムがどれほど優れて記述されていようと、Stripe や LINE Pay、GitHub のような外部の巨大プラットフォームと連携する際、**「署名検証 (Signature)」**と**「冪等性 (Idempotency)」**の概念を理解していなければ、あなたの注文はハッカーによってめちゃくちゃにされるだけでなく、顧客に 3 回も重複して請求してしまうことになります！

---

## 序：狂ったようにページを更新するな、向こうが電話してくるのを待て

ユーザーがあなたの Moyin サイトで「ファミリーマートのバーコード支払い」をクリックしたとします。ユーザーはスマートフォンを持ってコンビニへ行き、バーコードをスキャンして支払いを済ませます。
コンビニはいつ、あなたのサーバーにお金を受け取ったことを通知するのでしょうか？それは今かもしれないし、2 日後かもしれません。

- **ポーリング (Polling)**：あなたのサーバーが毎秒ペイメントゲートウェイに「彼はもう支払いましたか？ もう支払いましたか？」と尋ねに行きます。これではすぐに決済代行会社によってあなたの IP がブロックされてしまいます。
- **Webhook の原理**：あなたは API の URL (例えば `https://moyin.com/api/webhook/stripe`) を外部プラットフォームに預けておきます。そして相手に「家に帰って待っていてくれ」と告げます。**「顧客が支払いを終えたら、君 (外部プラットフォーム) の方から能動的に HTTP POST を打ってこの URL をつつき、私に通知してくれ」**。これは「リバース API (Reverse API)」とも呼ばれます。

一見エレガントに見えますが、悪魔は完全に細部に宿っています。

---

## 1. 偽造されたメッセンジャー：Webhook のガスマスク (HMAC 署名)

あなたの Webhook URL が `.../webhook/stripe` であることは誰でも知ることができます。
もしハッカーがスクリプトを書き、意図的に Stripe を装った JSON（例えば `{"status": "paid", "amount": 9999}`）をあなたの Webhook URL に向けて狂ったように猛烈に送信してきた場合、あなたのシステムは馬鹿正直に 1000 回も商品を出荷するのでしょうか？

### 🔒 血の誓印 (HMAC-SHA256)

外部プラットフォームが Webhook を登録する際、彼らはこっそりと、あなたとプラットフォームの 2 人しか知らない「暗号鍵 (Webhook Secret)」を渡してくれます。

- Stripe はあなたにパケットを送信する前、毎回この秘密鍵とデータを使用して、無敵のハッシュ値の乱数文字列 (例えば `sig=abc123...`) を算出し、それを HTTP Header に入れて送ってきます。
- あなたの API の入り口では、**絶対に直接 JSON を解析してはいけません！** まずあなた自身の秘密鍵を使って一度計算する必要があります。もし両者が一致しなければ、この手紙は確実にハッカーによって改ざんされたものであることを意味し、直ちに `401 Unauthorized` を返して追い出さなければなりません！

---

## 2. 致命的なネットワークの再試行：冪等性 (Idempotency) の救済

もし Stripe の支払いが成功し、実際に Webhook があなたのサーバーを呼び出してくれたらどうでしょう？
この時、あなたのサーバーが忙しく、注文の処理を終えるのに 15 秒かかった結果、Stripe に `HTTP 200 OK` を返し忘れてしまったとします。

- **再試行地獄 (Retry Storm)**：Stripe はあなたの `200` を待っても受け取れなかったため、メッセージが漏れたと考えました。そこで彼らは非常にプロ意識高く、1 分後、あるいは 1 時間後に、**「この全く同じ支払い成功の通知を、死に物狂いであなたの家に 3 回も追加で爆撃しに来た！」** のです。
- **災難**：もしあなたが書いたコードが単なる `balance = balance + 500` だったとしたら。おめでとうございます。このユーザーは 1 回しかお金を払っていないのに、彼の残高は 4 回も追加されてしまいました。

### 🛡️ 冪等性キー (Idempotency Key)

「冪等性」こそが、すべての分散システムと API 設計において最も神聖な語彙です。
その意味は、**「同じ操作について、あなたが 1 回実行しようと、狂ったようにクリックして 1 万回実行しようと、その結果は 1 回実行した時と等しくなければならない！」** ということです。

- **防御手段**：Stripe が送ってくる通知の中には、冪等キーとして間違いなく唯一無二の `event_id: "evt_345"` が付随しています。
- **Redis のゴールキーパー**：あなたの API のコードの 1 行目は、必ず Redis へ行き、この鍵が存在するかどうかを確認しなければなりません (通常は 24 時間の有効期限 TTL が設定されます)。
  - もしこの鍵を今まで見たことがなければ：`evt_345` を Redis に保存し、安心して商品を出荷し、残高を追加します。
  - もし Redis がこの鍵が**すでに存在している**ことを発見したら：これは Stripe が誤解して再送信してきた「リプレイ攻撃」であることを即座に悟ります。あなたのプログラムはこう叫ばなければなりません：_「そんなものはとっくの昔に処理済みだ！ 直ちに HTTP 200 を投げ返して追い払え。絶対に再度出荷することは許されない！」_

---

## 💡 Vibecoding 指令

AI を使って LINE や Stripe、PayPal などの金銭の生命財産に関わるパッシブインターフェース (受け身の連携) を開発する際：

> 🗣️ `「この Stripe や現地のペイメントゲートウェイからの受信を担当する Webhook Controller を記述する際、無防備に Body の JSON を取り出してそのまま注文ステータスを変更することは厳禁です！ 必ず国家安全・金融レベルの 2 つの防衛線を追加してください：1 つ目は webhook_secret を利用し、【HMAC-SHA256 による Header 署名検証】を行うこと。検証を通過しなかったリクエストは容赦なく拒否してください。2 つ目は payload 内の event_id に対して【Redis の冪等性 (Idempotency) ロック】を導入すること。万が一、上流のペイメントゲートウェイがタイムアウトによって Retry Storm (再試行の嵐) を引き起こしたとしても、私たちのシステムが絶対に顧客に対して重複した引き落としや重複したチャージを発生させないことを保証してください！」`
