# 14. 同時実行とデータベースロック：超売りを防ぐ

> **種類**: システム＆トランザクション入門  
> **重点**: 高負荷下のレースコンディションが超売りに直結する仕組みと、悲観的ロック・楽観的ロック・トランザクションの原則を説明します。

---

## 1. レースコンディション：超売りの悪夢

Flash Sale の現場では、Alpha と Beta がマイクロ秒単位で同じ在庫 API を叩きます。  
同一の行に対して同時に「残数 1」を読んでしまうと、両者が引き算して 0 にしてしまい、結果的に 1 個しかないアイテムが二人に配布されてしまう――これが **overselling（超売り）** です。デジタル資産でこの失敗が起きれば信頼は地に落ち、企業は一晩で破綻します。

---

## 2. ロック機構：叩き潰すか、諦めるか

### 🛑 悲観的ロック

「誰かが確実に悪さをする」と仮定し、対象行に排他ロックをかけます。Alpha が読み始めた瞬間、Beta は直ちに BLOCK され、Alpha が決済を完了しロックを解放するまで待たされます。効果は絶対ですが、パフォーマンスと応答性は犠牲になり、デッドロックの危険も高まります。

### 🤝 楽観的ロック

「みんな常識的」という前提のもと、バージョン番号（Revision）を付けます。Alpha と Beta はともに `version: v1` を読んだのち、Alpha の更新が v2 に昇格すると、Beta の v1 ベースの更新は拒否され Conflict となり、再試行やエラーフローに切り替わります。

MongoDB のようなドキュメントDBでは、この方式で高いスループットと柔軟性を両立します。

---

## 3. トランザクション：原子性の鎧

プレイヤーの課金＋アイテム付与は複数モジュールにまたがる処理です。一方が成功して他方が失敗すれば、ユーザーは金だけ抜かれて何も得られません。

トランザクションは「すべて成功」か「すべてロールバック」の原子性を保証します。最後のステップで例外が発生しても、Rollback が実行され、100 クレジットも武器の記録も元の状態へ巻き戻されます。

---

## 💡 Vibecoding 指示

高リスクな金銭/在庫ロジックを AI に依頼する際は：

> 「この処理は DB トランザクションで包んでください。さらにテーブルに Revision カラムを用意し、更新時に楽観的ロックでバージョンチェックを行ってください。バージョン違いで Conflict したらリトライまたは失敗応答を返し、超売りの状態を絶対に生み出さないでください。」
