# マルチプロジェクト・ワークフロー (Workflow) ルール設計パターン

> **種類**: ワークフロー
> **日付**: 2026-01-03
> **出典**: 会話 ID（2026-01-03 セッション）

---

## 概要

複数のサブプロジェクトをサポートするエージェントルールとワークフローを設計します。SCOPE パスマッピング、自動識別、エラーハンドリングメカニズムにより、AI が正確に作業ディレクトリを特定し、クロスプロジェクトの誤操作を防止します。

---

## 背景

マルチプロジェクトモノレポ (Monorepo) アーキテクチャにおいて、AI エージェントは異なるサブプロジェクトの開発タスクを処理する必要があります。明確な SCOPE マッピングメカニズムがない場合、以下の問題が発生します：

1. AI が現在の作業ディレクトリを特定できない
2. 相対パス参照が曖昧
3. クロスプロジェクトの誤操作（混合コミットなど）
4. ドキュメントとコードのパス不一致

---

## 詳細設計

### コア設計原則

#### 1. SCOPE パスマッピングテーブル

各ワークフローとルールファイルで、SCOPE とパスのマッピングを明示的に定義：

```markdown
## SCOPE パスマッピング

| サブプロジェクト  | コードルート                         | ドキュメントルート                 | レビュー出力                            |
| ----------------- | ------------------------------------ | ---------------------------------- | --------------------------------------- |
| **API**           | `projects/moyin-gateway/web2api`     | `projects/moyin-gateway/docs`      | `projects/moyin-gateway/docs/review`    |
| **moyin-web**     | `projects/moyin-web`                 | `projects/moyin-web/docs`          | `projects/moyin-web/docs/review`        |
| **moyin-game-v1** | `projects/moyin-game-v1/website`     | `projects/moyin-game-v1/docs`      | `projects/moyin-game-v1/docs/review`    |
| **QA**            | `projects/tests`                     | `projects/tests/docs`              | `projects/tests/docs/review`            |
```

#### 2. Step 0: 現在の SCOPE を確認

各ワークフローの最初のステップで現在の SCOPE を確認：

```markdown
### Step 0: 現在の SCOPE を確認
// turbo
ユーザーリクエストでサブプロジェクトが明示的に指定されているか確認。

**未指定の場合**：
- `ASK:` でユーザーにサブプロジェクトの選択を求める
- 利用可能なすべてのオプションをリスト表示

**指定済みの場合**：
- SCOPE を確認し対応パスを表示
```

#### 3. パス参照ルール

相対パスは禁止。「SCOPE テーブル参照」に置換：

**NG**：`docs/review/ ディレクトリに出力`
**OK**：`[現在の SCOPE]/docs/review/ ディレクトリに出力（SCOPE パスマッピングテーブル参照）`

#### 4. クロス SCOPE 検出と処理

ファイル操作を伴うワークフローでは、クロス SCOPE 変更を検出必須：

```markdown
**クロス SCOPE 変更がある場合**：
- 各 SCOPE の変更ファイルリストを提示
- `ASK:` で個別処理するかユーザーに確認
- 推奨：SCOPE ごとにワークフローを個別実行
```

---

## 注意事項

- **SCOPE マッピングテーブルは `01_project_scope.md` と同期必須**：パス変更時は関連するすべてのファイルを同時更新。
- **Step 0 には `// turbo` タグ必須**：SCOPE 確認ステップの自動実行を保証。
- **相対パス禁止**：すべてのパス参照は「SCOPE テーブル参照」を明示。
- **クロス SCOPE 変更は ASK 必須**：自動処理は不可、ユーザーに処理方法を明示的に選択させる。

---

_本ドキュメントは `/run-wiki conversation` により自動生成されました_
