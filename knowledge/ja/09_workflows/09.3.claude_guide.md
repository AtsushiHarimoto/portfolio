# クロスエージェント (Cross-Agent) 協業ガイド：Claude 計画から Antigravity 実行までのベストプラクティス

**前提条件**：システムレベルのルールファイル（`.agent/rules/*.md`）と `AGENTS.md` を確立し、すべてのエージェントに以下のコア規律の厳守を強制していること：

- **Doc-First 原則**：コーディングに着手する前に、仕様ドキュメントを優先的に確認します。
- **承認ゲート**：PLAN を提出 -> 承認待ち（OK）-> 承認後に ACTION が許可。
- **デバッグプロトコル**：異常（Bug/BG）発生時は、証拠チェーンと根本原因ロジックを先に提示し、その後に解決策を提案。
- **成果検証**：毎回の実行結果には改竄不可能な証拠（影響ファイルリスト / ターミナルコマンド出力 / スクリーンショット / 手動検証チェックリスト）を添付。

---

## 0) 汎用コンテキストプロトコル：効率的なタスク開始のための標準フレーズ

### 0.1 Claude への指示（ドキュメントレビュー / 要件明確化 / アーキテクチャ整合に特化）

- **コア目的**：Claude に「ドキュメントコンテキストレビュー + システム衝突点の抽出 + 高い実行可能性を持つ PLAN の生成」を実行させます。
- **標準入力テンプレート**：
  > `[PLAN 指示] 現在のタスクは <機能名/課題> を推進することです。エンジニアリングスコープは <対象サブシステムディレクトリ> に限定。Doc-First 原則に従い既存 docs を検索（システムルールディレクトリを除外）し、現状とドキュメントの衝突/アーキテクチャのギャップを特定してください。最終出力：1. 衝突リスト 2. 仕様ドキュメント修訂提案 3. 下流コード実装計画。`

**Claude 出力の品質チェックリスト**：

- **DOC CHECK 検証ログ**：確認したドキュメントパスを明示的にリスト。
- **衝突とギャップ分析**：どのドキュメント条項が現行システムロジックと乖離しているかを正確に特定（ファイルパスとセクションを明記）。
- **実装計画 (PLAN)**：実行ステップ、影響範囲、運用リスク、検証基準を順序立てて記載。
- **ブロッキングポイント確認**：ドキュメント再構成が関与する場合、ここで一時停止しユーザー承認（OK）を待機。コードの先行記述は絶対禁止。

### 0.2 Antigravity への引継ぎ指示（コード実装とテストエンジニアリングに特化）

- **コア目的**：Claude が収束させたアーキテクチャ決定を、Antigravity が直接消化できる実行チケットにシームレスに変換。
- **標準入力テンプレート**：
  > `[PLAN 引継ぎ] 以下は計画層（Claude）が生成した DOC CHECK 検証ログ、衝突リスト、最終実装ブループリントです。システムルールに従い作業を実行してください：タスク理解の復唱 + 変更ファイルマトリクスとパスのリスト + 検証コマンドの設計。OK 返信なしに ACTION フェーズに入ることは禁止。`

**Antigravity 協業リズム**：

- Antigravity が実装 PLAN を提出 -> ユーザーがレビューし `OK` を発行 -> ACTION 権限アンロック。
- 実装完了後 -> ユーザーは客観的エビデンス（ファイル変更リスト / コマンド実行ログ）を検証して受入判断。

---

## 1) ソフトウェア開発シナリオ (RUN-DEV)：新機能構築

### 1.1 計画フェーズ (Claude)：アーキテクチャファーストのドキュメント整合

**指示**：
- > `[PLAN 開始] 新機能モジュール：<xxx>。スコープ限定：projects/<対象サブシステム>。Doc-First 開始：docs 検索（ルールフォルダ除外）-> コア要件抽出 -> アーキテクチャ衝突・ギャップ特定 ->「ドキュメント修訂草案」+「コード実装・検証計画」生成。`

**期待されるアウトプット**：
- `docs/review/issues/<日付>_feature_xxx.md` に格納されたレポート。
- ドキュメント欠陥に対するセクションレベルの修訂提案（ソースコードには一切触れない）。

### 1.2 実行フェーズ (Antigravity)：承認済みブループリントに基づく実装

**指示**：
- > `[PLAN 引継ぎ] 承認済み Claude 計画に従い実装開始。厳格制約：<サブシステムソースディレクトリ> 内の変更のみ許可。完了時にエビデンス（テストコマンドと成功ログ）を提示。まず実行 PLAN を提示し承認待ち。`

**受入サイクル**：
- `OK` 返信 -> Antigravity の ACTION を承認。
- 受入確認：変更ファイルパスの正確性、コマンド実行の有効性、重要ログ抜粋。

---

## 2) 異常調査シナリオ (RUN-DEV)：バグ解析とログ解読 (BG)

### 2.1 計画フェーズ (Claude)：精密な根本原因特定

**指示**：
- > `[BG 調査] 異常動作：<ログ抜粋/再現手順>。スコープ：<影響サブシステム>。根本原因分析開始（証拠チェーン提示：問題のソースコードブロックと衝突ドキュメント条項を特定）-> 候補根本原因を確率順リスト -> 「既存要件を変更しない」前提での最小修正案 -> 検証ステップ定義。`

### 2.2 実行フェーズ (Antigravity)：「最小限修正」原則の徹底

**指示**：
- > `[BG 引継ぎ] 根本原因分析レポートと最小修正ブループリントは以下。根本原因ロジックとコード介入境界を復唱し、検証コマンド付き実行 PLAN を生成。承認コマンド（'OK'）後に ACTION 開始。`

---

## 3) 品質保証シナリオ (RUN-QA)：自動化 E2E / 回帰テストセーフティネット構築

### 3.1 計画フェーズ (Claude)：要件を「テスト可能な仕様」に変換

**指示**：
- > `[PLAN 開始] <特定機能/モジュール> にホワイトボックス E2E（またはスモーク）テスト防御線を構築。Doc-First：docs スキャン（ルールパッケージスキップ）-> test_cases 仕様マトリクス列挙（前提条件/実行ステップ/期待状態/カバレッジ死角を含む）-> テスト不可能エリア・欠落テストケース公開 -> 完全テスト設計ブループリント生成（tests/docs にアーカイブ）。`

### 3.2 実行フェーズ (Antigravity)：テストフレームワーク先行

**指示**：
- > `[PLAN 引継ぎ] test_cases 仕様マトリクスに基づきテストファイルスキャフォールディングとテストケースドキュメントを確立。安定後に実テストスクリプトを埋める。セーフティレール：PLAN 提示（ファイル/コマンド/カバレッジ目標）-> 承認後 ACTION。各完了時にエビデンスパッケージ提出。`

---

## 4) エージェント引継ぎの究極化：「改竄不可能な最小限移交パッケージ」

Claude の結論は以下 5 ブロックにモジュール化してから Antigravity に引き渡します：

1. **スコープロック (Scope Lock)**：操作対象のサブシステムとディレクトリを明示的にバインド。
2. **ドキュメントチェック結果 (Doc Check Result)**：変更の根拠となる仕様ドキュメントを明記。
3. **ギャップと衝突 (Gap & Conflicts)**：仕様と現状の乖離を逐条開示、セクションアンカー付記。
4. **最終計画 (Finalized Plan)**：線形・不可逆な操作ステップに分解。
5. **検証戦略 (Verify Strategy)**：シェルコマンドまたは手動検証チェックリストを定義。

---

## 5) 人間のコマンダーの境界制御

マルチエージェント協業では各役割の機能が明確でなければなりません：

- **Claude**：「要件翻訳、アーキテクチャドキュメント整合、レビュー監査、課題アラート生成」担当。
- **Antigravity**：「コードリファクタリング、コマンド環境操作、テストエンジニアリング実行」担当。
- **意思決定者（あなた）**：3 つのセーフティネット機能に集中：
  1. **計画承認**：制約準拠の PLAN のみ承認。AI の無許可コード発散には応じません。
  2. **エビデンス検証**：「結果ログとコマンド出力」のみで判断。
  3. **損切りリスタート (RETAKE)**：3 ラウンド以上収束しない場合、RETAKE を発行。

---

## 6) 最小制御要素（ワンライナーコマンド）：トークンコスト効率の最大化

- **新機能開発**：
  > `[PLAN] コア目標=<...> システム境界=<...> Doc-First 開始、ドキュメント衝突分析とコード実装計画を先に提出。`
- **バグ調査**：
  > `[BG] 表面異常=<...> 再現パス=<...> 完全な証拠チェーン + 確率順候補 + 最小修正コードを提示。`
- **戦略的ピボット**：
  > `[RETAKE] 分析方向がフォーカスから逸脱=<...> 元の境界に強制リダイレクト=<...> 前提撤回、クリーン PLAN 再提出。`
- **スコープ防御**：
  > `[PLAN] 最高制限令：<projects/xxx> モジュールのみ変更可。その他は無条件ロック。`
- **コミットゲート**：
  > `[COMMIT] バージョンパッケージング準備。変更サマリー + 影響評価 + テスト結果をリスト。OK なしに git commit 禁止。`
