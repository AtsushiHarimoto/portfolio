# 10. データベース & ストレージ設計 (Database & Storage Design)

> **種類**: システムアーキテクチャ基礎  
> **重点**: 関係型（SQL）と非関係型（NoSQL）の違いを丁寧に解説し、テキスト、メディア、キャッシュに対する Moyin の異機能ストレージ戦略を明らかにします。

---

## 1. コアストレージの選択：SQL か NoSQL か

データベース設計は、データモデルの厳密さと拡張性の要求を見極めることから始まります。

| ファミリー | 特徴 | Moyin での役割 |
| :-------- | :--- | :------------ |
| **関係型（SQL / RDBMS）**<br>(MySQL, PostgreSQL) | スキーマ厳密：すべてのテーブル列＆制約を事前に定義。ACID で絶対的一貫性を担保します。 | ✅ 金流や会計など、矛盾を許さないトランザクションに最適。<br>❌ AI が生成する非構造化データには適さず、大規模なスキーマ移行は工数災害となるので、現時点では採用していません。 |
| **非関係型（NoSQL）**<br>(MongoDB) | ドキュメント指向：ネストの深い BSON を欄定義なしにコレクションに投入可能。 | ✅ Moyin の主要ストア。日々変化するストーリーノードや 50 層スキルツリー等の設定を柔軟に扱えます。 |

> 💡 **ベストプラクティス**: マイクロサービスとは、大規模アプリを複数の小アプリに分割し、それらを RESTful/gRPC で接続する思想です。

---

## 2. インメモリキャッシュ

磁気ディスク I/O を突破するため、高速バッファ層は必須です。

- **採用**：Redis（Remote Dictionary Server）  
- **位置づけ**：RAM 上のキー・バリュー型ストア。  
- **特徴**：読み書きは SSD の何千倍も高速ですが、ボラティリティが高く、電源断や再起動でデータが消えます。

> ⚡ **実務**：Redis は TTL を持つホットデータ（オンラインセッション、5 分間限定の OTP/JWT トークン、リアルタイムランキングキャッシュ）に限定。ミリ秒級のレスポンスを保証します。

---

## 3. オブジェクトストレージ

数 MB の高解像度画像や無損失音声を Base64 にして MongoDB に入れると、ディスク肥大化とページフォルトを招きます。

- **禁忌**：大型 BLOB はドキュメント/リレーショナル DB に入れてはいけません。  
- **解決**：AWS S3 やオンプレミスの MinIO 等の分散オブジェクトストレージを導入。  
- **パターン**：  
  1. 数 GB の動画や音声を MinIO にアップロード。  
  2. `https://s3.moyin.local/assets/char_123.mp3` のような短い URL を受け取る。  
  3. MongoDB にはその URL 文字列だけを格納し、フロントには CDN 経由で配信。  

これによりフロントは軽量なまま、静的資産の耐久性を確保できます。

---

## 4. インデックスの魔法

レコード数が百万を超えるとフルテーブルスキャンで CPU を枯渇させます。

- **仕組み**：高頻度の列（例：`UserEmail`）に B-tree/ハッシュ構造のインデックスを付与。書籍の索引のように O(log N) で正しいページへ飛びます。  
- **トレードオフ**：インデックスは読み取りを爆速にする一方で書き込み性能とディスク容量を犠牲にするので、クエリ負荷の高い列に厳選して付与します。

---

## ✅ アーキテクチャ検収チェック

本格的なバックエンドに着手する前に、異機能ストレージの分流と AI への指示内容を体得してください。

- [ ] 「MongoDB は物語テキスト、数値バンク、可変 JSON 設定のための NoSQL であると理解しています。」  
- [ ] 「メディア資産は MinIO 等のオブジェクトストレージに置き、CDN URL だけをデータベースに保持します。」  
- [ ] 「Redis は永続性を求めない高頻度キャッシュ向けです。状態情報とリアルタイムペアリングの役割を担います。」  
- [ ] 「新しい検索列を作る際は、AI に『Email、UserID にはインデックスを必ず付けて遅延を防いでください』と依頼します。」
