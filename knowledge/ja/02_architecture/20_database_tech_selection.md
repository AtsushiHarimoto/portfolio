# 20. データベース技術選定：SQL 対 NoSQL

> **種類**: バックエンドストレージ入門  
> **重点**: SQL のトランザクション一貫性と、NoSQL に含まれる 4 つのパターンを分析し、CAP 定理を意思決定へのフレームワークとして用います。

---

## 1. 関係型 SQL：強一貫性の庭園

関係型は集合論と代数によって構成されます。

- **ACID**：原子性・一貫性・分離性・持続性がトランザクションを守り、帳尻が取れない転送を防ぎます。  
- **厳格スキーマ**：全テーブルに型と制約が事前定義され、運用中のスキーマ変更はリスクとダウンタイムを伴います。

### SQL を選ぶべき場面

1. データ誤差を絶対に許せない決済やライフクリティカルな業務。  
2. 巨大なテーブル間で JOIN を多用する複雑なビジネスロジック。

---

## 2. NoSQL：多態なデータ都市

NoSQL は四つのファミリーから構成され、極端な負荷に特化します。

### ① ドキュメントストア（MongoDB）

- スキーマレスの JSON/BSON を格納し、構造変化に対して柔軟。  
- Moyin ではストーリーパスや NPC 状態、スキル木など変化の激しい設定を迅速に扱えます。

### ② キー・バリューストア（Redis）

- 単純な `Key -> Value` を RAM に保持し、セッションやランキング、レートリミッターの高速キャッシュに最適。

### ③ ワイドカラムストア（Cassandra, HBase）

- 列指向で書き込み密度が高い業務に特化。数百万の GPU センサーや天文ログなど。

### ④ グラフデータベース（Neo4j）

- ノードとエッジでネットワーク構造を表現し、複雑な三段階スコアの偶発関係や不正検知を得意とします。

---

## 3. 分散システムの鉄則：CAP 定理

クラスターでは次の三要素を同時に満たせません：

- **C（Consistency）**：どのノードからも最新の結果。  
- **A（Availability）**：リクエストに迅速に応答（最新でない可能性あり）。  
- **P（Partition Tolerance）**：ネットワーク分断が起きても稼働。

分断時には CP と AP のどちらかを選択：

- **CP 系（MongoDB, HBase）**：整合性を優先し、分断時はリクエストを拒否。可用性を犠牲に。  
- **AP 系（Cassandra, DynamoDB）**：先に書き込みを許可し、分断中は異なる結果が出て、復旧後に最終的一貫性へ収束。

---

## ✅ 選定と発注のチェックリスト

AI にデータ層を設計させる際は、次の制約を明確に伝えます。

- [ ] 「決済やストア機能には PostgreSQL に Redis キャッシュを組み合わせて、トランザクションを守る構成をお願いします。」  
- [ ] 「LLM 生成の JSON など構造変化の激しいデータは MongoDB の文書型に落とし、拡張性を活かしてください。」
