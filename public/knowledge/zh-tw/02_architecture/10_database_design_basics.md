# 10. 資料庫設計與異構儲存基礎 (Database & Storage Design)

> **類型**: 系統架構基礎科普  
> **重點**: 解析關聯式 (SQL) 與非關聯式 (NoSQL) 資料庫之核心差異，並闡明 Moyin 專案中針對文字、多媒體與快取資料之「異構儲存 (Heterogeneous Storage)」架構策略。

---

## 1. 核心儲存庫選型：關聯式 (SQL) vs 非關聯式 (NoSQL)

資料庫架構設計之首要抉擇，在於判定資料模型之嚴謹度與擴展需求：

| 資料庫派系                                                   | 架構本質與工程特性                                                                                                                         | 適配場景與 Moyin 專案定位                                                                                                                                  |
| :----------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **關聯式資料庫<br>(SQL / RDBMS)**<br>(例：MySQL, PostgreSQL) | **強結構化 (Schema-rigid) 儲存**。<br>寫入前必須嚴格定義所有資料表欄位 (Columns) 與關聯鍵 (Constraints)。強調 ACID 事務與絕對一致性。      | ✅ 適用於金流、帳務等零容錯率之交易系統。<br>❌ 面對 AI 生成具備高度不確定性之非結構化資料時，頻繁執行 Schema 遷移將成為工程災難。因此本專案前期暫不採用。 |
| **非關聯式資料庫<br>(NoSQL)**<br>(例：MongoDB)               | **文件導向 (Document-oriented) 儲存**。<br>摒棄預設欄位限制，允許將結構多變、巢狀極深之 BSON (二進位 JSON) 文件直接存入集合 (Collection)。 | ✅ 具備極強悍之資料塑性。<br>🎯 **Moyin 專案之主力**。完美承載 AI 所產生每日異動的故事節點、擁有 50 層動態技能樹之角色設定檔，提供無與倫比的開發迭代速度。 |

---

## 2. 記憶體內快取機制 (In-Memory Cache)

為破除頻繁的磁碟 I/O 存取瓶頸，系統架構中必定需穿插一道高速緩衝層。

- **解決方案**：**Redis (Remote Dictionary Server)**
- **架構定位**：**運行於 RAM 之鍵值對 (Key-Value) 極速資料庫**。
- **特性剖析**：其數據讀寫速度高達傳統固態硬碟的數萬倍。然其致命傷在於揮發性 (Volatility)，一旦伺服器中斷供電或服務重啟，未經持久化備份之記憶體資料將全數淪喪。

> ⚡ **Moyin 專案實務應用**：
> 我們嚴格限制 Redis 僅用於存放「時效性短且遺失風險可控」之熱點資料 (Hot Data)。
> 例如：玩家當前之在線狀態 (Online Sessions)、具有 5 分鐘生存期限制 (TTL) 之一次性登入驗證碼 (OTP/JWT Tokens)，或即時排行榜緩存。利用其極致的 I/O 提供毫秒級的使用者反饋。

---

## 3. 物件存儲服務 (Object Storage Service)

倘若試圖將單檔數 MB 的高畫質影像 (.png) 或無損音軌 (.wav) 轉換為 Base64 字串並強行塞入 MongoDB，將引致極其嚴重之磁碟膨脹與頁面查詢卡頓 (Page Faults)。

- **禁忌**：絕對禁止將大型 BLOB (Binary Large Object) 多媒體資源寫入本文導向或關聯式資料庫中。
- **標準解決方案**：引入分散式 **物件存儲伺服器 (如 AWS S3 或私有雲開源替代方案 MinIO)**。
- **運作拓撲**：
  1. 系統將動輒數 GB 之影片或音檔主體，拋送予大容量的 MinIO 倉庫。
  2. MinIO 接收封鎖後，返還一組絕對網址路由（例如 `https://s3.moyin.local/assets/char_123.mp3`）。
  3. **最終，後端僅將這串極短的「網址字串」做為參數，寫入 MongoDB 之玩家資產欄位中。** 藉此確保前端應用具備最高規的靜態資源乘載力。

---

## 4. 索引機制 (Indexing) 的效能魔法

當資料庫之記錄 (Records) 累積突破百萬量級，傳統之全表掃描 (Full Table Scan) 查詢將導致 CPU 算力癱瘓。

- **運作原理**：**建立索引 (Create Index)** 之行為，即為針對特定高頻查詢欄位 (如 `UserEmail`) 於背景建立一棵佔用些許硬碟空間之 B-Tree 或雜湊結構。如同書籍末尾之參考頁碼索引，使資料庫引擎得以透過 O(log N) 的極低時間複雜度，精準跳轉至資料存取塊。
- **代價權衡**：索引雖能使檢索效能提升百餘倍，卻會折損資料寫入 (Insert/Update) 之速度並消耗額外的磁碟空間。因此，僅針對高查詢重度之欄位施行索引，是後端優化的必考題。

---

## ✅ 架構設計驗收標準

在跨入正式的後端開發前，請確保自身已深諳異構儲存之分流原則，並能向 AI 發佈具備工程嚴謹性之開發指令：

- [ ] 🤖 `我確知 MongoDB (NoSQL) 為承載長篇故事對白、數值庫與多變 JSON 實體設定檔之首選儲存庫。`
- [ ] 🤖 `我明白應將多媒體實體檔案掛載於 MinIO 等物件存儲集區 (S3)，並僅將其 CDN 網址字串存入資料庫內。`
- [ ] 🤖 `我明瞭 Redis 之職責為承載需高頻讀寫且不具絕對持久性要求之狀態快取與即時配對資料。`
- [ ] 🗣️ `我具備效能防護意識，於建構新的尋址欄位時，將主動要求 AI：「請務必為 Email 與 UserID 等高頻檢索欄位建立資料庫索引 (Indexes) 以弭平延遲瓶頸」。`
