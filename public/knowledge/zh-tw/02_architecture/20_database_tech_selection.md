# 20. 資料庫技術選型策略：SQL 與 NoSQL 陣營之決斷 (Database Selection)

> **類型**: 後端架構與儲存層科普  
> **重點**: 依據系統設計 (System Design) 原理，剖析關聯式資料庫 (SQL) 之嚴謹事務性與非關聯式 (NoSQL) 四大分支架構的特用場景，並導入 CAP 物理定理建立抉擇框架。

---

## 1. 關聯式架構 (SQL)：恪遵強一致性的資料莊園

### 核心特性與業界代表 (MySQL, PostgreSQL)

關聯式庫建構於絕對嚴謹的數學集合論與關連代數之上。

- **ACID 絕對保證**：提供原子性 (Atomicity)、一致性 (Consistency)、隔離性 (Isolation) 與持久性 (Durability) 之交易防護網。一筆跨帳戶之轉帳金流，絕無中途掛起導致帳實不符之可能。
- **強結構化鎖定 (Strict Schema)**：資料存入前，每一張資料表 (Table) 皆需受限於嚴格預定義之綱要約束（如：`UserId` 必須為整數且不可空值）。一旦上線運作，資料表結構變更 (Schema Migration) 通常伴隨高風險與維運停機窗口。

### 適用場域判定基準

1. **金融金流與生命關鍵系統**：對於數據誤差容忍度為絕對零之核心系統。
2. **多維度複雜關聯查詢**：當業務邏輯極度仰賴於數張龐大表單之間的即時交集、聯集或左遷查詢 (`JOIN`)，SQL 的優化器仍屬當前頂尖。

---

## 2. 非關聯式架構 (NoSQL)：具備多態擴充性之資料城市

「NoSQL」並非單一技術，而是涵蓋了摒棄傳統關聯框架之四大異構分支，旨在解決特定極端負載挑戰：

### ① 文件導向存儲 (Document Store) 👉 代表：MongoDB

此路線為 **Moyin 專案大範圍仰賴之主力資料庫**。

- **運行模式**：允許開發者直接將結構多變、無固定欄位配置 (Schema-less) 的巨大 JSON / BSON 樹狀物件序列化存入。
- **優勢**：在開發 AI 視覺小說或爬蟲應用時，由於故事分歧節點、NPC 全局狀態與技能樹之屬性日夕變動。MongoDB 提供了優越的開發敏捷性，容許應用程式端直接迭代資料模型，而免受後端綱要干預。

### ② 鍵值對存儲 (Key-Value Store) 👉 代表：Redis

- **運行模式**：極致簡約的 `Key -> Value` 定址空間。
- **優勢**：資料直接常駐於揮發性記憶體 (RAM) 中。專責做為高讀寫吞吐量之前置 **快取層 (Cache)**。常被用於會話維護 (Sessions)、全服即時排行榜、或高併發 API 之速率限流器 (Rate Limiter)。

### ③ 寬列存儲 (Wide-column Store) 👉 代表：Cassandra, HBase

- **運行模式**：捨棄傳統列儲存 (Row-based)，改採行式編碼。
- **場域**：專攻吞吐量極端狂暴之寫入密集型 (Write-heavy) 業務。如叫車平台全境百萬司機之秒級 GPS 時序座標上傳，或天文級之行為事件日誌掛載。

### ④ 圖學庫存儲 (Graph Database) 👉 代表：Neo4j

- **運行模式**：將資料儲存為「節點 (Nodes)」與「連線 (Edges)」。
- **場域**：專為社交網路之多階層擴散、詐欺偵測網路中查找「三層弱連結內之關聯度」而生。針對複雜之網路圖形遍歷演算法 (Graph Traversal Optimization) 進行深度特化。

---

## 3. 分散式系統之絕對鐵律：CAP 定理

在由多台伺服器集結運作之叢集架構中，工程師必須臣服於物理法則：**CAP 定理 (CAP Theorem)**。考量網路具有先天之斷聯風險，系統無法同時兼顧以下三項指標：

- **C (Consistency 一致性)**：無論查詢叢集內哪一個節點，永遠只能讀取到最新寫入的唯一真相結果。
- **A (Availability 可用性)**：每一筆存取請求皆保證在合理時限內取得非錯誤之系統回應（儘管該回應未必是最新同步之數據）。
- **P (Partition Tolerance 分區容錯)**：當叢集內部橫向節點之網路線路斷裂而形成資訊孤島 (Network Partition) 時，整體系統仍得持續對外營運。

**抉擇之代價：當「P」必定發生時只能選其一。**

- **CP 偏向系統 (如 MongoDB, HBase)**：於分裂狀態下，為避免產生平行時空導致數據錯亂，從屬節點會直接拒絕受理客戶端請求（犧牲 A 可用性）。
- **AP 偏向系統 (如 Cassandra, Amazon DynamoDB)**：於分裂狀態下，節點選擇不顧一切先接收使用者的寫入。這將導致不同網段內的客戶端看見不同的數據，直到網路恢復後再行合併，此為妥協後之「最終一致性 (Eventual Consistency)」。

---

## ✅ 架構決策與系統發包檢核點

針對架構選型進行系統決策或交由 AI 代理規劃元件時，請謹防用錯工具引發工程災難，並確實以不同之約束令其佈建資料層：

- [ ] 🗣️ 若面對**核心付費邏輯或商城模組**：「鑑於跨行結算之不可妥協性，請啟用 PostgreSQL 關聯式架構，並輔以 Redis 作為並行交易防腐快取。」
- [ ] 🗣️ 若面對**高動態性之 LLM 紀錄或爬蟲資料庫**：「考量到生成之 JSON 物件屬性具備極高波動風險，請將此微服務之持久層指向 MongoDB，發揮文件型儲存之擴容彈性。」
