# Claude Reflect 自動規則沉澱系統

> 類型：最佳實踐  
> 日期：2026-01-19

## 背景

- AI Agent 就像剛入職的菜鳥警員，容易重複犯同樣的錯誤，你糾正後下次又走回老路。
- 「只靠口頭警告讓模型記住」是極度不可靠的，我們需要「白紙黑字讓專案 (repo) 記住」。
- `claude-reflect` 就是一個能把你的「長官訓話」變成「可強制執行的警察通例 (版本化規則文件)」的神兵利器！

---

## 結論

- **核心理念**：把「口頭糾錯」變成「可強制執行的 ESLint 般規則」，直接寫入 CLAUDE.md / AGENTS.md / Skills。
- **生活比喻**：就像是警隊的內部調查科 (C&I)，負責收集長官對警員的投訴，然後每晚自動編成《警務守則第一條》，明天全警局強制遵守。
- **安裝方式**：Claude Code Marketplace 外掛，不是 pip 或 npm 套件。
- **工作原理**：捕獲 (記錄投訴) → 隊列 (收集案件) → 提煉 (總結守則) → 人工 Review (長官最後簽名) → 寫入 → Git 版本化。
- **適用場景**：命名規範、目錄結構、前端框架的特定寫法偏好、常見的踩雷點、固定的發布流程。
- **沉澱原則**：只沉澱「高頻發生 + 穩定不變 + 可驗證」的規則。
- **最佳節奏**：每日下班前花 30 秒跑 `/reflect` 結案，每週花 5 分鐘通盤整理。

---

## 安裝

```bash
# 1. 將市場加入系統
/plugin marketplace add bayramannakov/claude-reflect

# 2. 安裝外掛模組 (就像 npm install)
/plugin install claude-reflect@claude-reflect-marketplace

# 3. 重啟 Claude Code 啟動內部調查服務
```

---

## 核心指令速查

### 日常沉澱（每日下班結案）

| 指令                 | 用途                     | 前端 / TVB 比喻                               |
| -------------------- | ------------------------ | --------------------------------------------- |
| `/reflect --review`  | 查看待處理的學習信號     | 看今天警員收到了多少市民與長官的投訴單        |
| `/reflect --dry-run` | 預覽將改什麼，不實際寫入 | 虛擬執行 (看報告草稿，不正式發出 ESLint 規則) |
| `/reflect`           | 正式處理並寫入規則       | 長官正式簽名蓋章，將規則寫入《警務通例》      |

### 歷史掃描

| 指令                             | 用途                       |
| -------------------------------- | -------------------------- |
| `/reflect --scan-history`        | 掃描歷史 session，補撈規則 |
| `/reflect --include-tool-errors` | 把工具錯誤納入學習材料     |

### 規則維護

| 指令                 | 用途                                        |
| -------------------- | ------------------------------------------- |
| `/reflect --targets` | 查看目標文件                                |
| `/reflect --dedupe`  | 語義去重，合併相似規則 (消除冗長的重複守則) |

### Skill 發現與改進

| 指令                             | 用途                   |
| -------------------------------- | ---------------------- |
| `/reflect-skills`                | 從近 14 天發現重複模式 |
| `/reflect-skills --days 30`      | 指定時間範圍           |
| `/reflect-skills --all-projects` | 分析所有專案           |
| `/reflect-skills --dry-run`      | 預覽但不正式寫入       |

### 輔助指令

| 指令            | 用途             |
| --------------- | ---------------- |
| `/skip-reflect` | 跳過當前學習信號 |
| `/view-queue`   | 查看待處理隊列   |

---

## 工作原理 (自動化 ESLint 規則產生器)

```
用戶糾正 Agent 寫錯 Code → 背景自動收集這筆「投訴」到隊列 → 下班前執行 /reflect
     ↓
AI 內部調查科開始提煉成明確規則（Always/Never/Prefer/Checklist/Gotchas）
     ↓
人工長官 Review 確認 → 正式寫入 CLAUDE.md / AGENTS.md / Skill 文件
     ↓
Git Commit 版本化上傳 → 下次所有新進警員 (Agent) 直接讀取並遵守
```

### 規則寫入位置

| 規則類型   | 寫入位置                  |
| ---------- | ------------------------- |
| 全局規則   | `CLAUDE.md` / `AGENTS.md` |
| Skill 改進 | `.claude/commands/*.md`   |

### Skill Improvement Routing (精準打擊)

當你在使用某個 skill 時糾正 agent，投訴單會自動精準歸檔回該 skill 文件：

```
/deploy → Claude 忘記先跑測試 → 長官大罵糾正 → /reflect 偵測到與 /deploy 相關
→ 自動更新 .claude/commands/deploy.md 加入一條 ESLint 般的鐵律：「執行前必須先跑單元測試」
```

---

## 最佳實踐

### 每日下班前（30 秒結案）

```bash
/reflect --review
/reflect --dry-run
/reflect
```

### 每週整理（5 分鐘大掃除）

```bash
/reflect --scan-history
/reflect --dedupe
/reflect-skills --days 7
```

### 什麼值得沉澱為《警務通例》？

✅ **值得沉澱**：

- 糾正過 2 次以上的重複錯誤 (屢教不改的坑)。
- 反覆浪費 debug 時間的問題。
- 能寫成一句**強烈且可執行**規範的 (例如：永遠不要用 var)。

❌ **不值得沉澱**：

- 只有一次性的特殊 bug。
- 這週暫定方案，下週可能又會推翻的邏輯。
- 非常主觀、無法透過程式碼驗證的規則。

---

## Moyin 專案整合現狀

| 組件        | 位置                                                                    | 說明                                     |
| ----------- | ----------------------------------------------------------------------- | ---------------------------------------- |
| Workflow    | `.agent/workflows/reflect.md`                                           | Antigravity 專用的 `/reflect` 批次工作流 |
| Codex Skill | `.codex/skills/reflect/SKILL.md`                                        | Codex 專用的 reflect skill               |
| 配置文檔    | `workspace/knowledge/11.claude_code/11.4.11.4.skills_plugins_config.md` | 插件配置清單                             |
| 使用示例    | `workspace/knowledge/11.claude_code/11.3.11.3.skills_example.md`        | 指令速查                                 |

---

## 可操作清單 (警務處長待辦清單)

- [ ] 每天下班前執行 `/reflect --review` 確認投訴單 → `/reflect` 結案。
- [ ] 每週執行一次 `/reflect --dedupe` 清理過期或重複的警司命令。
- [ ] 每月執行一次 `/reflect-skills --days 30` 發現能被模組化的新 skill。
- [ ] 將 CLAUDE.md 的變更納入 Git commit，與所有人共享這份智慧。

---

## 參考

- [GitHub: BayramAnnakov/claude-reflect](https://github.com/BayramAnnakov/claude-reflect)
- [Anthropic: Claude Code 官方文檔](https://claude.ai/code)
- [DevelopersDigest 方法論](https://www.developersdigest.tech/)
