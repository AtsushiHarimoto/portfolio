# 43. 企業級 API 對接的藝術：Webhook 與冪等性防線 (Webhook & Idempotency)

> **類型**: API 架構與系統整合資安
> **重點**: 系統寫得再好，當你要對接像是 Stripe、Line Pay 或是 GitHub 這種外部大佛時，若不懂得 **「簽章防偽 (Signature)」** 與 **「冪等性 (Idempotency)」**，你的訂單不僅會被駭客駭爆，還會讓客戶重複扣款三次！

---

## 前言：不要瘋狂重整頁面，等人家打給你

當使用者在你的 Moyin 網站點擊「全家超商條碼繳費」。他拿著手機去超商嗶條碼。
超商什麼時候會通知你的伺服器收到錢了？可能是現在，也可能是兩天後。

- **輪詢 (Polling)**：你的伺服器每秒去問綠界金流一次：「他付錢了嗎？他付錢了嗎？」這很快就會被綠界封鎖你的 IP。
- **Webhook 原理**：你留一個 API 網址 (如 `https://moyin.com/api/webhook/stripe`) 給外部平台。你叫它回家等，**「等客戶付完錢，你（外部平台）再主動發一發 HTTP POST 刺我的這個網址，通知我。」** 這被稱為「反向 API (Reverse API)」。

看似優雅，但魔鬼全藏在細節裡。

---

## 1. 偽造的信差：Webhook 的防毒面具 (HMAC Signature)

任何人都知道你的 Webhook 網址是 `.../webhook/stripe`。
如果駭客寫了一個腳本，故意送出一段假裝是 Stripe 的 JSON：`{"status": "paid", "amount": 9999}` 瘋狂猛打你的 Webhook 網址，你的系統難道會傻傻地出貨 1000 次嗎？

### 🔒 帶血誓的簽章 (HMAC-SHA256)

外部平台在註冊 Webhook 時，會偷偷塞給你一把只有你們兩人才知道的「暗號密鑰 (Webhook Secret)」。

- Stripe 每次傳封包給你前，會用這把密鑰與資料，算出一串天下無敵的亂碼雜湊值（例如 `sig=abc123...`），並把它放在 HTTP Header 送過來。
- 你的 API 門口，**絕不能直接解析 JSON**！你必須用自己的密鑰也算一次。如果兩者對不上，代表這封信絕對是被駭客動過手腳，直接回傳 `401 Unauthorized` 踢走！

---

## 2. 致命的網路重試：冪等性 (Idempotency) 救贖

如果 Stripe 付款成功了，確實發 Webhook 打給你的伺服器。
此時你的伺服器正忙碌，花了 15 秒才處理完訂單，結果忘了回傳 `HTTP 200 OK` 給 Stripe。

- **重試地獄 (Retry Storm)**：Stripe 等不到你的 `200`，以為漏信了。於是它非常有敬業精神地，在 1 分鐘後、1 小時後，**「把這同一筆付款成功的通知，又死命地往你家炸了三次！」**
- **災難**：如果你寫的代碼是單純的 `balance = balance + 500`。恭喜，這個使用者只付了一次錢，他的餘額被加了四次。

### 🛡️ 冪等鍵 (Idempotency Key)

「冪等性」是所有分散式系統與 API 設計中最神聖的詞彙。
意思是：**「同一個操作，不管你執行一次，還是瘋狂點擊執行一萬次，結果都應該等於執行一次！」**

- **防禦手段**：Stripe 傳來的通知裡，一定會帶有一個獨一無二的 `event_id: "evt_345"` 作為冪等鍵。
- **Redis 守門員**：你的 API 第一行代碼，必須去 Redis 查這把鑰匙 (通常設定 24 小時過期 TTL)。
  - 如果沒看過這把鑰匙：把 `evt_345` 存入 Redis，然後安心出貨加餘額。
  - 如果 Redis 發現這把鑰匙**已經存在**：立刻知道這是 Stripe 誤會而重發的「重複攻擊」。你的程式必須大吼：_「我早就處理過了！直接回拋 HTTP 200 打發它走，絕對不允許再出一次貨！」_

---

## 💡 Vibecoding 工地監工發包訣竅

在使用 AI 開發整合如 LINE, Stripe 或是 PayPal 這種涉及金流生命財產的被動介面時：

> 🗣️ `「你在幫我寫這支負責接收 Stripe 或是藍新金流的 Webhook Controller 時，嚴禁不設防直接拿 Body 的 JSON 去改變訂單狀態！請你加上兩道金流國安級防線：一是利用 webhook_secret 並且用【HMAC-SHA256 校驗 Header 簽章】，沒有通過的請求拒絕受理。二是針對 payload 內的 event_id 導入 【Redis 的冪等性 (Idempotency) 鎖】，確保萬一上游金流因超時而發起 Retry Storm (重試風暴) 時，我們的系統絕對不會對客戶發生重複扣款或重複儲值！」`
