# Moyin Vibe Coding 工作流知識文檔（DESIGN → Tests → Code → Verify）

本文件梳理了一套「低成本、具可回溯性、且高度可驗證」之自動化代碼產製工作流，旨在完美適配當前之協作工具矩陣：

- 您與進階大語言模型（擔綱 Reviewer 角色）協同產出權威性的 `2.DESIGN.md`。
- 由 Codex 預先建構 E2E 測試骨架（初期允許為空殼測試，以定義驗收邊界）。
- 指派 Antigravity 依據設計規格精準落地實踐源碼。
- 最終以測試結果作為唯一之允收裁決標準；若未通過，則將錯誤日誌回饋予 Antigravity 執行收斂修復，直至全數通過（Green State）。

---

## 1. 目標與邊界約束

### 核心目標

- 將「概念發想 → 架構設計 → 代碼實裝 → 部署驗證」轉化為具備高度可複製性的自動化流水線。
- 顯著降低多工具與多模型角色之間的資訊同步成本。
- 強制導入「測試即交付標準」之理念，徹底根除「表面堪用、底層異常」之技術債。

### 絕對非目標 (Non-Goals)

- 拒絕未經審慎評估的「一次性全域大重構」。
- 不依賴高昂成本之模型執行長時間的無人守值代理任務（控管運算資源與預算額度）。
- 不與單一工具死綁（若 Codex 額度耗盡，可隨時抽換為其他 Reviewer 模型，確保流水線不中斷）。

---

## 2. 核心紀律（必須固化於規則檔中）

1. **唯一真理來源 (Single Source of Truth, SSOT)**：本梯次迭代之唯一依歸僅為 `2.DESIGN.md`。
2. **小步快跑 (Agile Iteration)**：單次任務流僅聚焦於單一功能節點或單一缺陷之閉環修復。
3. **測試先行 (Test-Driven Principle)**：視測試腳本為「發包合同」，實際代碼實裝為「履約交付」。
4. **綠燈放行 (Pass-to-Merge)**：唯有全數測試亮起綠燈 🟢，方得獲准合併至主線。
5. **絕對可回滾 (Rollback Ready)**：所有局部更動皆必須確保具備透過 `git revert` 無損退回上一穩定狀態之能力。
6. **拒絕隱性蔓延 (No Ghost Scopes)**：未明文寫入 DESIGN 之規格外需求，一律拒絕實作。

---

## 3. 角色職掌分配（當前協作配置）

### 3.1 架構策劃（Review 層）

**輸入：** 原始需求/問題描述、系統現狀、資源限制。  
**輸出：** 權威之 `2.DESIGN.md`（規格完整且具備高度可執行性）。

> Reviewer 創造之核心價值：將模糊曖昧之需求語言，精確轉譯為具備可測試、可編碼落地之工程合同。

### 3.2 測試防護（Design 層）

**執行擔當：** Codex  
**輸入：** 審閱通過之 `2.DESIGN.md`  
**輸出：** 測試規格檔 `tests/e2e/xxx.spec.ts`（允許初期僅具備測試骨架，但必須精確覆蓋核心執行路徑）。

> 先行確立測試骨架的意義在於：強制於代碼開工前，確立完成標準與客觀的驗收斷言點 (Assertions)。

### 3.3 代碼實裝（Coding 層）

**執行擔當：** Antigravity（調用具備成本效益之模型）  
**輸入：** 權威之 `2.DESIGN.md` + 先行建立之測試骨架（後者為強烈建議項目）。  
**輸出：** `src/xxx.vue` 或 `src/modules/...` 等最終實現代碼。

### 3.4 驗收裁決（Verify 層）

**執行動作：** 於本地終端觸發測試腳本。  
**裁決判定：**

- 🔴 驗證失敗：匯出錯誤崩潰日誌 (Stack Trace) 與失敗之測試用例描述，重新發包予 Antigravity 進行收斂修復。
- 🟢 驗證成功：授予合併 (Merge) 與發佈階段 (Release) 權限，並將成果記錄於狀態流轉文檔中。

---

## 4. 工具支援 (VibeDev CLI)

本工作流強烈建議搭配 `vibedev` CLI 工具以加速流水線之執行效率：

> **Note**: VibeDev 體系已全面重構為純 CLI 驅動工具，不再維護 Web UI 介面。

- **Pipeline 執行自動化**: 深度支援多階段流水線串接（Design -> Code -> Review）。
- **Health Check 探針**: 自動化查核 API 與微服務之健康狀態。
- **Prompt Templates 引擎**: 內核搭載標準化且經優化之提示詞模板庫。

---

## 5. 目錄映射與產物約定（最佳實踐範本）

- `docs/DESIGN/<feature>.md`：本次迭代專屬之設計合同 (SSOT)。
- `tests/e2e/<feature>.spec.ts`：針對該功能之 Playwright 測試腳本（請依據專案所採行之測試框架彈性調整）。
- `src/...`：被干涉或新建之功能源碼。
- `.agent/rules/core.md`：底層代理約束規則庫。
- （選擇性）`docs/PROJECT-STATE.md`：全域狀態總控中心（專供跨角色進行資訊同步與交接）。

> 若因專案規模考量不欲維護 `PROJECT-STATE.md`，底線是必須確保每次迭代任務皆存有對應之 DESIGN 規格文件，以保證技術決策具備溯源依據。

---

## 6. 流水線執行步驟（標準化作業流程 SOP）

### Step 0：孤立分支 (Branching)

- 命名規範：`feat/<feature_name>` 或 `fix/<bug_id>`。
- 鐵則：任何 AI 代理之更動均受限且隔離於新建分支之中，嚴禁直連主線開火。

### Step 1：架構策劃（Review）→ 產出權威 2.DESIGN.md

您與大語言模型 Reviewer 共同提煉並固化 `2.DESIGN.md`，該文檔內容必須達到「可測度極高、落實性極強」之標準。

**合規交付標準**：DESIGN 文件內必須明確記載：

- 核心功能邊界（必須清晰界定 `做什麼` 與 `絕對不做什麼`）。
- UI 視覺與人機交互（涵蓋觸發路由、控制按鈕與元件狀態機）。
- 數據流與狀態管控（如 Pinia store 配置、型別宣告、持久化策略等）。
- 商業邏輯運算規則（Flag 旗標、條件判定、例外錯誤處理與捕捉）。
- 客觀驗收標準（必須條列至少 3 項具體可被程式自動化測試之斷點）。
- 預估干涉與影響之實體檔案矩陣清單。

### Step 2：測試防禦（Design）→ 生成 E2E Spec 測試骨架

指派 Codex 研讀 DESIGN，並據此產製 `tests/e2e/<feature>.spec.ts`。

**合規交付標準**：

- 每項「客觀驗收標準」皆必須一對一映射至一個獨立的 `test(...)` 測試用例。
- 允許初期使用 `test.skip` 或置入空 `TODO` 預留占位，但「欲測試之業務邏輯目標」必須以人讀語言精確備註。

### Step 3：代碼實裝（Coding）→ 依據 DESIGN 藍圖精準落地

指派 Antigravity 研讀 DESIGN 規格（強制必備）與測試骨架（高度推薦），開始實裝 `src/...`。

**合規交付標準**：

- 嚴格自律，絕不越界修改 DESIGN 規格以外之範圍。
- 嚴禁於此階段夾帶發動大規模且未經授權之源碼重構。
- 單次迭代產出必須提交：實際異動之檔案清單 + 確認修改有效的本地驗證手段。

### Step 4：驗收裁決（Verify）→ 測試驅動閉環防線

於本地終端觸發 E2E 自動化測試網：

- 🔴 驗證失敗：打包收集崩潰日誌、Call Stack 堆疊、斷言錯誤訊息（若有 Console 錯誤及視覺破圖截圖更佳）→ 將錯誤包重新拋回 Antigravity 強制收斂。
- 🟢 驗證通過：予以簽核合併，並將成果登錄至版控紀錄與狀態總表。

---

## 7. 2.DESIGN.md 結構模板（強烈建議遵循此公版）

```markdown
# <Feature_Name> 架構設計規格 (DESIGN)

## 0. 摘要 (Summary)

- 核心落實目標 (Goal):
- 規格邊界排除 (Non-goals):

## 1. 使用者操作推演 (User Flow)

- 觸發入口 (Entry):
- 主要操作路徑 (Main actions):
- 邊緣與例外路徑 (Edge cases):

## 2. 介面視覺規格 (UI Spec)

- 干涉頁面與元件 (Page/Component):
- 狀態變異 (States):
- 載入中/異常/空集合畫面指示 (Loading/Error/Empty):

## 3. 數據與狀態流轉 (Data & State)

- 全域狀態鍵值 (Store keys):
- 型別與介面定義 (Types/interfaces):
- 持久化儲存策略 (Persistence, if any):

## 4. 商業運算邏輯 (Logic Rules)

- 條件分支規則清單 (Rule list, if/then):
- 表單與資料校驗規則 (Validation rules):

## 5. 牽連檔案矩陣 (Affected Files)

- src/...
- tests/e2e/...
- docs/...

## 6. 強制驗收標準基準線 (Acceptance Criteria, 必須絕對可測)

- AC1:
- AC2:
- AC3:

## 7. 最終放行查核表 (Verify Checklist)

- 自動化測試觸發指令 (Commands):
- 人工視覺核對步驟 (Manual checks):
```
