# 多 AI 代理協作框架設計

> **類型**: 技術決策 + 最佳實踐  
> **日期**: 2026-01-07  
> **來源**: 會話 - Multi-Agents 協作體系建立

---

## 摘要

建立 Claude（方案設計）、Codex（代碼審計）、Antigravity（執行工程師）三方協作體系。本文件定義了其協作流程、角色職責以及支撐此體系之底層技術架構（Skills 庫與同步機制）。

---

## 背景

傳統 AI 輔助開發模式中，單一 AI 承擔所有工作（涵蓋需求分析、代碼編寫至測試環節），此單點運作極易導致以下問題：

- **方向偏離**：未經架構確認即著手撰寫代碼，導致高機率的返工修復。
- **質量參差**：欠缺獨立之審計環節，工程規範的遵守程度前後不一。
- **難以追溯**：缺乏結構化文檔留存決策過程，導致知識斷層。

本框架遂透過分工明確的三方協作機制來徹底根除上述弊病。

---

## 詳細內容

### 角色定位（2026-01 更新）

#### Claude - 架構師 / 規劃統籌者

- **職責**：需求剖析、系統架構設計、複雜大型任務規劃、Code Review 審閱。
- **擅長**：自高階業務需求出發，拆解並設計出具備高度可執行性之技術藍圖；嚴格把關源碼品質。
- **輸出**：結構化方案文檔（包含目標定義、影響邊界、實作要綱、測試與驗收標準）、Review 報告。
- **適用場景**：新功能架構設計、重構策略擬定、底層技術選型、跨模塊協調與開發前置規劃。

#### Codex - 後端 / 數據庫工程師

- **職責**：後端商業邏輯開發、數據轉換處理、API 端點實作與維護、資料庫操作。
- **擅長**：精確處理後端與數據層之任務，確保邏輯閉環與資料結構一致性。
- **輸出**：後端源碼變更 + API 實作腳本 + 數據存取運算邏輯。
- **適用場景**：API 開發與對接、數據遷移與清洗 (Migration)、後端 Bug 修復、系統性能調優。

#### Antigravity - 日常督導 / Frontend UI 工程師

- **職責**：日常任務推演管理、UI 視覺與功能實現、前端工程開發、快速原型迭代。
- **擅長**：極速執行指令明確的任務工單，落實 UI/UX 設計理念，負責系統日常維保。
- **輸出**：前端源碼變更 + 封裝 UI 組件 + 測試成功證據日誌 + 任務收工報告。
- **適用場景**：UI 介面開發、前端 Bug 排錯修復、日常狀態維護、快速原型打樣 (Prototyping)。

### 協作流程

#### 模式 1：需求驅動（Claude → Antigravity）

```
使用者需求輸入
  ↓
Claude 產製技術方案藍圖 → 歸檔至 workspace/plans/PLAN_*.md
  ↓
Antigravity 讀取藍圖 → 再次確認邊界 (Confirm Scope) → 執行編碼 → 回報狀態 → 版本提交
```

**適用場景**：新增模組功能、代碼架構重構、前沿技術探索。

#### 模式 2：審計驅動（Codex → Antigravity）

```
系統爆發代碼品質警報或技術債
  ↓
Codex 發動全域審計 → 生成修復方案與補丁建議 → 歸檔至 workspace/plans/PLAN_CODEX_*.md
  ↓
Antigravity 讀取修復單 → 執行違規代碼修復 → 本地驗證測試 → 回報狀態 → 版本提交
```

**適用場景**：編碼規範標準化作業、技術債全面清理、系統安全漏洞審查。

#### 模式 3：混合式高防護協作

```
Claude 產製初版設計方案 → Antigravity 實作落地 → Codex 執行後續品質審計 →
(若發現潛在問題) Codex 提出修復方案單 → Antigravity 執行二次修復 → 測試通過結案
```

**適用場景**：關鍵核心功能上線、具備高度資安性或品質保證需求之大型專案。

### 統一方案格式 (Standardized Plan Format)

所有經由 Claude 或 Codex 提出的設計或修復方案，均須強制遵循此 4 段式結構：

```markdown
# [任務標題]

## 1. 核心目標

以精煉之一句話闡明日的與預期成效。

## 2. 影響範疇 (Scope)

- 預計修改之檔案列表：[完整絕對路徑清單]
- 預計新增之檔案列表：[完整絕對路徑清單]

## 3. 實作要綱 (Implementation Details)

闡述關鍵技術突破點 + 原型範例代碼 (Claude 視角)
或
點出具體違規事項 + 源碼翻新前後對比 (Codex 視角)

## 4. 驗收標準 (Acceptance Criteria)

- [ ] 可逐條核對推進之完成清單
```

---

## 技術架構與 Skills 體系

本協作框架之底層實作乃基於 **SSOT (Single Source of Truth, 絕對真理來源)** 與 **智能上下文感測 (Smart Context)** 兩大指導原則。

### 1. 技能庫基礎設計 (Skill Library)

所有 AI 之核心能力皆唯一宣告於 `.agent/skills/` 中，作為全域共用之絕對真理來源。

- **實體目錄結構**:
  ```text
  .agent/skills/
  ├── feature-dev/        # 標準開發協作流程 (Doc-Plan-Act 循環)
  ├── bg-standard/        # Bug 溯源排查流程
  ├── sync-skills/        # 自動化技能同步程式
  └── ...
  ```
- **`.claude/skills/`**: 架構師專用之同步副本視角 (Sync Target)。
- **`.codex/skills/`**: 審計師/後端專用之同步副本視角 (Sync Target)。

### 2. 同步連動機制 (Sync Mechanism)

藉由 `sync-skills` 自動化腳本確保三方 Agent 具備對稱的能力定義與約束。

- **流轉路徑**: 源碼基石 `.agent/skills` → 透過工具 `Copy` 散佈 → `.codex/skills` 與 `.claude/skills`
- **最終目的**: 達成單點更新、多點生效。當開發團隊修訂底層規範（例如更新 Git Commit 格式）時，所有 AI 代理將自動且強制刷新其內建認知與操作守則。

### 3. 動態智能規則掛載 (Smart Context Loading)

為最大化優化 Token 載入損耗，系統將依據 `AGENTS.md` 所賦予之任務邊界，偵測當下之 **SCOPE** 情境並動態掛載對應 Context：

| 目標情境 SCOPE  | 自動掛載之規則矩陣            | 策略目的                                                                 |
| :-------------- | :---------------------------- | :----------------------------------------------------------------------- |
| **API Project** | Core + TS Rules               | 強制專注於商業邏輯推演與型別安全 (Type Safety)，嚴格阻絕 UI/CSS 雜訊干擾 |
| **Frontend**    | Core + TS + Vue + Style Rules | 保障視覺 Token 之絕對一致性與前端元件設計規範                            |
| **QA Project**  | Core + Testing Rules          | 專注於測試案例之邊界條件防護與品質驗證標準                               |

### 4. Agent 角色矩陣總覽（2026-01 更新配置）

| 代理代碼        | 內部職能代號  | 職責範圍 (Responsibilities)             | 標準輸出物 (Deliverables)      | 適用任務場景                              |
| :-------------- | :------------ | :-------------------------------------- | :----------------------------- | :---------------------------------------- |
| **Claude**      | **Architect** | 高階架構規劃、複雜任務調度、深度 Review | 架構方案文檔、質檢 Review 報告 | 新模組設計、專案重構、技術架構選型        |
| **Codex**       | **Backend**   | 實務後端邏輯、數據遷移運算、API 建置    | 後端執行代碼、API 接口實踐     | API 端點開發、巨量數據處理、後端 Bug 排除 |
| **Antigravity** | **Frontend**  | 前線日常管理、UI 操作介面實作、前端落地 | 前端渲染代碼、封裝 UI 互動組件 | GUI 介面開發、維運任務管理、極速原型打樣  |

---

## 代碼與工具操作範例

### 建立 Skills 腳本配置

**Claude 專屬技能** (`.claude/skills/handoff/SKILL.md`)：

```markdown
---
name: handoff
description: "Claude 負責產製方案架構藍圖，Antigravity 負責接獲工單並執行後續代碼實踐。"
---

# Handoff - Claude → Antigravity 跨代理協作

...
```

**Codex 專屬技能** (`.codex/skills/handoff/SKILL.md`)：

```markdown
---
name: handoff
description: "Codex 執行全域審計並產製缺陷修復方案，交予 Antigravity 實裝。"
---

# Handoff - Codex → Antigravity 跨代理協作

...
```

### 構建自動化 Workflow

**Antigravity 執行端 Workflow** (`.agent/workflows/claude_task.md`)：

```markdown
---
description: 專門接收來自 Claude 或 Codex 的 handoff 架構方案，並據此執行無偏離之實裝任務。
---

# Workflow: Claude Task Handoff

## 1. 讀取核心方案 (Read Plan)

## 2. 確認變更邊界 (Confirm Scope)

## 3. 確保落實實裝 (Implementation)

## 4. 回報執行成果 (Report Status)
```

---

## 情境適配判定（2026-01 更新）

### 判斷何時調用 Claude？

- ✅ 面臨需從零設計新功能，或剖析高複雜度架構時
- ✅ 需要尋求跨語言或跨系統之技術選型評估計畫時
- ✅ 系統面臨結構性老化，需要全局重構戰略藍圖時
- ✅ 關鍵模組上線前，需要執行無死角之 Code Review 時
- ✅ 遭遇跨多重模塊之大型史詩任務 (Epic) 的拆分與規劃時

### 判斷何時調用 Codex？

- ✅ 建置後端服務的 API 路由與端點邏輯時
- ✅ 撰寫異步數據資料清洗與整理邏輯時
- ✅ 編寫涉及 SQL 增刪改查或資料遷移 (Migration) 之腳本時
- ✅ 排查與修復潛藏於後端服務的資料競爭 (Data Race) 或死結 (Deadlock) Bug 時
- ✅ 試圖最佳化後端系統效能以降低延遲與提升吞吐量時

### 判斷何時調用 Antigravity？

- ✅ 基於設計稿打造精銳流暢的 UI/UX 操作功能時
- ✅ 修補崩壞的 DOM 結構或破圖失效之 CSS 前端 Bug 時
- ✅ 管理並推進日常堆積之瑣碎例行性開發任務時
- ✅ 需要用最快速度打造一組可用之 MVP 快速原型以供驗證時
- ✅ 拆解並封裝具備高度重用價值 (Reusable) 之 Vue 前端元件組建時

---

## 相關知識庫索引

- [多 Agent 協作全景說明文檔](../../workspace/MULTI_AGENTS_COLLABORATION.md)
- [Claude 移交流程 Skill](../../.claude/skills/handoff/SKILL.md)
- [Codex 移交流程 Skill](../../.codex/skills/handoff/SKILL.md)
- [Antigravity 任務接收 Workflow](../../.agent/workflows/claude_task.md)

---

## 核心防護機制與注意事項

- ⚠️ **方案結構絕對制式化**：提交前務必確認文件必然包含目標 (Objective)、範圍 (Scope)、重點 (Impl Details) 與標準 (Acceptance Criteria) 四區塊。
- ⚠️ **路徑標示絕對清晰化**：嚴禁使用相對模糊路徑，必須引用自專案根目錄起算之絕對路徑字串。
- ⚠️ **驗收標準絕對可測化**：排除所有諸如「提升效能」之感性描述，必須替換為「點擊登入按鈕後 API 於 200ms 內回傳 200 OK」等客觀量化測試節點。
- ⚠️ **任務流向絕對單一化**：對 Antigravity 而言，不論上游指令為 Claude 抑或 Codex 所發，一律透過統一管道 `/claude_task` 介入接收與消化。

---

## 導入體系之最終效益盤點

| 優勢面向           | 具體價值防護措施                                                                   |
| ------------------ | ---------------------------------------------------------------------------------- |
| **職能絕對切割**   | 各安其位，徹底斬斷單一全能 AI 大而不當、發散運算之災難。                           |
| **收歛方向焦距**   | 以文檔方案充當緩衝閘門，藉由使用者確認後方可放行編碼，確保不致做白工。             |
| **知識溯往回放**   | 方案歷程皆化為實體 `.md` 存證，於後續排錯或新人交接時立即可供回溯與追究。          |
| **作業範本重製**   | 高度抽象化之規劃文件可封存復用，當面對極度相似之任務特徵時，可直接微調即刻執行。   |
| **自動化品質屏障** | Codex 負責以代碼審計官之身份強力介入最後防線，保障最終推送庫之代碼純淨度與合規性。 |

---

_本文檔由模組化維護系統依據紀律規範自動生成_
