# 03.4. Git 分支合併拓撲最佳實踐 (Merge Best Practices)

> **類型**: 版控策略與工作流規範  
> **重點**: 指出預設的 Fast-Forward 合併模式對專案歷史具備破壞性，並強制推行 `--no-ff` (No Fast-Forward) 帶來的歷史回溯與災難還原價值。

---

## 摘要

Git 作為分散式版控系統的基石，其預設的快進式合併 (Fast-Forward) 會將分支節點全數抹平融入主幹。此舉將永遠丟失「該功能分支何時切出、哪些 Commit 隸屬於該次系統重構」之脈絡。
Moyin 專案強制推廣 `--no-ff` 之合併參數，旨在維護系統演進歷史的「樹狀結構完整性」，確保每一次特性交付 (Feature Release) 具備原子性，且能一鍵全域退回。

---

## 1. 兩大合併拓撲演算法對比

### ❌ 快進合併 (Fast-Forward)：預設陷阱

當您沒有給定任何約束參數，直接敲擊 `git merge feature-branch` 時：

- **運作模式**：若目標分支 (如 `dev`) 在這段時間無任何干擾提交，Git 為了省事，會直接將 `dev` 指標順著時間軸推移至 `feature-branch` 之末端。
- **致命缺點**：
  1. 這是一條完全扁平化的「一條龍死胡同」。
  2. 數個月後進行考古時，歷史紀錄無從分辨：原先那 18 次零散修復的 Commit 是在何種脈絡下被整合進來的。
  3. 若該 Feature 發生了無比嚴重的記憶體洩漏需緊急退版，在無明確分岔點的狀況下，工程師難以確認退除的範疇邊界。

### ✅ 實體節點合併 (No Fast-Forward)：標準作業程序

若遵循守則，一律添加參數：`git merge --no-ff feature-branch -m "Merge feature: XXX"`

- **運作模式**：無論線圖時間軸推進情形為何，Git 皆會強迫性地結算一次，並產生一顆極為顯眼的**「合併節點 (Merge Commit)」**。
- **不可取代之優勢**：
  1. **維持有機的樹狀拓撲**：這顆交會節點就像膠囊，忠實包覆住這個 Feature 開發期間所發生過的所有分岔與 Commit 軌跡。
  2. **完美的原子級退版 (Rollback)**：當面臨重大災難，僅需針對這顆唯一標的 `Merge Commit` 執行 `git revert`，該 Feature 相關之成千上萬條代碼改動便會齊頭斬斷，優雅還原。

---

## 2. 嚴謹的系統合併標準工作流 (SOP)

為確保 `dev` 與 `main` 主幹之穩定，任何功能分支的匯入皆應嚴格執行以下六步檢核手續：

#### 步驟 1：無塵室檢測 (Workspace Audit)

確認當前工作目錄無干擾性之殘留修改：

```bash
git status
# 必須目視確認輸出顯示 "working tree clean"
```

#### 步驟 2：歷史與統計巡檢 (Diff Statistics)

盲目合併是大忌。管理者應預覽即將湧入之巨量變動。

```bash
# 條列出兩個分支之間的摘要差異節點
git log dev..feature-branch --oneline

# 概覽將被竄改之文件列表及增刪行數比例
git diff --stat dev feature-branch
```

#### 步驟 3：切換與同步基底 (Base Synchronization)

```bash
git checkout dev
# 導入遠端最新變革，將環境衝突發生率降至最低
git pull origin dev
```

#### 步驟 4：執行封裝式合併 (Enforcing Non-Fast-Forward)

```bash
# 務求在 -m 引數內清楚宣告該 Feature 之業務價值
git merge --no-ff feature-branch -m "Merge feature/auth-system: 升級至 JWT 雙重認證架構"
```

#### 步驟 5：結果上報推送 (Push)

```bash
git push origin dev
# 檢查遠端推入之最新三條圖譜
git log --oneline -n 3
```

#### 步驟 6：分支垃圾清運 (Branch Garbage Collection)

已合併之 Feature 其指標毫無存在價值，應果斷剪除以釋放視覺空間。

```bash
# 解除本機指標鎖定
git branch -d feature-branch
# 消除遠端孤兒追蹤指標
git push origin --delete feature-branch
```

---

## 3. 緊急醫療救援：撤回一整包災難性代碼

這便是 `--no-ff` 保存歷史軌跡的終極價值體現。當某個剛併入的 Feature 導致伺服器無限迴圈時：

```bash
# 1. 調閱並指認肇事之「合併節點 (Merge Commit)」的 Hash 碼
git log --oneline --merges

# 2. 發起逆向相消工程 (Revert)
# 注意：-m 1 是告知 Git，保留當初被合併進去的主幹 (Mainline) 為基礎，抵銷新接入的分支影響。
git revert -m 1 <肇事之-merge-commit-hash>
```

此舉絕不毀損既有之 Commit 時間軸，但產生的新提交將精確抽離該次 Feature 引入之所有變數，讓專案在數秒內重見光明。
