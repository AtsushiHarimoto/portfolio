# 03.2. è·¨å¹³å°è‡ªå‹•åŒ–åŸºç¤å»ºè¨­å®‰è£è…³æœ¬ (Cross-Platform Install Scripts)

> **é¡å‹**: æœ€ä½³å¯¦è¸èˆ‡ç¶­é‹å·¥ç¨‹  
> **é‡é»**: é—¡è¿°å¦‚ä½•æ’°å¯«é«˜å“è³ªã€å…·å‚™å®¹éŒ¯åŠ›ä¸”å°ä½¿ç”¨è€…å‹å–„ä¹‹è‡ªå‹•åŒ–å®‰è£è…³æœ¬ (`install.sh` èˆ‡ `install.ps1`)ï¼Œä»¥å¤§å¹…å¼­å¹³ä¸åŒä½œæ¥­ç³»çµ±é–“çš„ç’°å¢ƒå»ºç½®è½å·®ã€‚

---

## æ‘˜è¦

é–‹æºå°ˆæ¡ˆèˆ‡ä¼æ¥­å…§éƒ¨å·¥å…·å¸¸é¢è‡¨åš´å³»ä¹‹è½åœ°é˜»åŠ›ï¼šã€Œç›®æ¨™æ©Ÿå™¨ç’°å¢ƒå„ç•° (macOS/Linux/Windows)ã€ã€‚
ç¹è¤‡çš„æ‰‹å‹•ç·¨è­¯ä¾è³´ã€å·¥å…·éˆç¼ºå¤±ï¼Œå¸¸å°è‡´æ–°é€²é–‹ç™¼è€…åœ¨ã€Œç’°å¢ƒé…ç½®éšæ®µ (Environment Setup)ã€å³å‘Šæ”¾æ£„ã€‚
é€éç²¾å¿ƒè¨­è¨ˆä¹‹é›™å¹³å°è‡ªå‹•åŒ–è…³æœ¬ï¼Œèƒ½å°‡è€—æ™‚æ•¸å°æ™‚çš„å•é¡Œæ’æŸ¥ï¼Œå£“ç¸®ç‚ºå–®ä¸€æŒ‡ä»¤çš„ä¸€éµéƒ¨ç½²ã€‚ç‚º Rust æˆ– Python å°ˆæ¡ˆæ‰“é€ ç„¡ç—•é«”é©—ã€‚

---

## è…³æœ¬è¨­è¨ˆä¹‹æ ¸å¿ƒæº–å‰‡ (Design Principles)

ä¸€ä»½ç¨±è·çš„ä¼æ¥­ç´šå®‰è£è…³æœ¬ï¼Œæ‡‰ç•¶è½å¯¦ä»¥ä¸‹é˜²å‘†æ©Ÿåˆ¶ï¼š

1. **å†ªç­‰æ€§æª¢æ¸¬ (Idempotent Detection)**ï¼šè…³æœ¬åŸ·è¡Œå‰å¿…é ˆæ™ºæ…§è¼ªè©¢ç³»çµ±è·¯å¾‘ (PATH) èˆ‡ç¾æœ‰ç‰ˆæœ¬ã€‚å¦‚å·²å®‰è£æŒ‡å®šå·¥å…·ï¼Œå‰‡è·³éè©²æ­¥é©Ÿï¼Œçµ•ä¸å¯å¼•ç™¼é‡è¤‡å®‰è£å°è‡´ç³»çµ±æ±¡æŸ“ã€‚
2. **é˜²ç¦¦æ€§ç¨‹å¼è¨­è¨ˆ (Defensive Programming)**ï¼šé­é‡ä»»ä½•ä¸å¯é€†éŒ¯èª¤ï¼ˆå¦‚ä¸‹è¼‰æ–·ç·šã€ç·¨è­¯å¤±æ•—ï¼‰æ™‚ï¼Œéœ€å…·å‚™ `Fail-Fast` ç‰¹æ€§ï¼Œç«‹å³ä¸­æ–·åŸ·è¡Œç·’ï¼Œåš´ç¦ç³»çµ±å¸¶ç—…é€²å…¥ä¸‹ä¸€éšæ®µã€‚
3. **æ˜ç¢ºä¹‹è¦–è¦ºæç¤º (Visual Feedback)**ï¼šæ‹‹æ£„å–®èª¿çš„é»‘ç™½è¼¸å‡ºã€‚å¤§é‡å¼•é€² ANSI é¡è‰²ç¢¼æˆ– PowerShell çš„è‰²å½©æ¸²æŸ“ï¼Œæ¸…æ¥šç•Œå®šã€æ“ä½œä¿¡æ¯ (è—)ã€ã€ã€è­¦å‘Š (é»ƒ)ã€èˆ‡ã€ç½é›£/éŒ¯èª¤ (ç´…)ã€ã€‚
4. **æ¼¸é€²å¼äº’å‹• (Interactive Confirmation)**ï¼šç•¶æ¶‰åŠé«˜æ¬Šé™å¯«å…¥æˆ–ä¸‹è¼‰æ•¸ GB ä¹‹ç·¨è­¯éˆæ™‚ï¼Œæ‡‰è¨­è¨ˆäºŒé¸ä¸€çš„é˜²å‘†ç¢ºèªæç¤ºï¼Œåˆ‡å¿Œæœªç¶“æˆæ¬Šä¹‹éœé»˜å¼·åˆ¶æ›´æ”¹ã€‚

---

## ç¬¬ä¸€ç« ï¼šmacOS/Linux ç’°å¢ƒå¯¦ä½œ (`install.sh`)

å¯¦ä½œæ–¼ Bash ç’°å¢ƒä¹‹è…³æœ¬ï¼Œæœ€æ ¸å¿ƒçš„é˜²è­·ç¶²ç‚ºé¦–è¡Œå®£å‘Šä¹‹ `set -e`ï¼Œç¢ºä¿å…¶ä¸æœƒå› å¿½ç•¥éŒ¯èª¤è€Œè¡ç”Ÿç³»çµ±ç½é›£ã€‚

```bash
#!/bin/bash
# ã€é˜²ç¦¦æ©Ÿåˆ¶ã€‘ä¸€ç¶“æ‹‹å‡ºéé›¶å›å‚³å€¼ï¼Œå³åˆ»è§¸ç™¼ä¸­æ­¢
set -e

# ã€è¦–è¦ºæ¸²æŸ“å¸¸æ•¸ã€‘
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; NC='\033[0m'

# ã€è¼”åŠ©åˆ—å°å‡½æ•¸ã€‘
print_success() { echo -e "${GREEN}âœ… $1${NC}"; }
print_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }

# ã€å†ªç­‰æ€§æª¢æ¸¬ã€‘
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

check_rust_toolchain() {
    echo ">> æ­£åœ¨æª¢æ ¸ Rust é‹è¡Œæ™‚ç’°å¢ƒ..."
    if command_exists rustc && command_exists cargo; then
        # æå–ç¾æœ‰ç‰ˆæœ¬è™Ÿä»¥ä¾›é©—è­‰
        RUST_VERSION=$(rustc --version | awk '{print $2}')
        print_success "Rust å·²å®‰è£ï¼š$RUST_VERSION"
        return 0
    else
        print_warning "åµæ¸¬ä¸åˆ° rustc/cargo ç·¨è­¯éˆã€‚"
        return 1
    fi
}

install_rust_interactive() {
    read -p "å³å°‡è¯ç¶²æ‹‰å–å®˜æ–¹å®‰è£åŒ…ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ(y/n): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        # åˆ·æ–°ç•¶å‰çµ‚ç«¯æ©Ÿè¨˜æ†¶é«”ç’°å¢ƒ
        source "$HOME/.cargo/env"
        print_success "Rust å»ºç½®å®Œæˆã€‚"
    fi
}

# ã€ä¸»åŸ·è¡Œåºã€‘
main() {
    if ! check_rust_toolchain; then
        install_rust_interactive
    fi
    # åŸ·è¡Œå°ˆæ¡ˆç·¨è­¯æŒ‡ä»¤
    cargo build --release
}

main
```

---

## ç¬¬äºŒç« ï¼šWindows ç’°å¢ƒå¯¦ä½œ (`install.ps1`)

é‡å° Windows çš„ PowerShell ç”Ÿæ…‹ç³»ï¼Œå…¶æŒ‡ä»¤æ›´å…·å‚™ç‰©ä»¶å°å‘ (Object-Oriented) ç‰¹æ€§ï¼ŒéŒ¯èª¤æ””æˆªæ©Ÿåˆ¶å‰‡ä¾é  `$ErrorActionPreference` å¸¸æ•¸é€²è¡Œé‰—åˆ¶ã€‚

```powershell
# ã€é˜²ç¦¦æ©Ÿåˆ¶ã€‘åš´æ ¼çš„ä¾‹å¤–æ•æ‰æ‹‹å‡º
$ErrorActionPreference = "Stop"

# ã€è¦–è¦ºæ¸²æŸ“å‡½æ•¸ã€‘
function Write-Success {
    param([string]$Message)
    Write-Host "âœ… $Message" -ForegroundColor Green
}

function Write-Info {
    param([string]$Message)
    Write-Host ">> $Message" -ForegroundColor Cyan
}

# ã€å†ªç­‰æ€§æª¢æ¸¬ã€‘
function Test-CommandExists {
    param([string]$Command)
    try {
        if (Get-Command $Command -ErrorAction Stop) {
            return $true
        }
    } catch {
        return $false
    }
}

function Test-And-Install-Rust {
    Write-Info "æ­£åœ¨æª¢æ ¸ Rust é‹è¡Œæ™‚ç’°å¢ƒ..."

    if ((Test-CommandExists "rustc") -and (Test-CommandExists "cargo")) {
        $rustVersion = (rustc --version).Split(' ')[1]
        Write-Success "Rust å‚™å¦¥ï¼Œç•¶å‰ç‰ˆæœ¬ï¼š$rustVersion"
    } else {
        Write-Host "âš ï¸ Rust æœªå®‰è£ï¼Œå°‡è‡ªå‹•å•Ÿå‹•ç¶²è·¯ä½ˆç½²ç¨‹åº..." -ForegroundColor Yellow
        $rustupUrl = "https://win.rustup.rs/x86_64"
        $rustupPath = "$env:TEMP\rustup-init.exe"

        # å–šèµ·ç´”æ·¨èƒŒæ™¯ä¸‹è¼‰èˆ‡å®‰è£ç¨‹åº
        Invoke-WebRequest -Uri $rustupUrl -OutFile $rustupPath
        Start-Process -FilePath $rustupPath -Wait -NoNewWindow

        # ã€é—œéµæŠ€è¡“ã€‘ç›´æ¥åˆ·æ–° PowerShell ä¹‹ç³»çµ± PATHï¼Œå…çµ•é‡æ–°é–‹æ©Ÿä¹‹è‹¦
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
    }
}

# ã€ä¸»åŸ·è¡Œåºèˆ‡ä¾‹å¤–é˜²è­·ã€‘
try {
    Test-And-Install-Rust
    # åŸ·è¡Œå°ˆæ¡ˆç·¨è­¯æŒ‡ä»¤
    cargo build --release
} catch {
    Write-Host "ğŸš§ å®‰è£é€”ä¸­é­é€¢è‡´å‘½éŒ¯èª¤ï¼Œé€²ç¨‹å·²å¼·åˆ¶ä½œå»¢ï¼š$_" -ForegroundColor Red
    exit 1
}
```

---

## ç¬¬ä¸‰ç« ï¼šå¯¦å‹™é¿é›·æŒ‡å—

é–‹ç™¼æ­¤é¡è…³æœ¬æ™‚æœ€æ˜“éºæ¼ä¹‹æ­»è§’ï¼š

1. **ç’°å¢ƒè®Šæ•¸æ®˜ç›¸ (Environment Variable Ghosting)**ï¼š
   å‰›é€éæŒ‡ä»¤å®‰è£çš„è»Ÿé«”ï¼ˆå¦‚ Node.js æˆ– Rustï¼‰ï¼Œé›–ç„¶å·²ç¶“å¯«å…¥ç¡¬ç¢Ÿï¼Œä½†**ç›®å‰çš„çµ‚ç«¯æ©Ÿè¦–çª—ä¸¦æœªæ„è­˜åˆ°è·¯å¾‘çš„æ›´æ–°**ã€‚è‹¥ä¸æ’å…¥åˆ·æ–°æŒ‡ä»¤ï¼ˆå¦‚ Bash çš„ `source` æˆ– PS çš„é‡æ§‹ `$env:Path`ï¼‰ï¼Œä¸‹ä¸€æ­¥çš„å‘¼å«å°‡ç›´æ¥å ±éŒ¯ã€‚
2. **æ¬Šé™é™·é˜± (Execution Policies)**ï¼š
   é–‹ç™¼çµ¦ Windows ä¹‹è…³æœ¬ï¼Œéœ€èªçŸ¥åˆ°ç³»çµ±é è¨­å¯èƒ½é˜»æ“‹æœªç°½ç½²ä¹‹ `.ps1` æª”æ¡ˆé‹è¡Œã€‚å¼•å°æ–‡ä»¶å…§å‹™å¿…è«‹ä½¿ç”¨è€…å…ˆåŸ·è¡Œï¼š
   `Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser`ã€‚
3. **ç„¡äººå€¼å®ˆè¨­è¨ˆ (Unattended Mode)**ï¼š
   è‹¥è…³æœ¬æ—¨åœ¨ä¾› CI/CD æµæ°´ç·šèª¿ç”¨ï¼ˆå¦‚ GitHub Actionsï¼‰ï¼Œäº’å‹•å¼æç¤º (read/prompt) å°‡å°è‡´ä¼ºæœå™¨ç„¡é™æœŸæ‡¸æ› (Hang)ã€‚æ‡‰ç‚ºè…³æœ¬è¨­è¨ˆ `--unattended` æˆ– `-y` çš„åƒæ•¸é–˜é“ä»¥ç¹éäººå·¥ç¢ºèªã€‚
