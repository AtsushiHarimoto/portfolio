# 03.1. Cloudflare Tunnel 臨時公網部署

> **類型**: 工具技巧與部署實務  
> **重點**: 闡述如何利用 Cloudflare Tunnel 將本機開發伺服器安全、快速地穿透內網暴露至公網，以利臨時測試、遠端展示與 Webhook 介接。

---

## 摘要

開發過程中，我們常面臨需要將 `localhost` 服務臨時對外開放的情境。傳統的連接埠轉發 (Port Forwarding) 或虛擬私人網路 (VPN) 設定繁瑣，且存在資安風險。
Cloudflare Tunnel 提供了免配防火牆、免申請公網 IP 的優雅解法，透過單一指令即可核發具備 HTTPS 加密之臨時公網網域。

---

## 第一章：安裝與基礎啟動

### 1.1 安裝 Cloudflared 守護行程

**macOS (透過 Homebrew)**：

```bash
brew install cloudflared
```

**Windows / Linux 等其他作業系統**：
請參閱 [Cloudflare 官方安裝指南](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/) 下載對應之二進位檔。

### 1.2 建立臨時隧道 (Quick Tunnel)

無須綁定 Cloudflare 帳號，直接指定欲暴露之本機連接埠：

```bash
# 暴露本機端之 5173 連接埠 (例：Vite 預設位址)
cloudflared tunnel --url http://localhost:5173
```

**終端機預期輸出**：

```text
2026-01-06T02:30:00Z INF +--------------------------------------------------------------------------------------------+
2026-01-06T02:30:00Z INF |  Your quick Tunnel has been created! Visit it at (it may take some time to be reachable):  |
2026-01-06T02:30:00Z INF |  https://random-subdomain-1234.trycloudflare.com                                           |
2026-01-06T02:30:00Z INF +--------------------------------------------------------------------------------------------+
```

獲取該 `*.trycloudflare.com` 網址後，即可供外網存取。

---

## 第二章：主流框架之 Host 配置調整

許多現代前端伺服器受限於 CORS 或 Host 驗證機制，預設會阻擋非 `localhost` 來源之請求。為確保 Tunnel 正常運作，必須針對框架解除限制。

### 2.1 Vite 專案配置 (如：Moyin 遊戲前端)

Vite 預設封鎖外部 Host，必須修改 `vite.config.js`：

**選項 A：全面放行 (開發環境便利用)**

```javascript
export default defineConfig({
  server: {
    host: "0.0.0.0",
    allowedHosts: true, // 允許所有來源 Header
  },
});
```

**選項 B：精確配對 (安全性佳)**

```javascript
export default defineConfig({
  server: {
    host: "0.0.0.0",
    allowedHosts: [
      ".trycloudflare.com", // 僅放行 Cloudflare 臨時網域
    ],
  },
});
```

### 2.2 Vue CLI & Webpack Dev Server

同樣必須修改根設定檔 (`vue.config.js` 或 `webpack.config.js`)：

```javascript
module.exports = {
  devServer: {
    allowedHosts: "all",
  },
};
```

### 2.3 FastAPI 與中介層防護 (如：Moyin 路由閘道)

**FastAPI / Uvicorn 預設為完全通透**，只要啟動時綁定 `0.0.0.0`，即無需額外配置即可被 Tunnel 存取。

```bash
# 啟動 FastAPI，綁定所有網卡
uvicorn main:app --host 0.0.0.0 --port 8001
```

**生產環境之縱深防禦 (Optional)**：
若於實際雲端主機佈署，建議掛載 `TrustedHostMiddleware` 限縮存取權限：

```python
from fastapi.middleware.trustedhost import TrustedHostMiddleware

app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=[
        "localhost",
        "127.0.0.1",
        "*.trycloudflare.com",
    ]
)
```

---

## 第三章：實戰工作流程範例

### 範例：前後端雙管暴露 (分離式架構)

若您亟需使遠端客戶能無縫體驗完整的 Moyin 平台，您必須同時啟動兩條隧道：

**步驟一：啟動並暴露後端 API**

```bash
# 終端 1：啟動本機 API
cd projects/moyin-gateway/web2api
python main.py

# 終端 2：為 API 建立隧道
cloudflared tunnel --url http://localhost:8001
# 獲得網址：https://api-xyz.trycloudflare.com
```

**步驟二：啟動並暴露前端靜態網頁**

```bash
# 終端 3：啟動 Vite 前端
cd projects/moyin-game-v1/website
npm run dev

# 終端 4：為 Vite 建立隧道
cloudflared tunnel --url http://localhost:5173
# 獲得網址：https://frontend-abc.trycloudflare.com
```

**步驟三：動態抽換前端環境變數**
於前端專案內，將原本指向 `localhost` 之 API 網址，暫代為剛獲取之後端隧道網址：

```env
# .env.development
VITE_API_BASE_URL=https://api-xyz.trycloudflare.com
```

---

## 第四章：適用場域與安全警示

### ✅ 極度推薦之情境

- 本機端第三方 Webhook 回調測試 (如串接 Stripe 或 Line Bot)。
- 手機/平板端跨裝置 RWD 響應測試。
- 提供展示原型 (Prototype) 予遠端設計師或業主審閱。

### ❌ 嚴禁使用之情境

- 任何含有敏感未加密資訊之臨時端點（未設密碼之資料庫管理介面）。臨時隧道網址一旦外流等同全網公開。
- 在未具備持久化防護網 (Rate Limiting) 時，將此作為微型生產伺服器 (Production Server)。

### 進階應用：具名隧道 (Named Tunnel)

臨時隧道每次重啟皆會洗牌網址。若需綁定固定之專屬網域，必須登入 Cloudflare 帳號並建立具名隧道，指令如下：

```bash
cloudflared tunnel login
cloudflared tunnel create moyin-dev
cloudflared tunnel route dns moyin-dev dev.moyin.example.com
cloudflared tunnel run moyin-dev
```
