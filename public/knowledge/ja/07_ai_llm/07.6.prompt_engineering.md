# 07.6. 提示詞工程學：支配 AI 的核心法則 (Prompt Engineering)

> **類型**: 開發守則與 AI 行為控制  
> **重點**: 闡述如何於程式邏輯中構建精確之系統指令 (System Prompt)，強制大語言模型輸出穩定、結構化且具備自我糾錯彈性的資料流。

---

## 前言：AI 猶如即興劇演員

在 Moyin 的引擎架構中，大語言模型 (LLM) 扮演著驅動靈魂的關鍵組件。然而，其本質極度類似於未受框限的「即興劇演員」——倘若缺乏嚴格的劇本規範與導演指令，其輸出將迅速發散並偏離系統預設之主軸。

本指南致力於傳授如何透過精編「提示詞 (Prompt)」，對其施加絕對之工程控制與行為收斂。

---

## 1. 提示詞雙軌架構 (Dual-Track Prompting)

在 API 的通訊協定中，我們明確界定兩種維度的訊息傳遞層級：

### System Prompt (全域系統指令)

- **定位**：「導演的隱形擴音器」。此階層的權重極高，且專屬於系統後台，不受終端使用者之干涉。
- **職責**：
  1. 錨定全域世界觀與 NPC 的人格屬性（如：「你名為林晚，性格高冷且具備洞察力...」）。
  2. **工程邊界約束**：強制規定其回傳格式，確保系統解析不致崩潰。

### User Prompt (環境與玩家輸入)

- **定位**：「舞台上發生的即時台詞與場景變換」。
- **職責**：傳達瞬息萬變的互動狀態。例如：「【玩家】選擇遞出雨傘」，抑或是封裝環境參數：「【系統事件】傍晚時分，鐘聲響起」。

---

## 2. 輸出結構化控制：確保 API 吞吐穩定 (Enforcing JSON Format)

大語言模型天生具備喋喋不休之傾訴慾。對於程式後端而言，任何一句多餘的開場白（如「好的，為您產出以下劇情：」）皆會引發後端的 `JSON Parse Error` 致命例外。

### A. 實體範本映射 (One-Shot Example)

- **戰術手段**：勿僅依靠口頭約束，直接於 System Prompt 底端刻錄一組完美的 JSON 輸出範例。
- **話術公版**：「請嚴格並僅輸出符合下列結構之 JSON 字串，**絕對禁止**夾帶任何 Markdown 標記、前後文廢話或思考過程：」

### B. 內隱式思考流 (Hidden Chain of Thought)

為了使 AI 能夠進行深層的因果推演（例如判定某項玩家行為是否足以扣減好感度），但又不可污染最終輸出的純淨度。

- **解法**：容許啟用具備深度思考機制之模型（如 Grok-thinking 或 DeepSeek-R1），但在後端的響應攔截器 (Response Interceptor) 中，運用正則表達式強制摒除所有 `<thought>...</thought>` 區塊，僅截取最終的 JSON 封裝檔進入路由。

### C. 魯棒性與自癒機制 (Robustness & Self-Healing)

模型依然存在漏失閉合括號 `}` 或欄位脫漏之機率。

- **架構防線**：在伺服器端佈建 `try-catch` 重放機制。當捕獲解析異常時，閘道器不會直接拋棄，而是將系統異常字串（包含堆疊報錯）封裝回 User Prompt 再次遞送予 AI：「您的上一輪回應遭判定 JSON 結構毀損，錯誤發生於第 4 行，請即刻修復並重新發送」。實測證明，多數高階模型於次輪 (Retry) 皆能完美自癒。

---

## 3. 防範常見的格式崩潰地雷💣

在與程式語言對接時，需特別防堵以下符號污染：

- **嚴禁 Markdown 字元污染**：部分模型帶有強烈慣性，會以 \`\`\`json 作為前後綴包裹字串。必須於 Prompt 內反覆申明禁止此行為，或於中間層強制執行 `string.replace` 清理工序。
- **雙引號地獄 (Double-Quote Hell)**：由於 JSON 的鍵值皆由英文雙引號 `"` 所包裹，若劇本故事之對白同樣使用英文雙引號，將直接導致語法樹截斷。
  - **強制約束對策**：於 System Prompt 內寫死：「於敘述與對話欄位內，強制且僅能使用全形中文引號 `「` 與 `」` 標記台詞，嚴禁混用英文引號」。

---

## 4. 利用沙盒測試工具 (Vibe Tester)

切忌在沒有任何沙盤推演的狀況下，直接修改源碼並重啟伺服器。Moyin 後端配置有專屬之**前端沙盒測試介面 (Tester)**，請奉行以下測試迴圈：

1. 開啟開發測試端點 (預設路徑通常為 `http://localhost:5173` 之分支頁面)。
2. 從下拉選單切換至欲查核的特定模型推理提供者 (Provider API)。
3. 將草擬之 System Prompt 置入控制台板塊，並模擬多種玩家惡意輸入。
4. 點擊送出後，直接檢視 `Response RAW Data` 中之格式純淨度。

唯有測試 5 輪以上皆無破圖或例外溢出，方具備將該段 Prompt 提交流水線 (Commit) 之資格。
