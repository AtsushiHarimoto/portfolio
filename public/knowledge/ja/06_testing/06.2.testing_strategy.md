# 06.2 テスト戦略

> **種類**: 開発規範
> **日付**: 2026-02-26
> **ステータス**: 骨格 (アウトライン)
> **関連**: `06.1.automation_basics.md`

---

## 概要

Moyin プロジェクトの階層型テスト戦略を定義します。これには、単体テスト (Unit Test)、結合テスト (Integration Test)、E2E テストの役割分担、ツールの選定、および実行上の規範が含まれます。

---

## 1. テストピラミッド

```
        /  E2E  \           少量、重要なユーザーフローを検証
       /---------\
      /Integration\         中量、モジュール間の連携を検証
     /-------------\
    /  Unit Tests   \       大量、単一の関数/コンポーネントを検証
   /-----------------\
```

| 階層 (Tier) | 数量比率 | 速度   | メンテナンスコスト | 信頼度 (Confidence)      |
| ----------- | -------- | ------ | ------------------ | ------------------------ |
| Unit        | ~70%     | 極速   | 低                 | 単一モジュール           |
| Integration | ~20%     | 中程度 | 中                 | モジュールの連携         |
| E2E         | ~10%     | 遅い   | 高                 | エンドツーエンドのフロー |

---

## 2. 技術スタックの選定

### 2.1 フロントエンド (Vue 3 + TypeScript)

| 階層      | ツール                          | 用途                                                     |
| --------- | ------------------------------- | -------------------------------------------------------- |
| Unit      | **Vitest**                      | コンポーネントロジック、Composable、Pinia Store          |
| Component | **Vue Test Utils** + Vitest     | コンポーネントのレンダリング、イベントのインタラクション |
| E2E       | **Playwright** 又は **Cypress** | ブラウザのエンドツーエンドフロー                         |

### 2.2 バックエンド (Python / Node.js)

| 階層        | ツール                  | 用途                                   |
| ----------- | ----------------------- | -------------------------------------- |
| Unit        | **pytest** / **Vitest** | ビジネスロジック、ユーティリティ関数   |
| Integration | **pytest** + **httpx**  | API エンドポイント、DB 操作            |
| E2E         | **Playwright**          | 全体的なリンクチェーン (全鏈路) の検証 |

### 2.3 MCP Server

| 階層        | ツール          | 用途                      |
| ----------- | --------------- | ------------------------- |
| Unit        | Vitest / pytest | Tool ハンドラーのロジック |
| Integration | MCP Inspector   | プロトコル層の検証        |

---

## 3. テストの規範

### 3.1 ファイルの命名ルールと配置場所

```
projects/<project>/
├── src/
│   └── components/
│       └── MyComponent.vue
├── tests/                    # 又は test/
│   ├── unit/
│   │   └── MyComponent.test.ts
│   ├── integration/
│   │   └── api.test.ts
│   └── e2e/
│       └── login-flow.spec.ts
```

> ⚠️ 鉄則：テストファイルは必ず対応するプロジェクトの `test/` または `tests/` ディレクトリ内に配置しなければならず、プロジェクトを跨ぐことは厳禁です。

### 3.2 命名の慣例

```typescript
// Unit Test
describe('MyComponent', () => {
  it('should render title when prop is provided', () => { ... })
  it('should emit click event when button is pressed', () => { ... })
})

// フォーマット: should [期待される動作] when [トリガー条件]
```

### 3.3 テストの分類タグ

| タグ          | 意味                              | CI の挙動                     |
| ------------- | --------------------------------- | ----------------------------- |
| `@smoke`      | スモークテスト (Smoke Test)       | commit ごとに必ず実行         |
| `@regression` | リグレッションテスト (回帰テスト) | PR マージ前に必ず実行         |
| `@slow`       | 時間のかかるテスト                | スケジュール / 手動でトリガー |

---

## 4. 各階層のテストの要点

### 4.1 Unit Test (単体テスト)

| 要点               | 説明                                                          |
| ------------------ | ------------------------------------------------------------- |
| 独立性 (Isolation) | 外部依存関係（API、DB、ファイルシステム）をモック (Mock) する |
| カバレッジ目標     | コアビジネスロジック ≥ 80%                                    |
| 速度               | 1 つのテストにつき < 100ms                                    |
| フォーカス         | 1 つのテストケースは 1 つの振る舞いのみを検証する             |

### 4.2 Integration Test (結合テスト)

| 要点                      | 説明                                                      |
| ------------------------- | --------------------------------------------------------- |
| 範囲                      | 2～3 個のモジュールの連携                                 |
| 実際の依存関係            | 可能な限り本物の DB（テスト用 DB）や本物の API を使用する |
| セットアップ/ティアダウン | 各テストの前後でステータスをクリーンアップする            |

### 4.3 E2E Test (エンドツーエンドテスト)

| 要点             | 説明                                                                          |
| ---------------- | ----------------------------------------------------------------------------- |
| ユーザー視点     | 実際のユーザーの操作フローをシミュレートする                                  |
| クリティカルパス | コアとなるビジネスフロー（ログイン、作成、公開）のみをカバーする              |
| 安定性           | Flaky test (不安定なテスト) を避ける → `data-testid` を使用して要素を特定する |
| タイムアウト     | 誤った失敗を避けるため、合理的に設定する                                      |

---

## 5. CI/CD インテグレーション

### 5.1 実行のタイミング

```
git push → Unit + Integration (< 5 min)
PR open  → Unit + Integration + E2E Smoke (< 15 min)
PR merge → Full Regression (< 30 min)
Nightly  → Full Suite + Performance (時間制限なし)
```

### 5.2 品質の基準 (Quality Thresholds)

| 指標                 | 基準 (閾値)                     |
| -------------------- | ------------------------------- |
| Unit カバレッジ      | ≥ 80% (コアモジュール)          |
| テスト合格率         | 100% (既知の失敗は許容されない) |
| E2E クリティカルパス | 全て合格                        |

---

## 6. テストツールボックス

| ツール                        | 用途                         |
| ----------------------------- | ---------------------------- |
| **Vitest**                    | 単体 / 結合テストランナー    |
| **Vue Test Utils**            | Vue コンポーネントテスト補助 |
| **MSW** (Mock Service Worker) | API のモック                 |
| **Playwright**                | E2E / ブラウザの自動化       |
| **Faker.js**                  | テストデータの生成           |
| **c8 / istanbul**             | カバレッジレポート           |

---

## 今後深掘りすべき項目 (Pending Deep Dives)

- [ ] 具体的な Vitest 設定のサンプル
- [ ] Playwright E2E テストスクリプトのサンプル
- [ ] Visual Regression Testing（スクリーンショットの視覚的比較機能）
- [ ] API Contract Testing（フロント・バックエンド間の契約テスト）
- [ ] テストデータ管理戦略（Factory / Fixture）

---

## 💡 Vibecoding 指令

AI エージェントにテストのインフラストラクチャやテストケースを書かせる際：

> 🗣️ `「テストファイルを生成する際は、テスト戦略で定義された【テストピラミッド】と【テストの分類タグ】の規範に厳密に従ってください。フロントエンドコンポーネントには【Vitest】と【Vue Test Utils】を使用し、コアロジックにおいて強力な隔離性を保ち、80% のカバレッジ率を達成してください。テストファイルは正しい 'tests/unit' ディレクトリに配置し、必ず 'should [期待される動作] when [トリガー条件]' の命名規則を使用してください！」`
