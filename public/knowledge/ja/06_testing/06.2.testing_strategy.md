# 06.2 測試策略

> **類型**: 開發規範
> **日期**: 2026-02-26
> **狀態**: 骨架
> **關聯**: `06.1.automation_basics.md`

---

## 摘要

定義 Moyin 專案的分層測試策略，涵蓋單元測試、整合測試、E2E 測試的分工、工具選型與執行規範。

---

## 1. 測試金字塔

```
        ╱  E2E  ╲           少量，驗證關鍵用戶流程
       ╱─────────╲
      ╱ Integration╲        中量，驗證模組間協作
     ╱───────────────╲
    ╱   Unit Tests    ╲     大量，驗證單一函數/元件
   ╱───────────────────╲
```

| 層級 | 數量比 | 速度 | 維護成本 | 信心度 |
|------|--------|------|----------|--------|
| Unit | ~70% | 極快 | 低 | 單一模組 |
| Integration | ~20% | 中等 | 中 | 模組協作 |
| E2E | ~10% | 慢 | 高 | 端到端流程 |

---

## 2. 技術選型

### 2.1 前端 (Vue 3 + TypeScript)

| 層級 | 工具 | 用途 |
|------|------|------|
| Unit | **Vitest** | 元件邏輯、Composable、Pinia Store |
| Component | **Vue Test Utils** + Vitest | 元件渲染、事件互動 |
| E2E | **Playwright** 或 **Cypress** | 瀏覽器端到端流程 |

### 2.2 後端 (Python / Node.js)

| 層級 | 工具 | 用途 |
|------|------|------|
| Unit | **pytest** / **Vitest** | 業務邏輯、工具函數 |
| Integration | **pytest** + **httpx** | API 端點、DB 操作 |
| E2E | **Playwright** | 全鏈路驗證 |

### 2.3 MCP Server

| 層級 | 工具 | 用途 |
|------|------|------|
| Unit | Vitest / pytest | Tool handler 邏輯 |
| Integration | MCP Inspector | 協議層驗證 |

---

## 3. 測試規範

### 3.1 檔案命名與位置

```
projects/<project>/
├── src/
│   └── components/
│       └── MyComponent.vue
├── tests/                    # 或 test/
│   ├── unit/
│   │   └── MyComponent.test.ts
│   ├── integration/
│   │   └── api.test.ts
│   └── e2e/
│       └── login-flow.spec.ts
```

> ⚠️ 鐵律：測試檔案只能在對應項目的 `test/` 或 `tests/` 目錄內，嚴禁跨項目

### 3.2 命名慣例

```typescript
// Unit Test
describe('MyComponent', () => {
  it('should render title when prop is provided', () => { ... })
  it('should emit click event when button is pressed', () => { ... })
})

// 格式：should [預期行為] when [觸發條件]
```

### 3.3 測試分級標籤

| 標籤 | 含義 | CI 行為 |
|------|------|---------|
| `@smoke` | 冒煙測試 | 每次 commit 必跑 |
| `@regression` | 回歸測試 | PR merge 前必跑 |
| `@slow` | 耗時測試 | 定時 / 手動觸發 |

---

## 4. 各層測試要點

### 4.1 Unit Test

| 要點 | 說明 |
|------|------|
| 隔離性 | Mock 外部依賴（API、DB、檔案系統） |
| 覆蓋率目標 | 核心業務邏輯 ≥ 80% |
| 速度 | 單個測試 < 100ms |
| 聚焦 | 一個 test case 只測一個行為 |

### 4.2 Integration Test

| 要點 | 說明 |
|------|------|
| 範圍 | 2–3 個模組的協作 |
| 真實依賴 | 盡量用真實 DB（測試庫）、真實 API |
| Setup/Teardown | 每個測試前後清理狀態 |

### 4.3 E2E Test

| 要點 | 說明 |
|------|------|
| 用戶視角 | 模擬真實用戶操作流程 |
| 關鍵路徑 | 只覆蓋核心業務流程（登入、建立、發布） |
| 穩定性 | 避免 flaky test → 用 data-testid 定位元素 |
| 超時 | 合理設定，避免假失敗 |

---

## 5. CI/CD 整合

### 5.1 執行時機

```
git push → Unit + Integration (< 5 min)
PR open  → Unit + Integration + E2E Smoke (< 15 min)
PR merge → Full Regression (< 30 min)
Nightly  → Full Suite + Performance (不限時)
```

### 5.2 品質門檻

| 指標 | 門檻 |
|------|------|
| Unit 覆蓋率 | ≥ 80% (核心模組) |
| 測試通過率 | 100% (不允許已知失敗) |
| E2E 關鍵路徑 | 全部通過 |

---

## 6. 測試工具箱

| 工具 | 用途 |
|------|------|
| **Vitest** | 單元/整合測試 Runner |
| **Vue Test Utils** | Vue 元件測試輔助 |
| **MSW** (Mock Service Worker) | API Mock |
| **Playwright** | E2E / 瀏覽器自動化 |
| **Faker.js** | 測試數據生成 |
| **c8 / istanbul** | 覆蓋率報告 |

---

## 待深入

- [ ] 具體 Vitest 配置範例
- [ ] Playwright E2E 測試腳本範例
- [ ] Visual Regression Testing（截圖比對）
- [ ] API Contract Testing（前後端契約）
- [ ] 測試數據管理策略（Factory / Fixture）
