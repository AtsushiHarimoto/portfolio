# 06.1. Moyin 自動化 E2E 測試實戰與基礎架構指南 (Automation Basics)

> **類型**: 質量保證 (QA) 與自動化測試工程  
> **重點**: 闡述如何聘用「自動化機器人 (Playwright)」取代傳統手工人力點擊，徹底封殺每次重構所帶來的回歸錯誤 (Regression Bugs)。並記載 Moyin 專案特有的白箱動態測試解法，突破遊戲動畫渲染帶來的時序驗證瓶頸。

---

## 前言：何謂自動化 E2E 測試？

在快速迭代且高度複雜化之前端應用程序（尤以狀態樹縱積如山的視覺小說引擎核心為最）中，僅仰賴人力工程師手工在瀏覽器上逐一點擊驗證，不僅效率極其低下，而且注定產生諸多遺漏的盲點。
我們需要的是一道永不疲倦的國防級火力封鎖線——這便是 **自動化端到端測試 (End-to-End Testing)** 存在的意義。

### 🤖 終端機內的幽靈大軍：Playwright

Moyin 專案委派大名鼎鼎之 Web 測試框架 **Playwright** 等同於無薪僱用了一位 24 小時無休之全職機器人測試員，並為它寫下了一份永不逾矩的操作守則：

1. 模擬 Chrome/Firefox 核心驅動引擎並存取測試連結。
2. 進行嚴苛的光學表單掃描、追尋特徵 CSS 標籤，然後如人類般精準按下按鈕。
3. 閱覽劇情過渡效果、於存/讀檔機制驗證存儲狀態。
   一旦它在某個毫秒時刻察覺了「預期出現之綠色勾選框並未渲染出來」或「網頁遭遇不明 Fatal Error 呈現白屏崩潰」，它便會如實寫下日誌，替我們無情按停 CI (持續整合) 流水線的佈署按鈕。

### 👻 隱藏的無頭武士 (Headless Mode)

當您於本機下達測試腳本指令時，您會驚訝地發現「瀏覽器視窗憑空消失了」！
無須驚慌，這即為工業最頂級之 **無頭模式 (Headless Browser Mode)**。透過剝除最耗費顯卡資源之表層 UI 圖形渲染邏輯，這名無頭機器人得以在背景終端機以神鬼般的速度狂飆執行數十套劇本查核。若不幸遭逢紅燈出錯，它亦不忘於殉職前攝下一幀高清的截圖遺照供工程師驗屍之用。

---

## 2. 實戰戰術：突破 Moyin 引擎測試瓶頸之核心專利

在 Moyin 的高動態遊戲環境中，純粹的黑箱 E2E 機器人很容易淪為眼盲患者。我們開發了以下兩道關鍵特技，令其強大無虞：

### 🔑 戰術一：動態履歷欺騙注入機制 (Dynamic Manifest Injection)

**【環境難題】**：
在 Moyin 引擎的架構設計下，為防止系統污損，底層將完全否決相同 ID 之故事封裝包之二次匯入。這代表倘若我們測試通過了第一回合，再次執行第二輪時，機器人便會撞上「該故事檔案已死鎖存在」的錯誤，使 CI 失去冪等重跑性 (Idempotency)。

**【駭客解法】**：
於 Playwright 之初始準備腳本勾子 (Hooks) 內，埋設一道攔截加工演算法。我們動態篡改了將送往資料庫之 Manifest 證件：

- 原始設定：`ID: Mock_Testing_Story`
- 動態洗牌：`ID: Mock_Testing_Story_89f2_202611221430` (注入亂數雜湊與系統時戳)。
  此偷天換日之舉讓後端引擎遭逢記憶體詐欺，將每一次提交皆視作嶄新之全淨作品載入，從此測試腳本達成了無限防彈續航力。

### 🌉 戰術二：跨維度白箱天橋 (White-box Bridge)

**【環境難題】**：
因為我們的 VN (Visual Novel) 舞台搭載高精度轉場演色，若此時 Playwright 的黑箱機器人強硬要求「請按下下一句台詞」，它常會撲了個空，點在半透明之遮罩上，最終因苦等逾時而觸發 **Flaky Tests (脆弱的間歇性測試錯誤)**。這簡直是在虐待我們的維運團隊。

**【駭客解法】**：
我們選擇不再逼迫機器人進行眼翳之盲人摸象。工程團隊特別於 Vue 引擎之建構環節，開了一道具備高等權限之全域變數暗門接口：`window.__MOYIN_TEST__`。這賦予了機器人深植系統核心髓液的透視超能力：

- 無須依賴 DOM 標籤，可直讀 Vuex / Pinia 之深層變數以驗證「目前階段指標是否進入 Phase 4」。
- 在執行翻頁時，不再依恃模擬滑鼠點擊，可直接越權呼叫核心函數強制斬斷動畫：`__MOYIN_TEST__.forceSkipNext()`。
  徹底根絕動畫遲滯帶來的時序耦合，測試效能與穩定度皆獲得神話級飛昇！

---

## 3. 測試軍令與驗屍驗收報告 (Execution & Post-Mortem)

身為本專案的成員開發者，您不必然具備撰寫龐大測試例陣的功力，但必須要習得如何喚醒部隊，且在他們全軍覆沒時找出陣亡紀錄：

### ⚔️ 指揮部署指令 (Launch CLI)

透過終端機敲擊下列指令，即刻啟動所有測試分隊掃蕩環境：

```bash
npx playwright test
```

### 🔬 驗屍與現場勘驗 (Triaging the Results)

此系統秉持報喜不報憂的沉默原則。一旦見到滿江黑白終端機日誌轉為驚愕的紅色錯誤碼時，請您直奔：

- `tests/e2e/test-results/`：進入此犯罪現場封鎖線資料夾中。您不僅能截獲致命 Exception 的拋出堆疊棧，還能獲取系統崩潰當下拍攝的 **現場高解析度畫面擷圖 (Screenshot) / 錄影**。透過這些證據，即可迅速判定是因「重構 CSS 跑版導致按鈕溢出可視界線」抑或為「核心 Router 導流癱瘓引發之死機白屏」。

---

_此文檔詳列了 Moyin 品質保證 (QA) 領域的最深奧義；若需索取各端點深層參數組態，請協同參照測試框架附屬文件。_
