# 09. システム設計フィールドガイド (System Design Basics)

> **種類**: システムアーキテクチャ基礎  
> **重点**: バックエンドの現場でよく耳にする「マイクロサービス (Microservices)」「API ゲートウェイ (API Gateway)」「非同期キュー (Async Queue)」といった用語を丁寧に解説し、全体像の俯瞰を支援します。

---

## 1. システム構成：モノリシック (Monolithic) かマイクロサービス (Microservices) か

分散システムでは、コンポーネントの組織方法に起因する二つの陣営が存在します。

| モデル | 比喩と技術的特徴 | 評価 | Moyin の判断 |
| :---- | :--------------- | :--- | :------------ |
| **モノリシック (Monolithic)** | **「ぎゅっと密集したワンルーム」**。すべてのロジックや機能が単一プロセス・単一ディレクトリで動作します。 | 💥 **課題**：認証モジュールのメモリリークひとつで、AI を含む全サービスが同時に落ちます。 | ❌ 採用していません。AI ワークロードの負荷差に耐えられません。 |
| **マイクロサービス (Microservices)** | **「役割分担された産業団地」**。業務ロジックを分割した独立したプロジェクトが API 経由で通信します。 | ✨ **利点**：ログインサービスが落ちてもレンダリングサービスは継続。ComfyUI のような GPU 駆動サービスに専用資源を割けます。 | ✅ **全面採用**：`moyin-gateway` や `moyin-comfyUI` などが独立したマイクロサービスとして動いています。 |

> 💡 **ベストプラクティス**: マイクロサービスは万能ではなく、大規模アプリを複数のマイクロアプリへ分割し、それぞれ RESTful / gRPC API で通信させるという思想であることを理解してください。

---

## 2. API ゲートウェイ (API Gateway)

- **従来の課題**：ゲートウェイがないと、クライアントは十数個のサービスの IP とポートをハードコードします。バックエンド構成が変わると、クライアント側も再デプロイが必要です。  
- **ゲートウェイの役割**：マイクロサービス群の「単一入口の守衛」や「総合受付」です。  
- **挙動**：プレイヤー情報取得や画像生成といったフロントエンドからのリクエストはすべて API Gateway を通ります。Gateway が認証処理をして、API パスに応じて **リバースプロキシ (Reverse Proxy)** で該当サービスへルーティングします。

> 🏢 **Moyin での反映**: フロントエンドが大規模言語モデルを呼ぶときも、直接 OpenAI には接続せず `moyin-gateway` へ一度集約します。Gateway のロードバランサとコストルーティングが、クラウド Claude かオンプレミス Ollama を動的に選択し、フロントエンドには切り替えを意識させません。

---

## 3. 非同期メッセージキュー (Async Message Queue)

- **同期処理の問題**：3 分かかる高品質画像生成のような処理を同期で実行すると、HTTP リクエストがブロックされ、UI がハングし、タイムアウトを引き起こします。  
- **キューによる解決**：これは「飲食店の番号札」に似ています。  
  1. ユーザーの重いリクエストを受けたら、すぐに **タスク ID (Task ID)** を返します。  
  2. リクエストは **メッセージキュー (RabbitMQ や Redis)** に保管されます。  
  3. バックグラウンドのワーカーが順にキューから取り出して処理します。  
  4. 完了後は WebSocket で通知するか、フロントが Task ID で定期ポーリングして結果を取得します。

> 🌟 **耐障害の切り札：Temporal**  
> 通常のキューはサーバー再起動でジョブを失います。Moyin は **Temporal** を導入し、**長時間実行ワークフロー (Long-running Workflow)** を状態機械として永続化します。再起動後も前回のチェックポイントから再開し、企業グレードの信頼性を実現します。

---

## 4. 負荷分散 (Load Balancing)

- **課題**：爆発的なアクセスにより単一ノードの CPU とネットワークが飽和する。  
- **対策**：複数台の同一マイクロサービスを並列展開し、**ロードバランサ (Load Balancer, Nginx／HAProxy など)** を前段に置く。  
- **仕組み**：バランサはラウンドロビン (Round Robin) や最少接続 (Least Connections) といったアルゴリズムでトラフィックを分散し、一点集中を防ぎ **高可用性 (High Availability)** を維持します。

---

## ✅ アーキテクチャ習得チェックリスト

システム設計とは常に「トレードオフ」をルール化する行為です。Moyin は複雑さと安全性をバックエンドに集約し、フロントを軽く保っています。

次の記述にチェックを入れて、理解度を確かめてください：

- [ ] 「この API は深層学習推論を伴い 30 秒以上かかる可能性があるため、**非同期バックグラウンドタスク**に再構成し、Task ID を即時返す設計へ改修します。」  
- [ ] 「マイクロサービスは障害の影響範囲を隔離し、スケーラビリティを高めるが、運用とデバッグの複雑性が上がることを理解しています。」  
- [ ] 「ロードバランサの役割は高トラフィック時にリクエストを水平スケールした複数ノードへ分配することで、高可用性を実現することです。」  
- [ ] 「メッセージキュー（や Temporal）によって、高負荷ジョブを非同期で処理しつつ状態を永続化し、最終的一貫性を保証できることを把握しています。」
