# 22. OpenCWAL 原理設計

> **種類**: アーキテクチャ  
> **日付**: 2026-02-26  
> **ステータス**: 骨子  
> **正式名称**: Open Context Window & Attention Lattice

---

## 概要

OpenCWAL は AI エージェントの文脈管理フレームワークです。限られたコンテキストウィンドウ内で上下文階層、アテンションルーティング、レイテンシ予算を組み合わせて性能を最大化します。

---

## 1. なぜ OpenCWAL が必要か

### 1.1 課題

| 課題 | 説明 |
| :-- | :-- |
| コンテキスト浪費 | 無関係な情報でトークンを消費し品質が向上しない |
| アテンション希薄化 | キー指令が埋もれて重要制約を忘れる |
| レイテンシ制御不能 | プロンプトが長くなるほど推論遅延が増す |
| メモリ断層 | セッションや Agent を跨ぐ文脈が流れない |

### 1.2 目標

- 必要最小限の文脈だけを提供  
- 制約を高アテンションゾーンに置く  
- トークン長をレイテンシの甘いポイント内に抑える  
- 各コンテキストに出所とバージョンを記録

---

## 2. 三大支柱

### 2.1 文脈階層

```
Level 0 — System Core     永続（CLAUDE.md、核規則）
Level 1 — Session State   セッション（現在のタスク、Plan、Issue）
Level 2 — Working Set     タスク（編集中のファイル、検索結果）
Level 3 — Reference      要求時読み込み（ナレッジベース、履歴）
Level 4 — Archive        非ロード（圧縮アーカイブ、検索用）
```

| Level | ライフサイクル | Token 割合 | ロード戦略 |
| :---- | :----- | :--------: | :-------- |
| L0 | 永続 | ~10% | 自動注入 |
| L1 | セッション | ~20% | タスク開始時 |
| L2 | タスク | ~50% | 必要に応じて |
| L3 | 要求 | ~15% | キーワード / RAG |
| L4 | アーカイブ | 0% | grep で検索 |

### 2.2 アテンションルーティング

#### 基本原則

- Front-loading：重要な制約は先頭に置く  
- Repetition anchoring：system reminder で繰り返す  
- Separation：異なる情報を段落で分ける  
- Progressive detail：概要 → 必要に応じて展開

#### アテンションヒートマップ

```
Prompt 位置:  [前半] ████████████ [中盤] ████░░░░ [終盤] ████████
強度:          非常に高い    中程度/減衰      再活性（近因効果）
内容:          核心ルール    作業データ      行動指示 / 出力形式
```

### 2.3 レイテンシ予算

| シナリオ | トークン | 遅延 | 戦略 |
| :------ | :-----: | :--: | :-- |
| チャット | < 4K | <2秒 | 最小コンテキスト |
| コーディング | 8K–32K | <10秒 | 厳選ドキュメント |
| 深掘り分析 | 32K–128K | <60秒 | 全ファイル + RAG |
| バッチ | 無制限 | 無制限 | サブタスク分割 |

---

## 3. 実践パターン

### 3.1 文脈組み立て

```
1. L0（System Core）をロード
2. task_type に応じて L1 をロード
3. scope に応じて L2 をロード
4. 足りない場合は RAG / Grep で L3 を取得
5. 合計トークンが予算以下か確認
6. 超過時は L2 を圧縮またはタスク分割
```

### 3.2 Moyin での実装

| 原則 | Moyin での体現 |
| :-- | :-- |
| L0 永続 | `CLAUDE.md` を自動注入 |
| L1 会話 | `workspace/.context/` をロード |
| L2 要求 | Agent が Read/Grep で取得 |
| Front-loading | CLAUDE.md の冒頭 |
| Repetition | `system-reminder` で再掲 |
| Latency budget | 必要に応じて用語抽出 |

### 3.3 Skill の役割

各スキルは L1–L2 文脈パッケージ：

- 説明 → トリガー（いつロード）  
- コンテンツ → 文脈注入  
- チェックリスト → Attention のガイド

---

## 4. 設計原則

| # | 原則 | 解説 |
| :-- | :-- | :-- |
| 1 | 最小コンテキスト | 必要最低限のみ |
| 2 | 分級ロード | L0–L4 で段階的に遅延ロード |
| 3 | アテンション保護 | 制約を高注意力に置く |
| 4 | トークン予算 | 明確な上限を設ける |
| 5 | トレース可能性 | ソースとバージョンを必ず記録 |
| 6 | 圧縮優先 | 超過時は要約し、切り捨ては最終手段 |

---

## 5. 今後の検討

- トークン予算自動化ツール  
- 文脈圧縮アルゴリズム  
- RAG + L3 統合  
- Agent 間文脈共有プロトコル  
- `21_agent_system_design.md` と通信プロトコルの統合
