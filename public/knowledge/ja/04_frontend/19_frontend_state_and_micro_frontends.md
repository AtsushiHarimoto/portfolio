# 19. State & Micro-Frontends：地殻変動と再構成

> **種類**: 大規模 SPA のアーキテクチャ  
> **重点**: 全要素を単一のグローバルストア（Redux/Vuex）に押し込む時代を終わらせ、クライアント状態とサーバー状態を分離しつつ、異なるチームが React/Vue モジュールを一つに組み上げる方法を知る。

---

## 序章：Redux の地獄

初期のエンジニアはトグルや一万件の注文データをまとめて Redux/Vuex に放り込み、次の災害を招いた：

1. **Stale Data** – 注文は昨日の DB スナップショット。払い戻し状況が古いまま表示される。  
2. **Spaghetti Code** – サイドバーを開くだけで全ストアが再計算され、十万件の注文を巻き込んで性能が死ぬ。

---

## 1. 境界を引く：クライアント状態 vs サーバー状態

### 📱 クライアント状態

- ブラウザ内の短命なインタラクション状態。  
- 例：ライト/ダークテーマ、モーダルの開閉、フィルタ条件。  
- Pinia/Ref/Reactiveness で保持。リロードで消えても構わない。

### ☁️ サーバー状態

- データベースの所有物で、他ユーザーの操作で変わるため読み取り専用。  
- 例：在庫数、残高。  
- **TanStack Query / SWR** などの専用キャッシュレイヤーを使い、Pinia に投げ込まない。これらは自前のバッファを持ち：
  - フォーカス回帰で自動再取得  
  - Hover で次ページを 200ms 先取り  
  - オプティミスティック UI：いいねを即座に赤にし、サーバー失敗ならそっと灰に戻す

---

## 2. Micro-Frontends：チームの衝突を回避

5人の会社が 50人になり、モノリシックな Vue モノリポで 10 分の Webpack ビルドを待たなければならないと、誰のバグでも全体デプロイが失敗します。

### 🧩 Module Federation で組む積み木

マイクロサービスと同じ精神で UI を断片化。
- A チーム：Vue 3 でホームページ。  
- B チーム：レガシー React 16 のチェックアウト。

Webpack 5 Module Federation や Single-SPA を使えば：

- **独立デプロイ**：チェックアウト側は自分の JS バンドルを CDN に上げて 5 秒で展開。  
- **実行時合成**：ブラウザが CDN から A/B のモジュールをダウンロードし、一枚の HTML にシームレスに貼り付ける。

注意：HTML/CSS の干渉や重いランタイムを複数読み込むので、マイクロフロントエンドは主に大型エンタープライズや管理系ダッシュボードに向く。

---

## 💡 Vibecoding の指示テンプレ

大規模な注文/レビュー UI を AI に書かせる際は、肥大したストアを拒否してください：

> 🗣️「この注文＋レビュー機能では axios を Pinia に流し込むような `useEffect` / `watch` を一切禁止します。それはサーバー状態です。代わりに `@tanstack/vue-query` を導入し、stale-while-revalidate、キャッシュ、オプティミスティック更新で制御してください。Pinia はテーマ切り替えなど軽微なクライアント状態のみに使ってください。」
