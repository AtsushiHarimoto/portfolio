# 20. パフォーマンス & バーチャライゼーション：DOM を救い Google を唸らせる

> **種類**: パフォーマンスチューニング & 描画物理  
> **重点**: 10 万件のデータを表示しても Chrome を落とさないために、バーチャルリストと Core Web Vitals の攻略が必要です。

---

## 前書き：ブラウザの天井はどこか

Vue/React の Virtual DOM は万能ではありません。`v-for="item in 100000"` は依然として 100,000 個の `<div>` を生み、真の DOM は 1,500 を超えると repaint/reflow で失速し、巨大なスクロールはタブクラッシュを誘発します。

---

## 1. Virtualization / Windowing

十万件を扱うとき、答えは「偽装する」です。  
1080p の画面上で表示されるのは 20 件のみなので、それだけを描画します。

### 🪟 vue-virtual-scroller によるウィンドウ化

1. **スクロールバーのトリック** – 50px × 100,000 件で 5,000,000px の仮の高さを作り、スクロール量を自然に見せます。  
2. **実際に描画するのは 20 要素のみ** – DOM には 20 個とバッファだけをマウント。  
3. **内容を切り替えて瞬間移動** – 200 番目に到達したら、現在の 20 `<div>` を 201〜220 番のコンテンツで差し替え、`transform: translateY` で配置を動かします。

結果として、何百万件あっても DOM は数十個に限られ、O(1) に近い軽さで動きます。

---

## 2. Google の判事：Core Web Vitals

2021 年から Web Vitals は SEO の唯一基準。赤ランクでは検索ランキングが落ちます。

### 🥇 LCP（Largest Contentful Paint）

- **意味**：主要コンテンツを表示するまでの時間。  
- **基準**：2.5 秒以内。  
- **対策**：ヒーロー画像を CSS `background-image` ではなく `<img fetchpriority="high">` にして優先ロード。

### 🏎️ INP（Interaction to Next Paint）

- **意味**：最も遅いインタラクションの応答速度。  
- **基準**：0.2 秒以内。  
- **対策**：重い `for` ループなどで Main Thread を塞がない。Web Worker へ移すか、オプティミスティック更新で即時フィードバックを見せる。

### 🌋 CLS（Cumulative Layout Shift）

- **意味**：広告の読み込みなどでレイアウトが跳ねる。  
- **基準**：スコア < 0.1。  
- **対策**：すべての `<img>` に width/height（または CSS ratio）を先に確保し、空間を予約する。

---

## 💡 Vibecoding 指示例

SEO 重視の無限リストを AI に任せるときは、こう言いましょう。

> 🗣️「この管理画面の注文リストでは `v-for` で 50,000 DOM を出しません。`vue-virtual-scroller` かウィンドウ化を導入し、各 `<li>` を 60px に固定してください。さらに、ヒーローバナーにはサイズ指定のプレースホルダを与え、CLS を守るように。」
