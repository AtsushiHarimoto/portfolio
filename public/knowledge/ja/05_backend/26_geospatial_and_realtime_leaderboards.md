# 26. 幾何学的圧縮とスキップリスト：空間検索とリアルタイムランキング (Geospatial & Leaderboards)

> **種類**: システム設計における最先端のデータ構造
> **重点**: Tinder、Uber、そして数百万規模の e スポーツのラダー (天梯) の心臓部を解読します。膨大なユーザーを抱えるシナリオにおいて、従来のリレーショナルデータベースのクエリが遭遇する次元の低下による打撃と、Redis の底層にある究極の火力：スキップリスト (Skip List) と GeoHash 空間インデックスについて解説します。

---

## 序：要求が SQL の境界を超えた時

私たちはデータベースが万能だと無邪気に思いがちです。しかし、これら 2 つの極端なシナリオに直面した時、従来の SQL の `SELECT ... ORDER BY` は秒レベルから時間レベルへと一瞬で退化し、システムをフリーズさせます：

1. **「この経度緯度 (X, Y) の範囲から 3 キロ以内の 1000 人の女の子を探して」** (Momo / Tinder / Uber)
2. **「1000 万人がモンスターを狩っており、ポイントが毎秒変動している。即座に更新される全サーバーのトップ 100 英雄ランキングを出し、第 9,999,998 位のユーザーと 1 つ上のユーザーとの差を直ちに教えてくれ」**

これら 2 つの設計は ByteByteGo の上級面接の核心であり、どちらも強力でカスタマイズされたデータ構造に関与しています。

---

## 1. LBS 位置情報サービスの鍵：GeoHash の空間圧縮魔法

2D 平面上で「半径内の点」を探す際、単純に全ユーザーの `(Lat, Long)` 座標を取得し、ピタゴラスの定理を走らせて直線距離を計算するなら、これを「フルテーブルスキャン (Full Table Scan)」と呼びます。経度と緯度のために個別に B+ Tree インデックスを作成したとしても、命を救うことはできません。
私たちは 2 次元の苦痛を、インデックスシステムが理解できる 1 次元の文字列へと**「次元削減 (Dimensionality Reduction)」**しなければなりません。これが **GeoHash** です。

### 🗺️ 地球をピザのように切り分ける

GeoHash の精神は、地球全体の地図を「再帰的に」グリッドに切り分けることです：

- 1 回目：縦横を半分にスライスし、地球は 4 つのグリッドになります。北中米は左上で、コード `9` を与えられます。
- 2 回目：`9` のグリッドをさらに 4 つにスライスします。サンフランシスコはこの小さなブロックに入り、コード `9q` となります。
- N 回目：どんどん細かくスライスしていきます。細かく切れば切るほど、このコードの文字列は長くなります。例えば `9q8yy` という 5 文字の文字列は、「台北市大安区新生南路の 300x300 メートルのグリッド」を正確に表すかもしれません。

### ⚡ 文字列のプレフィックスを使って獲物を素早く捕獲！

各ユーザーの経度と緯度をこの短い文字列に変換してデータベースに保存すると、偉大な魔法が起こります：
**「2 つの文字列のプレフィックス (接頭辞) が似ていれば似ているほど、物理的な空間において絶対に近い！」**
近くの女の子を探したいですか？ システムはもう数学的な距離を計算する必要はありません。極めて暴力的な SQL 文字列の一致検索が 1 つあれば良いのです：
`SELECT * FROM users WHERE geohash LIKE '9q8yy%'`
VARCHAR インデックスに対するデータベースのプレフィックススキャンの速度は神の領域です！ これが出会い系アプリやタクシー配車システムの背後にある究極の秘密です。
_(上級知識：GeoHash に加えて、Google Maps はより柔軟性と複雑さが高い QuadTree (四分木) 構造を好んで採用しています。)_

---

## 2. リアルタイムラダーとスキップリスト：Redis Sorted Set (ZSET) の必殺技

数千万人が随時ポイントを増減させているランキングを維持し、さらに光速でのランダムな割り込みを可能にするには、MongoDB やリレーショナルデータベースでさえ卒倒してしまうでしょう。私たちが頼れるのは、すべてをメモリ内で完結させる覇者、**Redis** だけです。
Redis はランキングのためにオーダーメイドされたチート級のデータ構造を提供しています：`Sorted Set (ZSET)`。

### 🦘 ZSET の底層に潜むボスを暴く：スキップリスト (Skip List)

なぜ ZSET は $\mathcal{O}(\log N)$ という神速で順位のシャッフルと割り込みを完了できるのでしょうか？ それは底層で、重くて鈍い二分木 (Binary Tree) を捨て、極めて暴力的なメモリリンクリストの魔法である**スキップリスト (Skip List)**を採用しているからです。

1. **通常のリンクリスト (Linked List)**：1 駅ずつ停車する普通列車のようなものです。5 万位を探すには、49,999 両の車両を通過せねばならず、血を吐くほど遅いです。
2. **高速鉄道と航空ルートの構築 (スキップリスト)**：
   Redis はこれらの順位の間に、ランダムにいくつかのノードを抽出して「第 2 層の軌道 (高速鉄道)」を構築し、さらに少ないノードを抽出して「第 3 層の軌道 (飛行機)」を構築します。
   あなたが `Score: 88,000` (だいたい 5 万位付近) を探したい時：
   - システムはまず「第 3 層の飛行機」に乗り、一度に 2 万位を飛び越え、直接 4 万位に着陸します。行き過ぎていないことを確認し、もう一度飛んで 6 万位に着陸します。
   - おっと！5 万位を越えてしまいました！システムは即座にあなたに、4 万位の時点まで戻り、エレベーターで「1 階下へ降りて」高速鉄道に乗り換えるよう指示します。
   - 高速鉄道は 1 駅で 2000 位を飛び越え...どんどん沈んでいきます。
     この 3 次元空間で「ジャンプしながら前進する」ような構造により、順位の更新と検索が極めてシンプルになります。しかもこれは**確率的データ構造** (コイントスで上の軌道を構築するかどうかを決める) であるため、厳密にバランスを保つ赤黒木 (Red-Black Tree) を維持するのに比べ、書き込みのプレッシャーが計り知れないほど低く、このランキング挽肉機の神威を生み出しているのです。

---

## 💡 Vibecoding 指令

このような独自のビジネス要求を設計する際、制約を与えなければ、AI は災害レベルの暴力的な二重ループスキャンを出力する可能性が極めて高いです：

> 🗣️ `「この全プラットフォームの達成ポイントランキングシステムにおいて、MySQL にタイマーを組み合わせて取得と並べ替えを行うことは許可しません！Redis の ZSET 構造 (背後では Skip List が高速な並べ替えをサポート) を導入してください。zadd を使ってポイントを更新し、zrevrange で Top 100 リストを取得し、いかなる 1 秒間におけるユーザーのポイント変動も、遅延ゼロでメインボードに反映されることを保証してください！」`
>
> 🗣️ `「このペット用品 e コマースのために O2O (Online To Offline) の実店舗提携店の経度緯度検索を設計する場合、GeoSpatial ソリューションを必ず導入しなければなりません！Redis では最新の GEO モジュールを使用するか、Postgres 内で PostGIS 拡張パッケージ (底層では GeoHash / R-Tree の原理を利用) を有効にし、半径 (Radius) で 2 次元交差計算を実行して結果を見つけ出してください。」`
