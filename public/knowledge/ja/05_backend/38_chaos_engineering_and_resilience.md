# 38. 在烈火中重生：破壞之神與混沌工程 (Chaos Engineering)

> **類型**: SRE 網站可靠性工程與容錯架構指引
> **重點**: 系統越龐大，越不能祈求「它永遠不要壞」，這是不切實際的幻想。本章深入 Netflix 首創的癲狂哲學：**混沌工程 (Chaos Engineering)**。學習如何主動在生產環境中放出一群會拉拔網路線的瘋猴子 (Chaos Monkey)，以鍛造出刀槍不入的容錯 (Fault Tolerance) 體質。

---

## 前言：寫滿防禦的程式碼，不等於防禦成功

在我們之前的架構設計中，我們加入了微服務的**熔斷器 (Circuit Breaker)**、Redis 的 **Active-Active (雙活跨區備援)**、以及 Kubernetes 的自動重啟 **Auto-Healing** 機制。

架構圖畫得漂漂亮亮，但你敢拍胸脯保證：
_「如果今天美東機房突然停電，我們寫的路由，真的能在 2 秒內完美把流量全轉交給東京機房嗎？」_
_「如果付款 API 無預警延遲高達 30 秒，我們的熔斷器真的會『啪』一聲跳開，而不是讓這 30 秒卡死我們首頁所有 10 萬名訪客的執行緒池？」_

如果我們只是在測試機 (Staging) 用假的綠色交通號誌假裝測試，那當真的災難來襲，公司絕對倒閉。
**唯一的解法，就是在風和日麗、大家都還醒著在上班的平常天，主動引爆核彈！**

---

## 1. 瘋狂的主動出擊：混沌工程的哲學

**混沌工程 (Chaos Engineering)** 不是在搞破壞，它是一門「在系統不穩定的條件下，於**生產環境 (Production)** 進行受控實驗，提早發掘隱患」的科學。

### 🦍 釋放混沌猴子 (Chaos Monkey)

Netflix 在將全公司業務轉移至 AWS 雲端之初，他們痛定思痛：與其每天提心吊膽擔心雲端伺服器哪天會無預警拔插頭 (EC2 Termination)，不如他們自己寫一隻名為 **Chaos Monkey** 的病毒小程式！

- **行徑**：這隻猴子會在平日的隨機時間點，**直接把正式營運環境、正在服務百萬觀眾看劇的伺服器，活生生地按下關閉電源 (Kill)！**
- **重生**：因為猴子天天在拔插頭，工程師被迫把所有的微服務寫成了無狀態 (Stateless)，並強化了 Kubernetes 的自動替補機制。只要一部機器死亡，立刻會有另一台機器在秒級之間接管替補。Netflix 達成了業界最恐怖的成就：**「機器天天在死，但使用者連影片中的一句台詞都沒有卡住過。」**

---

## 2. 混沌工程的四部演習曲

不要一上來就把整個資料庫 Format 掉，那叫犯罪。一場受控的混沌實驗 (Chaos Experiment) 必須嚴格遵從四大步驟：

1. **確立穩態 (Steady State)**：
   我們現在必須在儀表板 (Grafana/Datadog) 上定義什麼叫作「正常」。例如：正常狀態下，首頁讀取延遲 (P99 Latency) < 100ms，每分鐘訂單成立數 = 500 筆。
2. **提出假設 (Hypothesis)**：
   開始祈禱災難不會害慘我們：「我們擁有 3 台關聯式資料庫容錯機制。假設我今天把『其中 1 台』強行斷網，剩餘 2 台應該要無縫接管。我們**假設**首頁延遲依舊會小於 100ms，且訂單筆數不會掉出正常範圍。」
3. **引入災難 (Inject Faults)**：
   放出猴子！使用如 Gremlin 或是 Chaos Mesh 工具。
   - 把付款微服務 CPU 강迫榨乾至 100%。
   - 故意針對 Redis 發起注入長達 500ms 的延遲 (Network Delay)。
   - （甚至像大廠的 Chaos Gorilla 大金剛級別演習：直接切斷一整個地區 AZ 機房的對外網路）。
4. **驗證或修復 (Verify or Abort)**：
   緊盯儀表板！如果訂單筆數沒有崩跌，恭喜，你設計的熔斷器與容錯架構 (Fault Tolerance) 是真實有效的！
   如果一旦發現大量 500 Error，**立刻按下「終止實驗按鈕 (Abort/Rollback)」回收猴子**，開始查修我們的架構漏洞，總比它在半夜三點崩潰好幾百倍。

---

## 3. 防禦性程式設計的最高指導原則 (設計容錯性)

如果你寫的微服務即將面臨這群瘋猴子的洗禮，你該怎麼未雨綢繆？

- **優雅降級 (Graceful Degradation)**：當 Amazon 發現「猜你喜歡」的 AI 推薦引擎掛機了，它不會把整個首頁搞得噴白畫面。它會啟動 B 計畫：直接秀出一排寫死在記憶體裡的「歷史十大熱門商品」。只要能結帳，顧客根本不知道 AI 掛了。
- **超時與重試陷阱 (Timeout & Retry Storm)**：猴子讓某個 API 變得很慢。請務必在所有 API 請求掛上嚴格的 Timeout (例如 2 秒)。重試 (Retry) 時絕不可一秒內連打，必須搭配**指數退避 (Exponential Backoff, 每次重試間隔 1秒、2秒、4秒...)** 與隨機抖動 (Jitter)，否則全伺服器的微服務一起同時瘋狂重試，會把剛剛修好的資料庫用「自己的流量 DDoS 連擊」再次揍死。

---

## 💡 Vibecoding 工地監工發包訣竅

在使用 AI Agent 建構後端微服務之間的錯亂網路呼叫與高可用性系統架構圖時：

> 🗣️ `「你在撰寫這支呼叫『外部天氣 API』或是『內部金流微服務』的 Client Wrapper 時，嚴禁不加思索地直接使用 axios.get！我們即將接受 SRE 團隊的【混沌工程 (Chaos Engineering)】極端演習考驗。請你一定要為我引入 Resilience4j (或是 JS 對應的熔斷器套件)，為這個連線點掛上最嚴格的【Timeout (超時斷開)】與【Circuit Breaker (熔斷器)】防線！並配備【優雅降級 (Fallback) 函式】回傳安全的預設快取資料，確保這支爛 API 不管延遲多高，都不會拖垮我們的主執行緒與網頁加載體驗！」`
