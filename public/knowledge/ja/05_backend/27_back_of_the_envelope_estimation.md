# 27. 架構師的第六感：信封背面估算法 (Back-of-the-envelope Estimation)

> **類型**: 系統設計的數學量化與心智模型
> **重點**: 系統設計面試 (System Design Interview) 永遠的第一道關卡。如果你連伺服器每秒要承受多少次炮擊都算不出來，你憑什麼提議要用 Kafka 或 Cassandra？本篇帶你揭開矽谷頂尖架構師在星巴克餐巾紙上徒手估算出頻寬與伺服器數量的神秘武功。

---

## 前言：寫下架構藍圖前，請先「算命」

「信封背面估算法(Back-of-the-envelope Estimation) 是一項能夠在短時間內，透過一套簡化的假設，推導出合理系統規模的估算技術。」 —— ByteByteGo (Alex Xu)。

當 PM 發包一個「請做一個類似 Twitter 的發文與推播流系統」給你時。資淺工程師會馬上打開 IDE 開始寫 CRUD；強悍的架構師則會拿起紙筆，詢問 PM：

- 「我們預計日活躍用戶 (DAU) 是多少？」
- 「每位使用者平均一天發幾篇文？」
  然後，架構師會在三分鐘內告訴你：**「我們需要 50 台 Web Server、3 顆分片巨型資料庫，以及 30 GB/s 的內網網路設備。」** 這不是玄學，這是純粹的算數。

---

## 1. 必備的三大黃金常數

在踏入心算領域前，你必須把幾個作業系統與物理學的天花板限制刻在腦海裡：

1. **時間的鴻溝**：
   - 記憶體 (RAM) 讀取 1MB：$\approx 250\text{ \mu s}$ (微秒)。
   - 固態硬碟 (SSD) 循序讀取 1MB：$\approx 1\text{ ms}$ (毫秒)。
   - 美國東岸傳封包到西岸 (Round Trip)：$\approx 150\text{ ms}$。**(這是網路傳輸的神之界線，光速的限制。這也是為何我們非得在各地佈署 CDN 的鐵證！)**
2. **高併發的換算公式：一天的秒數**
   - 1 天 $= 24 \text{ hr} \times 60 \text{ min} \times 60 \text{ s} \approx \mathbf{100,000 \text{ 秒}}$ (抓整數算最快！精確值為 86400)。
3. **資料大小梯隊**：
   - 字元 = 1 Byte
   - KB ➡️ MB ➡️ GB ➡️ TB ➡️ PB (皆相距一千倍 / $10^3$)。
   - 一張圖片抓緊 2MB、一部 1 分鐘的高清短片抓 50MB。

---

## 2. 三分鐘餐巾紙實戰演練：估算 Twitter 規格

**📍 [情境]：你要設計一個支援發布包含圖片的新微型部落格。**

### 步驟 A. 敲定大前提 (Assumptions)

- 全球月活躍用戶 (MAU) 3 億。日活躍用戶 (DAU) 算一半：**1.5 億 (150 Million)**。
- 每個 DAU 每天發 2 篇純文字文 (每篇 100 Bytes) + 每 10 人有 1 人會貼一張圖 (2 MB)。

### 步驟 B. 預估 QPS (吞吐量 - Queries Per Second)

伺服器的一秒能處理多少壓力？這決定了你的 Nginx 跟 API Gateway 怎麼調配。

- **每日總發文量**：$1.5\text{ 億 DAU} \times 2 = \mathbf{3\text{ 億次請求 / 每日}}$。
- **👉 平均 QPS**：$3\text{ 億} \div 100,000\text{ 秒(每天)} = \mathbf{3,000\text{ 次請求 / 秒}}$。
- **🚨 峰值 QPS (Peak QPS)**：依照經驗法則，尖峰流量（如突發大新聞）通常是平均值的 2 倍。所以，**我們的系統一定要能扛住 $6,000 \text{ QPS}$！**

_(註：如果一台常規 Node.js + Express 能扛 500 QPS，你就知道最少要準備 12 台 API 伺服器作為常備軍。)_

### 步驟 C. 預估儲存槽開銷 (Storage)

我們的硬碟要切多大？我們買得起雲端空間嗎？

- **純文字表單容量**：$1.5\text{ 億} \times 2\text{ 篇} \times 100\text{ Bytes} = \mathbf{30 \text{ GB / 天}}$。(關聯式資料庫根本毫無壓力)。
- **媒體庫爆炸量 (圖片 S3/MinIO)**：$1.5\text{ 億} \times 10\% \text{(機率)} \times 2\text{ MB} = \mathbf{30 \text{ TB / 天}}$。
- **5 年的總成本**：$30\text{ TB} \times 365 \times 5 = \mathbf{54,000 \text{ TB} = \mathbf{54 \text{ PB}} !}$
  _(結論：資料庫只要一個集群主從備份就能搞定；但靜態資源，如果我們不上雲端的大型物件存儲 S3，也不弄 CDN，自己買硬碟搭建，這間公司馬上就會破產倒閉。)_

### 步驟 D. 網路頻寬估算 (Bandwidth)

伺服器主機不僅要看 CPU/RAM，網卡會不會爆掉也很重要。(通常上傳被稱為 Ingress，下載稱為 Egress)。

- **每秒產生的圖片負載量**：上方的每天 30 TB $\div 100,000 = \text{每秒 } \mathbf{300 \text{ MB / s}}$ (這對一般的千兆光纖網路卡來說算是吃重，須建立起媒體專屬的上傳微服務)。

---

## 💡 Vibecoding 工地監工發包訣竅

與其只告訴 AI 你要寫什麼功能，更頂級的做法是在給 Claude 的 Prompt 第一段，直接砸下你的環境估算參數。當 AI 認知到你在做的是怪物級別的工程，它的產出邏輯就會瞬間從腳本仔躍升至資深架構師層級：

> 🗣️ `「AI 架構師請注意，你現在要建置的商品搶購模組 (Flash Sale)，預估 Peak QPS 將逼近 20,000 且 95% 為查詢流量。請不要給我普通的 MySQL 讀寫腳本！我要求這個架構第一層利用 Redis Cluster 作抗擊緩衝，並以非同步的消息隊列（消息負擔估計每秒產生 5MB）卸載訂單落庫壓力！程式碼結構請以 Node.js + Worker Thread 為主軸寫出具備可伸縮性的雲原生源碼。」`
