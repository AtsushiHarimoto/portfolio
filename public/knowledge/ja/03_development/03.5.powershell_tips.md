# 03.5. PowerShell 開発ヒントと環境トラブルシュート (PowerShell Tips & Troubleshooting Playbook)

> **種類**: ターミナル開発実務 (Terminal development craft)  
> **重点**: Windows PowerShell が Moyin プロジェクトを動かす際に直面しがちな権限やパスの障害を整理し、再現性のあるエイリアススクリプトを提供します。

---

## 概要
PowerShell は Microsoft エコシステムに豊富なオブジェクトモデルをもたらしますが、Node.js、Git、その他のオープンソースツールチェーンを走らせるとき、実行ポリシー (Execution Policy) やファイルロックに起因するエラーが頻発します。本稿では、ローカル開発が `MAX_PATH` やポリシー制限で止まらないよう守る、おなじみのコマンドとショートカットをまとめました。

---

## 1. `node_modules` 島を強制的に空にする
フロントエンド依存の階層が壊れたとき、Windows 上の PowerShell は Linux の `rm -rf` を真似しきれません。Node モジュールは深いパスと読み取り専用ロックを生成するので、`Remove-Item` は途中で失敗しやすく、ディレクトリが残ってしまいます。

### 🌟 業界標準解法：`rimraf` に任せる
`rimraf` は Windows のパス地獄を想定して npm コミュニティが作ったクロスプラットフォーム削除ツールです。グローバルインストール不要で `npx` から呼び出すだけで、長いファイル名に引っかかることなく消去できます。

```powershell
# フロントエンドのルートから実行する。長いパスでも中断しない
npx rimraf .\node_modules\
```

### 代替：PowerShell 標準パラメータ
PowerShell 内で完結させたい場合は、下記のように再帰的かつ強制的にロックを解除します。

```powershell
# -Recurse で下位も走査、-Force で読み取り専用を解除
Remove-Item -Recurse -Force .\node_modules\
```

---

## 2. プロジェクト専用ショートカット (Profile Aliases) を作る
絶対パスを何度も打つのは生産性を下げるだけです。高頻度の移動やクリーン操作を `$PROFILE` に登録しておけば、PowerShell 起動時に自動的にロードされます。

1. 設定ファイルを開く（なければ作成を促されます）。

```powershell
notepad $PROFILE
```

2. 以下のスニペットを末尾に貼り付けて保存し、PowerShell を再起動してください。

```powershell
# Moyin プロジェクトのショートカット
$MOYIN_ROOT = "D:\AI-Novel-Projects\Moyin"

function mo-api { Set-Location "$MOYIN_ROOT\projects\api" }
function mo-web { Set-Location "$MOYIN_ROOT\projects\moyin-web" }
function mo-game { Set-Location "$MOYIN_ROOT\projects\moyin-game-v1\website" }

function rmf {
    param([Parameter(Mandatory=$true)]$Path)
    Remove-Item -Recurse -Force $Path
}
```

再起動後は `mo-api` でバックエンドディレクトリへ瞬時に移動でき、`rmf` は Linux 風の全消去を明示的なパスで模倣します。

---

## 3. クロスプラットフォーム Node 実行環境の落とし穴
Moyin は macOS/Linux 向けの Node 18 と Windows 向けの Node 22 を併存させています。以下のガードを守れば、双方の開発者が揃って整合性を保てます。

- **ロックファイルの規律 (`pnpm-lock.yaml`)**：Windows で依存差異が出ても絶対に削除しないでください。両プラットフォームの依存構造が一致する唯一の証です。
- **エンジン制約 (`package.json` の `engines`)**：全サブプロジェクトが `"node": ">=18.0.0"` を宣言しており、この範囲を逸脱すると installer が即座に異常終了します。
- **バイナリ再構築**：`node-sass` や `esbuild` のようなネイティブモジュールで C++ の互換性エラーが出たら、現在のモジュールを破棄して再インストールします。

```powershell
npx rimraf .\node_modules\
pnpm install
```

---

## 4. システムレベルの権限障害
「このシステムではスクリプトの実行が無効になっています」という赤い警告は PowerShell が安全のためにスクリプトを遮断しているサインです。管理者権限で下記コマンドを実行し、ローカル作成スクリプトは許可しつつ他所からのコードには署名を求めるようにします。

```powershell
# ローカルで作成したスクリプトを許可し、ダウンロードは署名付きに制限
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

`Y` で確認すれば、ブートストラップスクリプト、エイリアス設定、pnpm フックが安全に走るようになります。
