# 08. Moyin MCP アーキテクチャ（Architecture）

## MCP Server アーキテクチャ図

`moyin-mcp-server` は中央ディスパッチ（Dispatch）ハブとして機能し、フロントエンド UI とバックエンドの各種レンダリングサービスを接続します。

```mermaid
graph LR
    subgraph "Frontend (Vue 3)"
        WebUI[Drama Studio UI]
    end

    subgraph "MCP Core (FastAPI)"
        API[API Endpoints]
        WS[WebSocket / PubSub]
        Celery[Celery Dispatcher]
    end

    subgraph "Storage"
        Redis[(Redis / Cache)]
        DB[(MongoDB / StoryPacks)]
    end

    subgraph "Workers（分散処理）"
        TTS[TTS Worker]
        Comfy[ComfyUI Worker]
        Video[Video Render Worker]
    end

    WebUI <-->|HTTP/WS| API
    API <--> WS
    WS <--> Redis
    API <--> Celery
    Celery --> TTS
    Celery --> Comfy
    Celery --> Video

    style API fill:#ccf,stroke:#333
    style WS fill:#ccf,stroke:#333
    style Redis fill:#f9f,stroke:#333
    style Comfy fill:#f96,stroke:#333
```

## 通信プロトコル

- **Command Channel**: 制作コマンドの送信に使用します（例：`start_render`）。
- **Status Sync**: Redis PubSub ベースのリアルタイム状態同期。フロントエンド UI がタスクの進捗を監視します。
- **Data Sync**: `StoryPack` をノード間のデータ交換フォーマットとして使用します。
