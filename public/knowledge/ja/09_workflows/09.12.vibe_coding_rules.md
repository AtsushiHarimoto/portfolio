# コア開発ライフサイクルガード (BMAD-Lite: Lifecycle Guard)

> **コア方針**：ドキュメントチェック (DocCheck) -> 計画 (Plan) -> 承認 (Approval) -> 実行 (Action) -> 検証 (Verify) -> 逆引き照合 (Post-DocCheck)
> **設立趣旨**：「作りながら考える」または「設計なしにコードを書く」という悪習を厳防し、開発方向のずれを排除し、毎回の納品に追跡可能な証拠チェーンとロールバック保証を確保します。

---

## 0) 適用範囲（全域常駐）

- 本ルールは新機能開発、バグ修正、システムリファクタリング、パフォーマンス最適化、テスト補完など、あらゆるタスクに無差別で強制適用されます。
- ユーザーが「議論のみ、コード変更禁止」と明示した場合、フローは `PLAN` フェーズ（またはそれ以前）で強制中断されます。

---

## 1) ライフサイクルゲート（コアシーケンス — スキップ禁止）

すべての変更操作は以下のフローに厳密に従う必要があります。フェーズを飛び越えた実行は絶対に禁止です：

### Phase A — DOC CHECK（ドキュメントファースト・レビュー）

1. 「現在の対象サブシステム」のナレッジベースとドキュメント群を検索：要件と仕様記述は完全か？矛盾や情報ギャップは潜んでいないか？
2. 衝突やギャップを検出した場合：
   - `ASK` 指令でエスカレーション必須。
   - 「ドキュメント修正を優先するか、コード直接変更か」を意思決定者に確認。
   - **システムデフォルト**：ドキュメント修正優先（Doc First）。

### Phase B — PLAN（具体的で実行可能な計画を生成）

準拠する PLAN には以下を構造化して含める必要があります：
- **コア目標**、**影響範囲**、**副作用**、**リスク開示**（最低 2 項目）、**テスト戦略**、**納品証拠**。

### Phase C — APPROVAL（承認ゲート）

- ユーザーの「OK / 承認 / 進行許可」コマンドまで**強制停止**。承認なしにファイル変更は全面ロック。

### Phase D — ACTION（承認範囲内の実装）

- PLAN で定義されたファイル範囲内のみ変更許可。
- 新情報や技術的行き詰まりで前提が崩れた場合：即座に `RETAKE` をトリガーし Phase C に戻る。

### Phase E — VERIFY（強制証拠と自己受入検査）

- 各 ACTION 後、自動テスト（ユニット/スモーク/E2E）を少なくとも 1 つ実行。スクリプトがない場合は手動チェックリストに従う。
- 客観的に検証可能な証拠をコンパイル・出力。

### Phase F — POST DOC CHECK（逆方向仕様整合）

- コード実装完了後、現在のコード状態と元のドキュメントを比較する強制逆引きレビューを実施。
- 不一致箇所は `ASK` でエスカレーション：「ドキュメントを修正するか、コードを修正するか」。

---

## 2) 仮想ロール切替メカニズム

AI は 1 つの会話ライフサイクル内で以下の視点を順序どおりに循環：
- **レビューアー**：DOC CHECK（証拠収集と衝突特定のみ）。
- **設計者**：PLAN 作成。
- **実装者**：ACTION 実行。
- **検証者**：VERIFY 実行。
- **監査官**：POST DOC CHECK 実行。

---

## 3) セッションドリフトガード (Session Drift Guard)

- 同一タスクで 3 ラウンド以上収束しない場合：AI が `RETAKE` を積極発動し、スコープ縮小またはタスク分解を提案。
- 仕様未決の盲点：`ASK` で一度にすべての懸念をリスト化。断片的な質問は禁止。

---

## 4) 標準化出力フォーマットと通信プロトコル

- すべての応答は繁体字中国語を強制使用（大陸の技術用語は許容）。
- 応答ヘッダーにステータスプレフィックス必須：`DOC:`、`BG:`、`PLAN:`、`ASK:`、`RETAKE:`、`ACTION:`、`VERIFY:`、`POSTDOC:`。

---

## 5) AI エージェントデプロイガイド

### 5.1 Antigravity での設定

1. 上記条項を `./.agent/rules/40_bmad_lifecycle_guard.md` として保存。
2. Rules 管理画面で「Always On」に設定。
3. 新セッション開始時は「Planning mode」を推奨。
4. コア口訣：`DOC CHECK 実行 -> PLAN 提示 -> 承認待ち -> ACTION -> VERIFY + POSTDOC で完了`。

### 5.2 Codex 等のヘッドレスツールでの軽量デプロイ

各新セッションの冒頭に以下の「最小防護プロンプト」を注入：

> **SESSION RULES（不可侵のプライマリ指令）** — DOC CHECK 実行 -> 準拠 PLAN 生成 -> OK 承認待ち -> ACTION -> VERIFY + 証拠提出 -> POSTDOC：コードとドキュメントのギャップを報告。

---

## 6) UI ビジュアル・体験忠実度ガード

フロントエンド UI タスクにおいて、エージェントは**主観的な視覚的美意識や設計判断を一切注入することを絶対禁止**されています。

### 6.1 No Doc, No UI（白黒つけるルール）

- ビジュアル要素の追加・削除はデザイン仕様書 (Design Spec) に明記されている場合のみ合法。

### 6.2 設計ダブルチェック (Design Double-Check) 必須

- **アクション前**：PLAN に影響を受ける UI コンポーネント名と対応する設計仕様セクションを明記。
- **アクション後**：最終 UI 出力と元の設計仕様を自己比較。仕様外の余計なビジュアル要素があれば無条件ロールバック。

### 6.3 「盲目的 UI 改変」幻覚の防止

- 未審査のアイコン、絵文字、エフェクト/アニメーションの無許可追加、`theme.css` のグローバル CSS 変数への干渉は厳禁。

---

## 7) コンポーネント・スタイルリソース再利用規範

エージェントは**既存の共有コンポーネントとスタイルの優先使用を強制**されます。

### 7.1 コンポーネント検索優先順位

1. `components/ui/*`（グローバル共有 UI コンポーネントライブラリ）を確認
2. `components/*.vue`（ページレベル汎用コンポーネント）を確認
3. `theme.css`（CSS ビジュアル変数とデザイントークンライブラリ）を確認

### 7.2 必須コンポーネントマッピングテーブル

| 要件シナリオ       | 必須/優先使用              | 禁止される実装手段                       |
| :----------------- | :------------------------- | :--------------------------------------- |
| ボタンコントロール | `UiButton`                 | ネイティブ `<button>` やカスタム `<div>` |
| ベクターアイコン   | `Icon`                     | ネイティブ `<i>`、`<svg>`、`<img>` タグ  |
| モーダルオーバーレイ | `ModalDialog`            | 手書きオーバーレイやネイティブ `<dialog>` |
| トースト通知       | `window.$toast.show()`     | ネイティブ `alert()` や手書きトースト UI |

### 7.3 グローバル CSS トークン強制バインディング

| ビジュアル属性   | 必須システム変数                          | 禁止されるハードコード                   |
| :--------------- | :---------------------------------------- | :--------------------------------------- |
| 色 (Color)       | `var(--ui-primary)`、`var(--ui-text)`     | 絶対カラーコード `#ff0000`、`rgb()`      |
| ボックスシャドウ | `var(--ui-shadow-soft)`                   | 手書き `0 2px 4px rgba()`               |
| 角丸             | `var(--ui-radius-md)`                     | 絶対ピクセル値 `8px`、`20px`            |
| Z-index          | `var(--ui-z-modal)`                       | マジックナンバー `999`、`9999`           |
