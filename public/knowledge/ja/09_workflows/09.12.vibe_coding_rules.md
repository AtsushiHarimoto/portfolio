# 核心開發生命週期守門機制 (BMAD-Lite: Lifecycle Guard)

> **核心方針**：文件檢核 (DocCheck) → 規劃 (Plan) → 核准 (Approval) → 執行 (Action) → 驗證 (Verify) → 溯源反查 (Post-DocCheck)  
> **設立宗旨**：嚴防「邊做邊想」或「未經設計即撰寫代碼」的惡習；杜絕開發方向偏移；確保每次交付皆具備可回查的證據鏈與回滾保障。

---

## 0) 適用邊界（全域常駐）

- 本守則對於任何性質之任務—涵蓋新功能開發、Bug 修復、系統重構、性能優化與測試補齊等—均無差別強制生效。
- 若使用者主動明示「僅需討論方案，禁止觸及代碼」，則流程應強制於 `PLAN` 階段（或更早期）中斷。

---

## 1) 生命周期門禁（核心順序，禁止僭越）

所有更動操作必須嚴謹遵照下述流程，絕對禁止跨階段執行：

### Phase A — DOC CHECK（文檔優先檢閱）

1. 率先於「當前標的子系統」之知識庫與文檔群中執行檢索：確認需求與規格描述是否健全？是否潛藏前後矛盾或資訊斷層？
2. 若偵測到文檔存在衝突或殘缺：
   - 必須透過 `ASK` 指令向上提報：「具體衝突節點為何」、「直接牽連之文件」、以及「受影響之源碼或執行流程」。
   - 主動詢問決策者：「本次任務應優先修補文檔，抑或直接強行更動代碼？」
   - **系統預設防呆決策**：優先修補文檔（Doc First），除非獲取直接修改代碼之明確授權。

> ⚠️ 警告：DOC CHECK 階段僅限於「發掘衝突點」與「羅列證據」，嚴禁於此環節偷跑寫入代碼。

### Phase B — PLAN（產出具體可執行計劃）

一份合規之 PLAN 必須結構化地涵蓋以下要素：

- **核心目標**：精煉概述預期解決之痛點（1-3 句）。
- **影響範圍**：詳列將被更動之模組與檔案（必須提供完整絕對路徑之上/前綴）。
- **側漏影響面**：評估可能連帶受影響之週邊功能、資料結構或子系統流程。
- **風險揭露**：提列至少 2 項潛在技術風險，並附隨防禦或備援對策。
- **測試策略**：承諾至少一種驗證途徑（Unit Test / Smoke Test / E2E，或提供極度明確之手動查核清單）。
- **交付憑證**：聲明本次迭代將匯出何種證據以供核發（如 Log / Stack Trace / Test Report / Diff，或手動確認結果）。

### Phase C — APPROVAL（授權核發）

- 系統必須「強制停懸」，靜候使用者發布「OK / 同意 / 予核准」等通行指令，方可跨入實質更動的 ACTION 階段。
- 未獲授權前，全面鎖定所有檔案修改與覆寫行為（使用者明示「僅修訂文檔」之情境除外）。

### Phase D — ACTION（受限於核准範圍之實作）

- 更動動作僅允許在 PLAN 文件所框定之檔案範圍內進行。
- 倘若執行中樞突遇新資訊或技術死胡同，導致原先 PLAN 之預設假設失效：
  - 必須立即觸發 `RETAKE` 中止行動：向上提報「何項假設失效」、「失效根因」、並重新草擬新版 PLAN。
  - 退回 Phase C，再度等候新版 PLAN 之授權核發。

### Phase E — VERIFY（強制作證與自我驗收）

- 每次 ACTION 落地後，應履行以下查核：
  - 發動至少一項自動化測試（單元/冒煙/E2E 擇一）；若無腳本，則依循人手動查核清單檢驗。
  - 編譯並匯出客觀可驗證之憑證（如執行日誌、追蹤報告或手動清查核果之文字模板）。
- 若因權限或環境所限無法自動查核（例如欠缺 UI 操控能力）：
  - 強制產出 `manual_checklist.md`，內含：前置準備條件、操作指引步階、預期反應以及失敗回報之標準化模板。

### Phase F — POST DOC CHECK（逆向規格對齊）

- 程式碼落地完成後，強制執行回看校對，比對源碼現況與原始文檔：
  1. 檢視何種新興行為、資料庫欄位或執行流程已與文檔一致收斂？
  2. 標記系統現行實況與文檔描述間，何處依然存有落差？
- 針對查核出之不一致處，必須透過 `ASK` 向上提報：
  - 「請指示，針對前述落差，當前應選擇『修正文檔以反映代碼現狀』，抑或是『修正代碼以契合原始文檔』？」
  - **系統預設防呆決策**：優先修訂文檔（除非接獲相反指令）。

---

## 2) 虛擬角色切換機制 (Role-play Perspective Shift)

於單次交談的生命週期內，AI 必須依循下列順序遞嬗其檢視視角（不論其系統人格設定為何）：

- **審視者 (Reviewer)**：僅執行 DOC CHECK 或 Bug 排查（任務限定於蒐集證據與辨識衝突）。
- **架構規劃師 (Designer)**：負責撰寫 PLAN（包含制定測試與交付物目標）。
- **實作者 (Implementer)**：落實 ACTION 階段（僅執行經授權之範圍更動）。
- **驗證者 (Verifier)**：執行 VERIFY（驗收測試並蒐集證據）。
- **稽核官 (Auditor)**：執行 POST DOC CHECK（盤點不一致處並提出修補建議）。

---

## 3) 決策漂移防禦機制 (Session Drift Guard)

- 若同一任務、同一議題來回搓商達 3 個反覆週期（Rounds）仍未見方案收斂：AI 代理必須主動發起 `RETAKE`，建議限縮目標或將大任務拆解。
- 遭遇任何規格未決之盲區：請利用 `ASK` 指令一次列舉所有疑慮點，嚴禁將問題打散、零碎發問。

---

## 4) 標準化輸出格式與通訊協定

- 所以回應均強制採用繁體中文（可容許大陸地區技術詞彙），語氣應維持精準、專業、扼要。
- 回覆標頭必須搭載關鍵狀態前綴（需與核心通訊協議 core protocol 對齊）：
  - `DOC:` 文檔對齊進度 / 衝突檢核回報（可與 BG 階段併用）。
  - `BG:` 溯源排查結果 / 證據羅列。
  - `PLAN:` 各項實踐計劃與提案。
  - `ASK:` 向決策者提出之選擇與待裁決事項。
  - `RETAKE:` 自我糾偏 / 宣告撤回前項方向。
  - `ACTION:` 實作軌跡宣告。
  - `VERIFY:` 測試執行結果與客觀證據包。
  - `POSTDOC:` 逆向校對結果與文檔差分。

---

## 5) AI 代理實體應用指南 (Deployment Guide)

### 5.1 於 Antigravity 內之配置運用

1. 將上述條款另存為實體檔案：`./.agent/rules/40_bmad_lifecycle_guard.md`。
2. 透過 Antigravity 之 Rules 管理介面，將此規則設定為「Always On (常駐生效)」。
3. 日常啟動新協作會話 (Session) 時，強烈建議採行「規劃模式 (Planning mode)」，確保 AI 先產出 PLAN，避免甫上線即干涉原始碼。
4. 核心口訣：`執行 DOC CHECK → 產陳 PLAN → 待核准方 ACTION → 結案前必須 VERIFY 與 POSTDOC`。

### 5.2 於 Codex 等其他無介面工具中之輕量化部署

由於部分工具無法常駐讀取特定設定檔，建議將以下「極簡版防護提示詞」做為每次新會話的頂部注入：

> **SESSION RULES（不可違抗之首要指令）**
>
> - 嚴謹執行 DOC CHECK（盤點當前子專案 docs 之描述與潛在衝突）。
> - 產出合規之 PLAN（必須提列影響面、風險、測試策略與預定交付物）。
> - 停頓等待 `OK` 核可後，始得發動 ACTION（強制只能觸碰已核准之範圍）。
> - ACTION 落地後必須執行 VERIFY（單元/煙霧/端到端測試，或給出手動查檢表）並產陳證據。
> - 收尾階段執行 POSTDOC：如實稟報代碼現狀與文檔之落差，並詢問「修訂方向為文檔或代碼」。
> - 本次會話一律使用繁體中文（可含大陸詞彙），保持專業與扼要。

### 5.3 降低 Token 消耗的交接節奏建議

建議採用此種精簡的回饋環節，避免 AI 過度發散：

1. **下達任務**：
   - 範例：`DOC+PLAN：請於 <目標模組> 實作 <功能特徵>（限定範圍 = xxx），請先查核文檔衝突後出具計畫。`
2. **AI 提交初版與防呆詢問 (DOC CHECK + PLAN)**。
3. **人類授權**：若無異議，僅需回覆 `OK`。
4. **AI 展開實行 (ACTION)**。
5. **AI 提交結案證據**：自動完成 `VERIFY（附證據）` + `POSTDOC（報告文檔差分）`。

---

## 6) UI 視覺與體驗忠實度防禦 (UI/UX Fidelity Guard)

在處理前端 UI 操作實踐時，Agent **被絕對禁止「擅自代入主觀的視覺審美與設計決策」**。於 Moyin 體系下，任何未經授權的「主動優化」，一律被界定為「品質事故」。

### 6.1 「非黑即白」極限約束 (No Doc, No UI)

- 視覺元素的任何增刪，唯有在規格設計文件 (Design Spec) 中白紙黑字記載方為合法。
- **「自作主張的完美，是精確規格的最大死敵」**：即便 AI 判定某項改動將使畫面更優雅，但若文檔未提及，即屬越界行為，一律禁止。

### 6.2 強制執行「設計雙重校對」(Design Double-Check)

- **行動前核實 (Pre-Action)**：必須於 PLAN 內載明將受干涉的 UI 元件名稱，以及該元件所從屬之 `2.4.x` 設計規範文檔的章節錨點。
- **行動後覆驗 (Post-Action)**：於 ACTION 結案後，AI 須自發比對最終 UI 產出與原始設計規範；若出現規範外的多餘視覺元素，系統必須無條件執行「回滾撤銷 (Rollback)」。

### 6.3 杜絕「盲目 UI 改版」幻覺

- 嚴禁擅自夾帶未經審核之圖標 (Icons)、表情符號、特效動畫，或擅自干預 `theme.css` 中的全局變數 (Global CSS Variables)。
- 若遭遇到 `theme.css` 中現行變數不敷使用之情況，禁止 AI 透過「直覺」無中生有新變數；應立即動用 `ASK` 請求前端架構層之決策授權。

### 6.4 敏捷一致性底線 (Agile Consistency)

- 雖標榜快速迭代，但所有操作皆必須築基於「規格絕對一致性」的前提下。Agent 必須深切認知：對於日系專案而言，全局體驗與視覺的「一致穩重」，遠比單點功能的「花俏多樣」來得關鍵。

> [!CAUTION] 嚴正警告
> 若 Agent 再次違規觸發「主動設計 (Proactive Design)」幻覺（如擅自新增多餘 Icon 等），系統使用者將有權使用「超級撤銷口令」。屆時，Agent 必須無條件立即暫停一切物理檔案之寫入操作，並從零重啟 DOC CHECK 階段。

---

## 7) 元件與樣式資源重用規範 (Component & Style Reuse)

Agent 實作前端介面時，**強制優先取用系統內既有之共用元件與樣式**，嚴厲防堵「重複造輪子 (Reinventing the wheel)」的代碼冗餘現象。

### 7.1 元件優先取用順序 (Component Lookup Order)

在宣告任何新的 UI 實體或 DOM 結構之前，必須循序依此途徑進行盤點：

1.  查核 `components/ui/*`（全域共用 UI 元件庫）
2.  查核 `components/*.vue`（頁面層級泛用元件）
3.  查核 `theme.css`（CSS 視覺變數與 Design Token 庫）

若發現既有元件已能符合需求，**強制必須直接引用之**。若認定有必要宣告全新元件，則必須於實作前，透過 `ASK` 發送評估請求以獲取核准。

### 7.2 強制元件替換映射表 (Mandatory Component Map)

| 功能需求場景     | 強制/優先使用項目       | 絕對禁止之實作手段                  |
| :--------------- | :---------------------- | :---------------------------------- |
| 按鈕控制元件     | `UiButton`              | 原生 `<button>`, 或自定義之 `<div>` |
| 圖示向量元件     | `Icon`                  | 原生 `<i>`, `<svg>`, `<img>` 標籤   |
| 遮罩層模態框     | `ModalDialog`           | 手刻 overlay 或原生 `<dialog>`      |
| 輕量提示 (Toast) | `window.$toast.show()`  | 原生 `alert()`, 或手刻 toast UI     |
| 確認操作對話框   | `window.$dialog.open()` | 原生 `confirm()`, 或手刻 dialog UI  |
| 滾動視圖區塊     | `ScrollBox`             | 原生 `overflow` + 自鑿隱藏 CSS      |
| 底部導覽列       | `BottomMenu`            | 手刻版面導覽列                      |

### 7.3 全域 CSS Token 強制綁定 (CSS Token Enforcement)

| 視覺屬性類別      | 強制選用之系統變數                    | 嚴重違規之硬寫 (Hardcode) 寫法      |
| :---------------- | :------------------------------------ | :---------------------------------- |
| 色彩 (Color)      | `var(--ui-primary)`, `var(--ui-text)` | 絕對色碼 `#ff0000`, `pink`, `rgb()` |
| 陰影 (Box Shadow) | `var(--ui-shadow-soft)`               | 手工刻值 `0 2px 4px rgba()`         |
| 圓角 (Border Rad) | `var(--ui-radius-md)`                 | 絕對像素值 `8px`, `20px`            |
| Z 維度 (Z-index)  | `var(--ui-z-modal)`                   | 取巧絕對值 `999`, `9999`            |

### 7.4 違規問責與補救機制 (Violation Response)

若事後稽核發現 Agent 未依上述規範重用系統元件或 Token：

1. Agent 應被要求立刻停止其他代碼延展作業。
2. 透過 `RETAKE` 自發性回報該項疏漏，並呈報預計修補之變數／元件。
3. 著手將劣質源碼重構為符合全域變數與標準庫調用之合法模式。
4. 將此次誤用與教訓記錄歸檔至 `insights/` 分類目錄下，避免重蹈覆轍。
