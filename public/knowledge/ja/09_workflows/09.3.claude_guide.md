# 跨 Agent 協同作戰指南：Claude 規劃至 Antigravity 落地的最佳實踐

**前提要求**：您必須已建立系統級規則文件（`.agent/rules/*.md`）與 `AGENTS.md`，並強制要求所有 Agent 嚴格遵守以下核心紀律：

- **Doc-First 真理原則**：介入編碼前，優先檢視規格文檔。
- **門禁阻斷機制**：PLAN 提出 -> 靜待授權（OK） -> 獲准後方可 ACTION。
- **排錯推導秩序**：遭遇異常 (Bug/BG) 時，先陳列證據鏈與根因邏輯，而後提出解決方案。
- **成果交付驗證**：每次提交執行結果，皆須附帶不可竄改之證據（受影響檔案清單 / 終端機執行命令 / 結果截圖 / 人工驗證清單）。

---

## 0) 通用語境協議：高效啟動任務之標準句式

### 0.1 對位 Claude 的發包指令（專注於文檔梳理 / 需求澄清 / 架構對齊）

- **核心目的**：驅動 Claude 執行「文檔脈絡梳理 + 提取系統衝突點 + 產製具備高度可執行性之 PLAN」。
- **標準化輸入範本**：
  > `[PLAN 指令] 當前任務欲推進 <功能名稱/異常問題>，工程範疇限定於 <目標子系統目錄>。請依循 Doc-First 原則檢索現有 docs（需排除系統規則目錄），識別出現狀與文檔之衝突 / 架構缺口。最終輸出請包含：1. 衝突點清單 2. 規格文件修訂建議 3. 後續代碼落實之執行計畫。`

**Claude 合格輸出之檢驗指標**：

- **DOC CHECK 校驗日誌**：明確羅列已參閱之文檔路徑。
- **衝突與斷層分析**：精確點出哪一項文檔條款與現行系統邏輯存在落差（精確標明文件路徑與段落）。
- **實作計畫 (PLAN)**：依序表列執行步驟、潛在影響邊界、操作風險及驗證基準。
- **阻斷點確認**：若涉文檔重構，系統必須於此處主動懸停，等待使用者核准（OK），絕對不可偷跑撰寫源碼。

### 0.2 對位 Antigravity 的轉發指令（專注於代碼落地與測試工程）

- **核心目的**：將 Claude 已經收斂對齊的架構決議，無縫轉譯為 Antigravity 可直接消化的執行工單。
- **標準化輸入範本**：
  > `[PLAN 交接指令] 以下為規劃層 (Claude) 產出之 DOC CHECK 校驗日誌、衝突清單與最終實作藍圖。請嚴謹遵循系統 rules 執行作業流程：請先覆述您對任務之理解 + 條列欲變更之間檔案矩陣與路徑 + 設計驗證命令。未獲我方回覆 OK 前，禁止進入 ACTION 階段。`
  > （隨後貼上 Claude 之產出內容：包含文檔引用清單、衝突逐條析離、實裝步驟矩陣、測試驗證對策等）

**Antigravity 協同控制節奏**：

- Antigravity 解析並交付實作 PLAN -> 使用者審閱並發出 `OK` -> 系統解鎖 ACTION 權限。
- 實作完成後 -> 使用者僅需檢驗客觀 Evidence（檔案異動清單 / 命令執行結果日誌），以決定是否允收。

---

## 1) 軟體開發場景（RUN-DEV）：新功能建置

### 1.1 規劃階段 (Claude)：架構文檔先行對齊

**下達指令**：

- > `[PLAN 啟動] 新功能模塊：<xxx>。鎖定範疇：projects/<目標子系統>。請發動 Doc-First：檢索 docs 目錄（排除規則資料夾）-> 提煉需求核心 -> 標定架構衝突與缺口 -> 產製「文檔修訂草案」與「代碼實施 + 驗證規劃」。`

**預期產出**：

- 檢附於 `docs/review/issues/<日期>_feature_xxx.md` 之報告（或於文本框直接標準化呈現）。
- 針對文檔之缺陷提出章節級別的修訂草案，並嚴格自律不涉及任何源碼變體。

### 1.2 落地階段 (Antigravity)：依據核准藍圖實作

**下達指令**：

- > `[PLAN 交接] 遵循已核准之 Claude 規劃展開實作。嚴格限制：僅准許修改 <子系統源碼目錄>；作業完畢必須提出 Evidence（涵蓋測試命令與成功退出之日誌結果）。請先出示執行 PLAN，靜待核准。`

**驗收循環**：

- 回覆 `OK` -> 放行 Antigravity 執行 ACTION。
- 驗收階段聚焦查核：異動檔案路徑的正確性、指令執行的有效性以及關鍵 Log 片段。

---

## 2) 異常排除場景（RUN-DEV）：Bug 解析與日誌解譯 (BG)

### 2.1 規劃階段 (Claude)：精確定位與規格校時

**下達指令**：

- > `[BG 調查] 觀測到異常行為：<貼上日誌片段或重現步驟>。限縮範疇：<受影響之子系統>。請發起根因分析溯源（提出直接證據鏈：定位問題源碼區塊與衝突之文檔條款）-> 列出候選根因機率排序 -> 提出「不變更現有產品需求」前提下的最小化修復方案 -> 配置對應之驗證步驟。`

**預期產出要點**：

- **證據鏈 (Evidence)**：明確標示問題發生之檔案核心函數或呼叫堆疊 (Call Stack)。
- **規格核對**：查核既有文檔是否對此行為有預期規範。
- **修復規劃**：最具外科手術級精準度的微小代碼更動，附隨測試覆蓋點。

### 2.2 落地階段 (Antigravity)：貫徹「最小化修復」原則

**下達指令**：

- > `[BG 交接] 根因分析報告與最小化修復藍圖入下。請先覆述根因邏輯與代碼干涉邊界，產出包含驗證命令的執行 PLAN，等待核准指令 ('OK') 後始可啟動 ACTION。`

---

## 3) 品質保證場景（RUN-QA）：構建自動化 E2E / 回歸測試防護網

### 3.1 規劃階段 (Claude)：需求轉譯為「可測度規格」

**下達指令**：

- > `[PLAN 啟動] 針對 <特定功能/模組> 需設立白盒 E2E (或 Smoke) 測試防線。依循 Doc-First，先行掃描 docs（略過規則包）-> 列舉 test_cases 規格矩陣（需包含前置斷言條件/執行步驟/預期狀態/覆蓋盲區）-> 揭示當前不可測死角或遺漏之用例 -> 產出完整測試設計藍圖（歸檔至 tests/docs）。`

### 3.2 落地階段 (Antigravity)：測試框架先行，實質測試後墊

**下達指令**：

- > `[PLAN 交接] 依據 test_cases 規格矩陣，先行建立測試檔案骨架與用例文檔，待骨架穩固後再行填補實際測試腳本。安全護欄：請先呈報 PLAN（預計生成之檔案/測試命令/預期覆蓋目標），確認核准再 ACTION。每次 ACTION 完成皆需交付包含命令與日誌之 Evidence 結構包。`

---

## 4) Agent 交接極致化：建構「不可篡改之最小化移交封包」

從 Claude 手段取得之結論，強烈建議模組化為以下 5 大結構區塊，再平移指派予 Antigravity。如此將能徹底封殺 Antigravity 基於臆測而暴走「發散編碼」的機率：

1. **工程範疇 (Scope Lock)**：明確綁定僅能操作之目標子系統與對應資料夾。
2. **規格基底 (Doc Check Result)**：標明此次變更是立基於哪些規格文檔之上。
3. **衝突釐清 (Gap & Conflicts)**：逐條披露規格與現況的落差，並標註段落錨點。
4. **執行藍圖 (Finalized Plan)**：拆解為線性且不可逆之操作步驟矩陣。
5. **驗證憑證 (Verify Strategy)**：定義具體欲執行之 shell command 或人工具體核對清單。

---

## 5) 人工智慧指揮官的邊界控制（人類的兜底極簡原則）

在多 Agent 協同體系中，各自職能清晰不容混淆：

- **Claude**：擔綱「需求轉譯、架構文檔對齊、Review 稽核與 Issue 警報產製」。
- **Antigravity**：擔綱「代碼重構、指令環境操控與測試工程之實體落地」。
- **決策者 (您的任務)**：專責於三項降維打擊的兜底防線：
  1. **計畫審批**：僅對合乎系統限制的 PLAN 核發通行證，絕不為 AI 偷跑發散的代碼買單。
  2. **證據核查**：冷酷地唯「結果日誌 (Evidence) 與實際命令輸出」是問，不與 AI 就「推測邏輯」爭辯其合理性。
  3. **停損重啟 (RETAKE)**：一旦溝通發散輪次達 3 次以上而未見收斂標準解，果斷下達 RETAKE 指令（強行縮攏邊界限制或將主目標下切為細瑣子任務）。

---

## 6) 最簡型控制元（One-Liner Commands）：最大化 Token 成本效益

- **驅動新功能開發**：
  > `[PLAN] 核心目標=<...> 系統邊界=<...> 啟動 Doc-First，優先提交文檔衝突分析與代碼實作計畫表。`
- **啟動排錯追蹤**：
  > `[BG] 異常表面現象=<...> 復現路徑=<...> 硬性要求：提示完整證據鏈+依機率排序之候選項+絕對最小化之修復代碼。`
- **強制戰略軸轉 (Pivot/Fix)**：
  > `[RETAKE] 當前分析方向已偏移焦點=<...> 強制導回原定邊界=<...> 撤回前項預設，重新提交純淨版 PLAN。`
- **嚴格範疇防禦陣線**：
  > `[PLAN] 此次作業擁有最高禁制令：僅允許更動 <projects/xxx> 模塊，其餘全域系統一律無條件鎖定。`
- **版本提交門禁閘門**：
  > `[COMMIT] 準備封裝版本。先條列：變動摘要矩陣+擴散影響面評估+自動測試驗證結果。未獲我方 OK，系統禁止觸發 git commit 指令。`
