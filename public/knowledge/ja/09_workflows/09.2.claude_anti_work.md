# Vibe Coding 自動化開發流程 (SOP)

## 總覽

- 針對特定功能開發或問題排查：使用者需先界定**工程範圍 (Project Scope)** 與**工作模式 (RUN-DEV / RUN-QA)**。
- 對應之標準工作流：
  - **指令 `RUN-DEV`**：執行常態開發 SOP
    - `新功能/Bug 修復/架構重構 -> 修正/編寫文檔 -> 代碼實作 -> Code Review -> 修復缺陷 -> 審核通過 (Review OK)`
  - **指令 `RUN-QA`**：執行品質保證與測試 SOP
    - `理解 UT/QA 規範文檔 -> 修正/編寫測試計畫 -> 實作測試工程 -> Code Review -> 修復缺陷 -> 測試關鍵路徑 -> 產出測試報告`

---

## 工程範圍 (Project Scope) 邊界控制

- 啟動任務前，必須嚴格依據下列目錄層次進行索引；即便任務橫跨多個子系統，亦必須**於每個步驟明確標註當前作業所屬之 Scope**（如：API / moyin-web / moyin-game / tests）。
- 嚴格守則：
  - 所有操作必須侷限於指定的工程路徑內，**嚴禁跨界修改**（除非使用者明確授權跨系統重構）。
  - 檢索與閱讀文檔時，系統需自動排除特定之雜訊目錄，不將其視為有效之需求依據。

### 排除目錄關鍵字清單

以下目錄（或包含同名關鍵字之資料夾）在作為「需求依據」層面時，一律強制排除：

- `pending`
- `review`
- `output`
- `LOG`
- `plan`
- `5.QA`
- `5.Q&A`
- `temp`
- `memo`
- `TODO`
- `reiview`（拼寫錯誤之歷史產物亦視為排除範圍）

> 例外說明：`review` 目錄為**最終輸出產物**之存放處（本 SOP 流程中會要求寫入），但其不可反向作為「需求輸入」之來源。

---

## 工程專案矩陣（依據 Repository 實體結構配置）

### 模塊 1：API 服務層 (Backend API Gateway)

- 代碼源碼區：`projects/moyin-gateway/web2api`
- 文檔根目錄：`projects/moyin-gateway/docs`
- 審查記錄存放區：`projects/moyin-gateway/docs/review`

### 模塊 2：前端 Web 應用 (Moyin Web - Creator Studio)

- 代碼源碼區：`projects/moyin-web`
- 文檔根目錄：`projects/moyin-web/docs`
- 審查記錄存放區：`projects/moyin-web/docs/review`

### 模塊 3：遊戲前端引擎 (Moyin Game V1)

- 代碼源碼區：`projects/moyin-game-v1/website`
- 文檔根目錄：`projects/moyin-game-v1/docs/`
- 審查記錄存放區：`projects/moyin-game-v1/docs/review`

### 模塊 4：自動化測試工程 (QA Automation)

- 代碼源碼區：`projects/tests`
- 文檔根目錄：`projects/tests/docs/`
- 審查記錄存放區：`projects/tests/docs/review`

### 交付物歸檔區 (Deliverables)

- 統一存放路徑：`deliverables/`
- 標準化產出結構：
  - `deliverables/01_要件定義`
  - `deliverables/02_基本設計`
  - `deliverables/04_開発`
  - `deliverables/05_単体テスト`
  - `deliverables/06_結合テスト`
  - `deliverables/07_総合テスト`
  - `deliverables/08_リリース`
  - `deliverables/09_運用保守`

> 註記：deliverables 模塊專注於「對外會審/跨團隊對齊」之高階文件化輸出，與系統底層之工程 `docs` 定位不同；工程規範仍以 `projects/*/docs` 為唯一技術真理來源。

---

## 工作流通用約束（適用橫跨 RUN-DEV 與 RUN-QA）

- **語言規範**：強制使用繁體中文（可保留專有名詞或大陸技術慣用語）。除非特定工作流有獨立語言覆寫設定要求（如 fixed English rules）。
- **邏輯檢核先行**：介入實作前，必須預先判定需求是否存在：邏輯悖論 / 技術不可行性 / 歷史文檔衝突。
  - 若偵測到衝突：**必須先行指出衝突點與擴散影響，主動請示使用者選擇「修改規格文檔」或「覆寫底層代碼」**，未獲明確同意前，禁止擅自發動大規模重構。
- **範疇鎖定**：搜索與產出行為僅限於本次指派之工程範圍之內。

---

## 核心開發 SOP（RUN-DEV 流程）

### Step 1：規格文檔先行審查（產品經理視角）

- **輸入 (Input)**：使用者提供 功能目標 / 缺陷描述 / 限定之工程範圍（若未聲明範圍，AI 須主動觸發 ASK 詢問）。
- **執行動作 (Action) - 由規劃層 AI (如 Claude) 負責**：
  1. 於指定系統之 `docs/` 目錄中過濾出技術規格與歷史約束條件。
  2. 若比對出「規劃文檔 vs 運行代碼」存在實質出入，需匯整為一份審查異動記錄 (Review Issue)，歸檔至：
     - `{工程文檔根}/review/issues/`（標準命名範例：`DocReview-YYYYMMDD.md`）
  3. 若使用者輸入之需求具備破碎性或內部矛盾，則彙整為疑慮清單 (FAQ) 輸出至：
     - `{工程文檔根}/review/FAQ/`（標準命名範例：`FAQ-YYYYMMDD.md`）

### Step 2：文檔修訂（Doc-First 原則）

- **執行動作 (Action)**：規劃層 AI 提出規格文件的補丁與修訂段落。
  - 限於當前 Scope 之 `docs/` 範疇。
  - 修訂之內容必須具備足夠的精確度，以實質支撐下游的程式實作與單體驗證。
- **決策分歧**：若使用者否決文檔修訂方案，流程將強制復歸至 Step 1，重新對齊需求邊界。

### Step 3：代碼實作（執行層視角 - Antigravity/Codex）

- **執行動作 (Action)**：執行層 AI 嚴格依據最新通過審核之文檔進行編碼實作。
- **異常中斷機制**：於實作過程中若遭遇邏輯斷層或規格未定義區：
  - 立即中斷編碼，將技術疑點拋出至 `{工程文檔根}/review/FAQ/`，交由規劃層 AI 進行判定與補齊。
  - 待規格文檔補齊後，方可重啟此步驟（嚴禁 AI 基於黑箱臆測擅自實作）。

### Step 4：代碼品質審查（技術架構師視角）

- **執行動作 (Action)**：規劃層 AI 掃描並審閱：
  - 本次任務產出之 Code Diff（限額內）。
  - 受關聯影響的核心邏輯模塊。
- **產出 (Output)**：產製深度審查報告至 `{工程文檔根}/review/issues/`（標準命名範例：`CodeReview-YYYYMMDD.md`）。
- **風險分級標準**：
  - **P0 阻斷級 (Blocker)**：將引發核心功能故障 / 數據破壞 / 嚴重資安漏洞 / 測試阻斷。
  - **P1 嚴重級 (Critical)**：高機率誘發邊界 Bug / 系統可維護性惡化 / 狀態機流轉邏輯矛盾。
  - **Risk 潛在風險 (Warning)**：當前無顯著影響，但於未來擴充或對接大型模型時存在結構性隱患。

### Step 5：封裝與提交策略（版本控制把關）

- **執行動作 (Action)**：執行層 AI 於請求確認前，必須展示完整之前置證據清單：
  - 本次異動之檔案矩陣 (Changed Files Matrix)。
  - `git diff` 概要呈現。
  - `git log -n 10` 之追蹤檢視。
- **任務收尾**：按功能點與邏輯獨立區塊逐步執行 `commit`（確保每個提交點皆具備清晰的工程語義）。若存在模稜兩可的改動，需啟動 ASK 向使用者再次核實。

---

## 質量保證與測試 SOP（RUN-QA 流程）

### Step 1：測試文檔矩陣審查（QA 工程師視角）

- **輸入 (Input)**：使用者提供 待驗證之功能邊界 / 回歸測試標的 / 限定工程（通常為 `projects/tests` 掛載主目標工程）。
- **流程起點**：規劃層 AI 率先檢索目標工程之 docs，查核對應之「可測性標準」與「驗收準則 (Acceptance Criteria)」。
- **阻斷條件**：一旦發現「測試要求 vs 代碼現狀」存在結構性不符，必須**強制中止測試計畫推進**，並產出衝突報告至：
  - `{目標工程文檔根}/review/issues/` 或 `projects/tests/docs/review/issues/`。

### Step 2：測試計畫構築 (Test Planning)

- **執行動作 (Action)**：於 `projects/tests/docs/` 內產製系統性測試設計藍圖，規格應涵蓋：
  - 測試涵蓋邊界 (In-Scope) 與豁免範圍 (Out-of-Scope)。
  - 測試用例清單 (涵蓋單元測試 Unit / 端到端 E2E / 非功能性指標 Non-functional)。
  - 測試所需之 Mock 數據、前置狀態、斷言預期 (Expected Results)。
  - 系統崩潰時的標準化回報結構。
- **產出歸檔**：統一收編至 `projects/tests/docs/plan/`（標準命名範例：`TestPlan-YYYYMMDD.md`）。

### Step 3：實裝測試工程（執行層落地）

- **執行動作 (Action)**：執行層 AI 依循測試計畫，於 `projects/tests` 目錄內撰寫測試腳本程式碼。
- **未知狀況反饋**：遭遇模糊邊界時，同樣寫入 `review/FAQ/` 尋求規劃層介入補完。

### Step 4：測試腳本品質審閱 (Code Review on Tests)

- **審核重點**：檢驗 `projects/tests` 內的防護腳本。評量測試覆蓋率是否切中核心風險點，並驗證斷言邏輯之嚴謹度。
- **產出歸檔**：寫入 `projects/tests/docs/review/issues/`（標準命名範例：`TestCodeReview-YYYYMMDD.md`）。

### Step 5：測試結案與版本提交

- **產出 (Output)**：自動產製綜合測試結論報告至 `projects/tests/docs/report/`（標準命名範例：`TestReport-YYYYMMDD.md`）。
- **版本控制**：與 RUN-DEV 的 Step 5 相同，嚴守檢視 diff、log 與逐步提交之紀律。

---

## 指揮中樞：日常交互協議建議

- 開啟新任務序列時，使用者必須傳遞三大基底指令：
  1. **選擇推進模式**：`RUN-DEV` 抑或 `RUN-QA`。
  2. **宣告範疇邊界**：API / moyin-web / moyin-game / tests（可複選，但至少其一）。
  3. **定義任務標的**：一句話描述核心命題 + 期望的驗收狀態（越具象越有利於 AI 對齊）。
- 若前置資訊殘缺：AI 必須觸發 `ASK` 機制補齊條件，方可授權進入 Step 1。

---

## 💡 常見問題與操作除錯 (FAQ & Troubleshooting)

### Q: 為何 AI 代理 (例如 Claude) 時常越俎代庖，未經許可即主動修改代碼並要求檢驗？是我方環境配置錯誤，還是 AI 理解力不足？

**A: 此類過度活躍 (Over-proactive) 的行為，源自於系統底層約束條件「未被強制載入」或「語義威懾力不足」，實非 AI 模型智力缺陷。**

技術研判與常見根因有三：

1. **全域規則 (System Prompt) 逸失載入鏈**：
   - 於新建對話、切換操作目錄，或跨越 Session 時，`.agent/rules` 內的強制規範未能被完整讀取寫入至當下文本窗內。
   - 表現特徵：AI 流暢地分析了架構，並順水推舟直接產出了替換的代碼塊，甚至直接執行替換動作。
2. **防禦語義過於軟性 (Soft Guidelines vs. Hard Constraints)**：
   - 例如僅定義「請遵循 PLAN 再 ACTION」，AI 架構會將其解讀為「建議最佳實踐」，進而自我裁量提早進入編碼階段。
   - 若未明文標註「未獲許可，系統層級禁止修改任何實體檔案/產出 diff diff」，防護即會失效。
3. **對話誘導效應 (Prompting Bias)**：
   - 當使用者拋出的指令帶有「該怎麼修？」、「請給我修復方案」等祈使句構時，容易觸發 AI 的代全本能，直接繞過架構設計環節。

### 🛡️ 標準防禦與修正對策：

要徹底馴服並固化 AI 行為模式，需採取以下強制介入手段：

**1. 戰術層面 (對話閘門前置)**：
於每一次提報 Bug (BG) 或新需求時，強行安插不可逾越之指令閘門：

> **「⚡ 硬性限制：本回合僅授權執行架構分析 (PLAN) 與根因排查。嚴禁進行任何檔案覆寫、patch 生成與 diff 套用操作。無我方回覆 'OK' 確認，系統不得推進代碼實作環節。」**

**2. 戰略層面 (底層規則加固)**：
深入 `00_core_protocol.md` 或 `06_documents_first.md` 等最高層級約束文件，寫入頂層防護指令：

> **「🚨 核心鐵律 (Zero-Tolerance Policy)：未獲使用者明確 OK 授權前，禁止發動任何牽涉工作區實體檔案狀態變更之操作，包含但不限於：源碼自動修正、patch 檔匯出、diff 指令套用與 git commit 行為。」**

**最終裁定**：AI 代理具備優異的操作能力，問題的解方在於我方必須建立精確且零容忍的「可判定硬性禁令」，並於每次會話初始化時落實權限把關。
