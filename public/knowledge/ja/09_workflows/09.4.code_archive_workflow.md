# コードアーカイブ (Archive) とログ管理ワークフロー設計

> **種類**: ワークフロー (Workflow)
> **日付**: 2026-01-03
> **出典**: 会話 ID（2026-01-03 セッション）

---

## 概要

git diff 分析、SCOPE 自動識別、1.repo.md 生成、漏れチェックを通じたコードコミットとアーカイブの自動化フローです。すべての開発サイクルに完全なアーカイブ記録を確保します。

---

## 背景

複数プロジェクト並行開発環境では、コードコミットとアーカイブに以下の課題が発生します：

1. **クロス SCOPE 混合コミット**：異なるプロジェクトの変更が 1 つのコミットに混在
2. **変更記録の欠如**：コミットメッセージのみで詳細な開発記録がない
3. **ファイル漏れ**：コミット後に未追跡ファイルを発見
4. **アーカイブの不統一**：ディレクトリ命名の混乱で検索が困難

---

## 詳細設計

### コア設計原則

#### 1. SCOPE 自動識別

ファイルパスに基づき変更が属する SCOPE を自動識別します：

```markdown
## SCOPE パスマッピング (Path Mapping)

変更ファイルパスに基づき SCOPE を自動識別：

| パスプレフィックス            | SCOPE         | アーカイブディレクトリプレフィックス |
| ----------------------------- | ------------- | ------------------------------------ |
| `projects/moyin-gateway/`     | API           | `SCOPE_API_`                         |
| `projects/moyin-web/`         | moyin-web     | `SCOPE_MOYINWEB_`                    |
| `projects/moyin-game-v1/`     | moyin-game-v1 | `SCOPE_MOYINGAME_`                   |
| `projects/tests/`             | QA            | `SCOPE_QA_`                          |
| `.agent/rules/`               | RULES         | `SCOPE_RULES_`                       |
| `.agent/workflows/`           | WORKFLOWS     | `SCOPE_WORKFLOWS_`                   |
| `scope/`                      | SCOPE_META    | `SCOPE_META_`                        |
```

#### 2. アーカイブディレクトリ命名規則

タイムスタンプで一意性を確保：

```
scope/SCOPE_{SCOPEプレフィックス}_{機能名}_{YYYYMMDD_HHmmss}/
```

**例**：
- `scope/SCOPE_MOYINGAME_VN_STAGE_UI_20260103_160948/`
- `scope/SCOPE_API_AUTH_FIX_20260103_160948/`

#### 3. 1.repo.md テンプレート

開発過程の完全な記録：

```markdown
# {機能名} 開発記録

## 基本情報
- **SCOPE**: {SCOPE}
- **機能名**: {機能名}
- **開発日時**: {YYYY-MM-DD HH:mm:ss}
- **アーカイブディレクトリ**: {パス}

## 変更概要
{簡潔な説明、1-3 文}

## 変更ファイルリスト
### {SCOPE} 変更
- [M] {ファイルパス} - {簡潔な説明}
- [A] {ファイルパス} - {簡潔な説明}

## 技術的変更
### 新規機能
- {新機能の一覧}

### バグ修正
- {修正済みバグの一覧}

## 影響範囲
- **影響モジュール**: {モジュール一覧}
- **API 変更**: {あり/なし}

## テスト結果
- **テスト種別**: {Unit / Smoke / E2E / 手動}
- **テスト状態**: {合格 / 失敗 / 未テスト}

## コミットメッセージ
```

{生成されたコミットメッセージ}

```

```

#### 4. クロス SCOPE 検出

クロス SCOPE 変更が検出された場合、ユーザーに ASK：

```markdown
**クロス SCOPE 変更が存在する場合**：
- 各 SCOPE の変更ファイルリストを提示
- `ASK:` でユーザーに確認：「クロス SCOPE 変更を検出しました。個別に処理しますか？」
- 推奨：SCOPE ごとに本ワークフローを個別実行
```

#### 5. 漏れファイルチェック

コミット後に git status を確認：

```markdown
### Step 6: 漏れファイルチェック
// turbo
`git status --porcelain` を実行し、未コミットファイルの有無を確認。

**漏れファイルが見つかった場合**：
- 漏れファイルリストを提示
- `ASK:` でユーザーに確認：
  1. 「以下の未追跡ファイルを検出しました。コミットに含めますか？」
  2. 確認後：「これらのファイルが属する SCOPE を指定してください。」
```

---

## 適用シナリオ

- **シナリオ 1：機能開発完了** — `/run-archive` でアーカイブとコミットを実行。
- **シナリオ 2：バグ修正** — 修正プロセスとテスト結果を記録。
- **シナリオ 3：リファクタリング** — リファクタリング範囲と影響を記録。
- **シナリオ 4：ドキュメント更新** — ルールやワークフローファイル更新後の変更記録をアーカイブ。

---

## 注意事項

- **機能名は全て大文字英語**：アンダースコア区切り、例：`VN_STAGE_UI`、`API_AUTH`
- **異なる SCOPE は個別コミット**：混合コミットを回避しコミット履歴を明確に。
- **1.repo.md は完全記入必須**：全セクション記入（最低 N/A）。
- **アーカイブディレクトリは scope/ ルートに統一**：サブディレクトリ不可、フラット構造を維持。

---

_本ドキュメントは `/run-wiki conversation` により自動生成されました_
