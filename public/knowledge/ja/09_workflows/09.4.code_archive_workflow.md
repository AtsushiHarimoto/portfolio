# 代碼歸檔與日誌管理工作流設計

> **類型**: 工作流程  
> **日期**: 2026-01-03  
> **來源**: 對話 ID (2026-01-03 會話)

---

## 摘要

自動化代碼提交與歸檔流程，透過 git diff 分析、SCOPE 自動識別、1.repo.md 生成和遺漏檢查，確保每次開發都有完整的歸檔記錄。

---

## 背景

在多專案並行開發之環境下，代碼提交與歸檔常遭遇以下痛點：

1. **跨 SCOPE 混提交**：不同專案的變更被混在同一個 commit
2. **缺少變更記錄**：只有 commit 訊息，缺少詳細的開發記錄
3. **遺漏文件**：提交後才發現有文件未追蹤
4. **歸檔不規範**：歸檔目錄命名混亂，難以查找

---

## 詳細內容

### 核心設計原則

#### 1. SCOPE 自動識別

根據文件路徑自動識別變更屬於哪個 SCOPE：

```markdown
## SCOPE 路徑映射

依據變更文件路徑自動識別 SCOPE：

| 路徑前綴                  | SCOPE         | 歸檔目錄前綴       |
| ------------------------- | ------------- | ------------------ |
| `projects/moyin-gateway/` | API           | `SCOPE_API_`       |
| `projects/moyin-web/`     | moyin-web     | `SCOPE_MOYINWEB_`  |
| `projects/moyin-game-v1/` | moyin-game-v1 | `SCOPE_MOYINGAME_` |
| `projects/tests/`         | QA            | `SCOPE_QA_`        |
| `.agent/rules/`           | RULES         | `SCOPE_RULES_`     |
| `.agent/workflows/`       | WORKFLOWS     | `SCOPE_WORKFLOWS_` |
| `scope/`                  | SCOPE_META    | `SCOPE_META_`      |
```

#### 2. 歸檔目錄命名規範

使用時間戳確保唯一性：

```
scope/SCOPE_{SCOPE前綴}_{功能名稱}_{YYYYMMDD_HHmmss}/
```

**範例**：

- `scope/SCOPE_MOYINGAME_VN_STAGE_UI_20260103_160948/`
- `scope/SCOPE_API_AUTH_FIX_20260103_160948/`

#### 3. 1.repo.md 模板

完整記錄開發過程：

```markdown
# {功能名稱} 開發記錄

## 基本資訊

- **SCOPE**: {SCOPE}
- **功能名稱**: {功能名稱}
- **開發日期**: {YYYY-MM-DD HH:mm:ss}
- **歸檔目錄**: {歸檔目錄路徑}

## 變更摘要

{簡短描述，1-3 句話}

## 變更文件清單

### {SCOPE} 變更

- [M] {文件路徑} - {簡短說明}
- [A] {文件路徑} - {簡短說明}

## 技術變更

### 新增功能

- {列出新增的功能點}

### Bug 修復

- {列出修復的 bug}

## 影響範圍

- **影響模塊**: {列出受影響的模塊}
- **API 變更**: {是/否}

## 測試結果

- **測試類型**: {Unit / Smoke / E2E / 手動}
- **測試狀態**: {通過 / 失敗 / 未測試}

## Commit 訊息
```

{生成的 commit 訊息}

```

```

#### 4. 跨 SCOPE 檢測

若檢測到跨 SCOPE 變更，必須 ASK 用戶：

```markdown
**若存在跨 SCOPE 變更**：

- 列出各 SCOPE 的變更文件清單
- 使用 `ASK:` 詢問用戶：「檢測到跨 SCOPE 變更，是否需要分開處理？」
- 建議：按 SCOPE 分別執行本工作流
```

#### 5. 遺漏文件檢查

提交後檢查 git status：

```markdown
### Step 6: 檢查遺漏文件

// turbo
執行 `git status --porcelain`，檢查是否還有未提交的文件。

**若發現遺漏文件**：

- 列出遺漏文件清單
- 使用 `ASK:` 詢問用戶：
  1. 「系統偵測到以下未納入版控的文件，是否需要一併提交？」
  2. 收斂確認後，進一步詢問：「請指定該等文件所屬之 SCOPE？」
```

---

## 代碼/命令範例

### 範例 1：分析 git diff

```bash
# 獲取所有變更文件
git status --porcelain
git diff --name-only

# 輸出範例
M  projects/moyin-game-v1/website/src/pages/VnStagePage.vue
M  projects/moyin-game-v1/website/src/assets/style/theme.css
A  .agent/rules/05_style_guard.md
```

### 範例 2：SCOPE 識別邏輯

```markdown
變更文件清單：

- projects/moyin-game-v1/website/src/pages/VnStagePage.vue
- projects/moyin-game-v1/website/src/assets/style/theme.css
- .agent/rules/05_style_guard.md

SCOPE 分組：

- moyin-game-v1 (2 個文件)
- RULES (1 個文件)

檢測到跨 SCOPE 變更！
```

### 範例 3：Commit 訊息格式

```
[moyin-game-v1] VN Stage UI 樣式修復

修復 VnStagePage 組件的樣式問題，統一使用 theme.css 設計 token。

影響範圍: VnStagePage.vue, theme.css
測試狀態: 手動測試通過

歸檔: scope/SCOPE_MOYINGAME_VN_STAGE_UI_20260103_160948
```

---

## 適用場景

- **場景 1：功能開發完成**  
  開發完成後，執行 `/run-archive` 進行歸檔和提交。

- **場景 2：Bug 修復**  
  修復 bug 後，記錄修復過程和測試結果。

- **場景 3：重構**  
  重構代碼後，記錄重構範圍和影響面。

- **場景 4：文檔更新**  
  更新規則或工作流文件後，歸檔變更記錄。

---

## 相關資源

- [run-archive.md](../../../.agent/workflows/run-archive.md) - 代碼歸檔工作流
- [01_project_scope.md](../../../.agent/rules/01_project_scope.md) - 專案範圍定義
- [scope/](../../../scope/) - 歸檔目錄

---

## 注意事項

- ⚠️ **功能名稱必須全大寫英文**  
  使用下劃線分隔，範例：`VN_STAGE_UI`、`API_AUTH`

- ⚠️ **分開提交不同 SCOPE 的變更**  
  避免混提交，確保 commit 歷史清晰。

- ⚠️ **1.repo.md 必須完整填寫**  
  所有章節都要填寫，至少填寫 N/A。

- ⚠️ **歸檔目錄統一放在 scope/ 根目錄**  
  不要建立子目錄，保持扁平結構。

---

_本文檔由 `/run-wiki conversation` 自動生成_
