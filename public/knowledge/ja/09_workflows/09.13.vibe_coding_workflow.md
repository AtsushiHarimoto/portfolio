# Moyin Vibe Coding ワークフロー（DESIGN -> Tests -> Code -> Verify）

本ドキュメントでは「低コスト・追跡可能・高度に検証可能」な自動コード生成ワークフローを整理します。現在の協業ツールマトリクスに最適化された設計です：

- 上級 LLM（レビューアー役）と協力して権威ある `2.DESIGN.md` を生成。
- Codex が E2E テストスキャフォールディング (Scaffolding) を事前構築（初期は空シェルも可、受入境界を定義するため）。
- Antigravity に設計仕様に基づく精密なソースコード実装を指示。
- テスト結果が唯一の受入判定基準。不合格の場合、エラーログを Antigravity にフィードバックし全テスト合格（グリーンステート）まで収束修正を繰り返します。

---

## 1. 目標と境界制約

### コア目標

- 「コンセプト -> アーキテクチャ設計 -> コード実装 -> デプロイ検証」を高い再現性を持つ自動化パイプラインに変換。
- 複数ツール・複数モデルロール間の情報同期コストを大幅削減。
- 「テストが納品基準」の理念を強制導入し、「表面上は動くが内部は異常」な技術的負債を根絶。

### 非目標 (Non-Goals)

- 慎重な評価なしの「一括グローバルリファクタリング」は拒否。
- 高コストモデルによる長時間の無人エージェントタスクには依存しない。
- 単一ツールへのベンダーロックインなし。

---

## 2. コア規律（ルールファイルに固定化必須）

1. **SSOT (Single Source of Truth)**：本イテレーションの唯一の拠り所は `2.DESIGN.md`。
2. **小さなステップで素早く (Agile Iteration)**：1 タスクフローで 1 機能または 1 バグのクローズに集中。
3. **テスト先行 (Test-Driven)**：テストスクリプトは「発注契約」、コード実装は「履行納品」。
4. **グリーンライト放行 (Pass-to-Merge)**：全テスト合格でのみマージ許可。
5. **絶対ロールバック可能 (Rollback Ready)**：すべてのローカル変更は `git revert` で安全に前の安定状態に戻せること。
6. **ゴーストスコープ拒否 (No Ghost Scopes)**：DESIGN に明記されていない仕様外要件は無条件拒否。

---

## 3. 役割分担（現在の構成）

### 3.1 アーキテクチャ策定（Review 層）
**入力：** 生の要件/問題記述、システム現況、リソース制約。
**出力：** 権威ある `2.DESIGN.md`。

### 3.2 テスト防御（Design 層）
**担当：** Codex
**入力：** 承認済み `2.DESIGN.md`
**出力：** テスト仕様ファイル `tests/e2e/xxx.spec.ts`。

### 3.3 コード実装（Coding 層）
**担当：** Antigravity
**入力：** `2.DESIGN.md` + テストスキャフォールディング。
**出力：** `src/xxx.vue` 等の最終実装コード。

### 3.4 受入裁定（Verify 層）
**アクション：** ローカルターミナルでテストスクリプトを実行。
- 赤：検証失敗 -> クラッシュログとテスト失敗記述を Antigravity に再送。
- 緑：検証合格 -> マージとリリース権限を付与。

---

## 4. ツールサポート (VibeDev CLI)

本ワークフローでは `vibedev` CLI ツールの併用を強く推奨：

> **Note**: VibeDev は純粋な CLI 駆動ツールに完全リストラクチャリング済み。Web UI は廃止。

- **パイプライン自動化**：多段パイプライン連結（Design -> Code -> Review）を深くサポート。
- **ヘルスチェックプローブ**：API とマイクロサービスの自動ヘルス状態確認。
- **プロンプトテンプレートエンジン**：標準化・最適化済みプロンプトテンプレートライブラリを内蔵。

---

## 5. ディレクトリマッピングと成果物規約

- `docs/DESIGN/<feature>.md`：本イテレーション専用の設計契約（SSOT）。
- `tests/e2e/<feature>.spec.ts`：Playwright テストスクリプト。
- `src/...`：影響を受ける、または新規作成の機能ソースコード。
- `.agent/rules/core.md`：コアエージェント制約ルールライブラリ。
- （オプション）`docs/PROJECT-STATE.md`：グローバルステータスコントロールセンター。

---

## 6. パイプライン実行ステップ（標準化 SOP）

### Step 0：ブランチ隔離
- 命名規則：`feat/<feature_name>` または `fix/<bug_id>`。
- 鉄則：AI エージェントの変更は新規ブランチに隔離。メインラインへの直接コミットは禁止。

### Step 1：アーキテクチャ策定（Review）-> 2.DESIGN.md 生成
LLM レビューアーと共に `2.DESIGN.md` を精製・固化。

### Step 2：テスト防御（Design）-> E2E Spec スキャフォールディング生成
Codex が DESIGN を研究し `tests/e2e/<feature>.spec.ts` を生成。

### Step 3：コード実装（Coding）-> DESIGN ブループリントに基づく精密実装
Antigravity が DESIGN 仕様（必須）とテストスキャフォールディング（強く推奨）を研究し `src/...` を実装。

### Step 4：受入裁定（Verify）-> テスト駆動クローズ
E2E 自動テストスイートをローカルターミナルで実行：
- 赤：失敗 -> エラーパッケージを Antigravity に再送。
- 緑：合格 -> マージ承認、バージョン管理に記録。

---

## 7. 2.DESIGN.md 構造テンプレート（強く推奨）

```markdown
# <Feature_Name> アーキテクチャ設計仕様 (DESIGN)

## 0. 概要
- コア実装目標 (Goal):
- 仕様境界除外 (Non-goals):

## 1. ユーザーフロー
- エントリポイント (Entry):
- メインアクションパス (Main actions):
- エッジケースと例外 (Edge cases):

## 2. UI 仕様
- 影響ページ・コンポーネント (Page/Component):
- ステートバリエーション (States):
- ローディング/エラー/空状態 (Loading/Error/Empty):

## 3. データとステート
- グローバルステートキー (Store keys):
- 型とインターフェース定義 (Types/interfaces):
- 永続化戦略 (Persistence):

## 4. ビジネスロジックルール
- 条件分岐ルールリスト (Rule list):
- フォーム・データバリデーションルール (Validation rules):

## 5. 影響ファイルマトリクス
- src/...
- tests/e2e/...
- docs/...

## 6. 受入基準（客観的にテスト可能であること必須）
- AC1:
- AC2:
- AC3:

## 7. 最終リリースチェックリスト
- 自動テストトリガーコマンド (Commands):
- 手動ビジュアル確認ステップ (Manual checks):
```
