# 04.1. Style Guard Pattern

> **Type**: Practices & safeguards  
> **Date**: 2026-01-03  
> **Source**: Conversation log (2026-01-03)

---

## Summary

The Style Guard Pattern prevents AI from drifting outside the approved design vocabulary when crafting UI components. By forcing every change through Design Tokens, a scoped directory mapping table, and an ASK protocol, we keep CSS modifications 100% in sync with the live theme system.

---

## 1. Background & pain points

When an LLM helps write UI, these issues crop up fast:

1. **Creative Fill** – Without explicit guidance, the model invents hex codes, padding values, or Z-index levels that have no basis in the design system.
2. **Hard-coded style chaos** – It bypasses the token library and injects raw numbers, making a global theme swap impossible.
3. **Cross-project confusion** – Different repositories (`moyin-web` vs. `moyin-game-v1`) host their own `theme.css`, and the model often imports the wrong file.

These behaviors instantly break the design system, trigger repeated rework, and slash maintainability.

---

## 2. Core guard principles

### 2.1 Mandatory token matching

Before touching a Vue scoped style or any HTML-level styling, the assistant must consult the relevant `theme.css` and ensure every value maps to an approved token.

**Checklist**:

- Colors/backgrounds/gradients: `--ui-*`
- Z-index: `--z-*` or `--ui-z-*`
- Spacing (margin/padding/gap): `--ui-gap-*`
- Border radius: `--ui-radius-*`
- Shadow/glow: `--ui-shadow-*`
- Transitions/durations: `--ui-duration-*`

### 2.2 Scope mapping table

To avoid directory guesswork, we maintain a scope index so the assistant knows exactly which theme file correlates to each codebase:

| Sub-project | `theme.css` absolute path |
| :---------- | :------------------------ |
| **API Gateway** | N/A (backend-focused; skip style validation) |
| **moyin-web** | `projects/moyin-web/src/assets/style/theme.css` |
| **moyin-game-v1** | `projects/moyin-game-v1/website/src/assets/style/theme.css` |
| **QA automation** | N/A (scripts only; skip style gating) |

### 2.3 Missing token ASK protocol

If a requested style is absent from the target `theme.css`, the assistant halts and issues an ASK prompt:

```markdown
【SYSTEM ALERT】ASK: The following styles are required but missing from the theme token library:

- `background: linear-gradient(...)` (suggested token: `--ui-card-gradient-bg`)
- `z-index: 998` (suggested token: `--z-modal-blocker`)

【Choose next step】:
A) Grant permission to extend `theme.css` (I will provide the token patch).
B) Fall back to the closest existing token.
C) Allow a temporary hard-coded value and log a TODO for future refactor.
```

**Forbidden actions**:

- ❌ Deploy code that hard-codes numbers without explicit authorization.
- ❌ Rely on “ship now, refactor later” thinking for design tokens.

### 2.4 Anti-hallucination matrix

Trigger an ASK whenever one of these conditions arises:

| Edge condition | SOP |
| :-------------- | :-- |
| Specs leave a button’s size/position undefined | Pause and ASK the user for clarification |
| The required attribute lacks a token in `theme.css` | ASK the user whether to extend or compromise |
| Design tokens conflict with product specs | ASK for final arbitration |
| Unknown responsive breakpoint (e.g., md/lg) | ASK whether to support mobile, desktop, or both |
| The current scope has no `theme.css` yet receives a layout request | ASK whether to initialize the file |

---

## 3. Real-world workflow

### 3.1 PLAN: Declare style dependencies

Before writing Action code, document the tokens you will touch:

```markdown
## PLAN: Fix VN-stage panel focus drift

**Target scope**: moyin-game-v1

**Token dependencies**:
- `--ui-primary` (primary brand hue)
- `--ui-panel` (semi-transparent panel background)
- `--ui-gap-md` (medium spacing)
- `--ui-radius-md` (standard roundness)

**Reference spec**: `projects/moyin-game-v1/docs/2.DESIGN/2.4.UI_1.1.SPEC.md`
**Expected token additions**: none (all tokens already exist)
```

---

## 4. Related links & further reading

- [`05_style_guard.md`](../../../.agent/rules/05_style_guard.md) – Machine-readable rulebook for the Style Guard Pattern.
- [`03_coding_rules.md`](../../../.agent/rules/03_coding_rules.md) – Global coding/CSS standards.
- [`theme.css`](../../../projects/moyin-game-v1/website/src/assets/style/theme.css) – Concrete token implementation for `moyin-game-v1`.

---

_Generated and maintained by the Moyin knowledge automation system._
