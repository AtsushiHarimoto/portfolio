# Code Archive and Log Management Workflow Design

> **Type**: Workflow
> **Date**: 2026-01-03
> **Source**: Conversation ID (2026-01-03 Session)

---

## Summary

An automated code commit and archiving workflow that uses git diff analysis, automatic SCOPE identification, 1.repo.md generation, and omission checks to ensure every development cycle has complete archive records.

---

## Background

In a multi-project parallel development environment, code commits and archiving often suffer from these pain points:

1. **Cross-SCOPE mixed commits**: Changes from different projects bundled into a single commit
2. **Missing change records**: Only commit messages exist, without detailed development logs
3. **Omitted files**: Files discovered as untracked only after commit
4. **Inconsistent archiving**: Archive directory naming chaos makes retrieval difficult

---

## Detailed Design

### Core Design Principles

#### 1. Automatic SCOPE Identification

Automatically identify which SCOPE a change belongs to based on file paths:

```markdown
## SCOPE Path Mapping

Automatically identify SCOPE based on changed file paths:

| Path Prefix                 | SCOPE         | Archive Directory Prefix |
| --------------------------- | ------------- | ----------------------- |
| `projects/moyin-gateway/`   | API           | `SCOPE_API_`            |
| `projects/moyin-web/`       | moyin-web     | `SCOPE_MOYINWEB_`       |
| `projects/moyin-game-v1/`   | moyin-game-v1 | `SCOPE_MOYINGAME_`      |
| `projects/tests/`           | QA            | `SCOPE_QA_`             |
| `.agent/rules/`             | RULES         | `SCOPE_RULES_`          |
| `.agent/workflows/`         | WORKFLOWS     | `SCOPE_WORKFLOWS_`      |
| `scope/`                    | SCOPE_META    | `SCOPE_META_`           |
```

#### 2. Archive Directory Naming Convention

Use timestamps to ensure uniqueness:

```
scope/SCOPE_{SCOPE_PREFIX}_{FEATURE_NAME}_{YYYYMMDD_HHmmss}/
```

**Examples**:

- `scope/SCOPE_MOYINGAME_VN_STAGE_UI_20260103_160948/`
- `scope/SCOPE_API_AUTH_FIX_20260103_160948/`

#### 3. 1.repo.md Template

A complete record of the development process:

```markdown
# {Feature Name} Development Record

## Basic Information

- **SCOPE**: {SCOPE}
- **Feature Name**: {Feature Name}
- **Development Date**: {YYYY-MM-DD HH:mm:ss}
- **Archive Directory**: {Archive directory path}

## Change Summary

{Brief description, 1-3 sentences}

## Changed Files List

### {SCOPE} Changes

- [M] {file path} - {brief description}
- [A] {file path} - {brief description}

## Technical Changes

### New Features

- {List new feature points}

### Bug Fixes

- {List fixed bugs}

## Impact Scope

- **Affected Modules**: {List affected modules}
- **API Changes**: {Yes/No}

## Test Results

- **Test Type**: {Unit / Smoke / E2E / Manual}
- **Test Status**: {Passed / Failed / Not Tested}

## Commit Message
```

{Generated commit message}

```

```

#### 4. Cross-SCOPE Detection

If cross-SCOPE changes are detected, the system must ASK the user:

```markdown
**If cross-SCOPE changes exist**:

- List the changed files for each SCOPE
- Use `ASK:` to ask the user: "Cross-SCOPE changes detected. Should they be handled separately?"
- Recommendation: Execute this workflow separately per SCOPE
```

#### 5. Omitted File Check

Check git status after commit:

```markdown
### Step 6: Check for Omitted Files

// turbo
Execute `git status --porcelain` to check for any uncommitted files.

**If omitted files are found**:

- List the omitted files
- Use `ASK:` to ask the user:
  1. "The system detected the following untracked files. Should they be included in the commit?"
  2. After confirmation, follow up: "Please specify which SCOPE these files belong to."
```

---

## Code/Command Examples

### Example 1: Analyzing git diff

```bash
# Get all changed files
git status --porcelain
git diff --name-only

# Output example
M  projects/moyin-game-v1/website/src/pages/VnStagePage.vue
M  projects/moyin-game-v1/website/src/assets/style/theme.css
A  .agent/rules/05_style_guard.md
```

### Example 2: SCOPE Identification Logic

```markdown
Changed file list:

- projects/moyin-game-v1/website/src/pages/VnStagePage.vue
- projects/moyin-game-v1/website/src/assets/style/theme.css
- .agent/rules/05_style_guard.md

SCOPE grouping:

- moyin-game-v1 (2 files)
- RULES (1 file)

Cross-SCOPE changes detected!
```

### Example 3: Commit Message Format

```
[moyin-game-v1] VN Stage UI style fix

Fixed styling issues in VnStagePage component; unified usage of theme.css design tokens.

Impact scope: VnStagePage.vue, theme.css
Test status: Manual test passed

Archive: scope/SCOPE_MOYINGAME_VN_STAGE_UI_20260103_160948
```

---

## Use Cases

- **Scenario 1: Feature development complete**
  After development, run `/run-archive` to archive and commit.

- **Scenario 2: Bug fix**
  After fixing a bug, record the fix process and test results.

- **Scenario 3: Refactoring**
  After refactoring, document the scope and impact.

- **Scenario 4: Documentation update**
  After updating rules or workflow files, archive the change records.

---

## Related Resources

- [run-archive.md](../../../.agent/workflows/run-archive.md) - Code archive workflow
- [01_project_scope.md](../../../.agent/rules/01_project_scope.md) - Project scope definition
- [scope/](../../../scope/) - Archive directory

---

## Precautions

- **Feature names must be uppercase English**
  Use underscores as separators, e.g., `VN_STAGE_UI`, `API_AUTH`

- **Commit different SCOPEs separately**
  Avoid mixed commits to keep commit history clean.

- **1.repo.md must be fully completed**
  All sections must be filled; use N/A at minimum.

- **Archive directories go under the scope/ root**
  Do not create subdirectories; maintain a flat structure.

---

_This document was auto-generated by `/run-wiki conversation`_
