# 多 Agent 隔離開發方法論 (Parallel Universe)

> 類型：最佳實踐
> 日期：2026-01-19

## 背景

在多 Agent (Antigravity/Codex/Claude) 協作場景下，若所有 Agent 都在同一個物理目錄操作，容易發生：

- 檔案鎖定衝突 (File Locks)。
- `git index` 狀態混亂 (Staging area conflicts)。
- 臨時檔案互相覆蓋。
- 測試環境 (Dev Server) 端口衝突或依賴污染。

## 結論

採用基於 `git worktree` 的「平行宇宙」模式，實現**秒級環境隔離**，讓每個 Agent 擁有獨立的物理工作區，但共享 Git 對象庫。

### 核心機制

1. **主宇宙 (Main)**：保持乾淨，僅用於合併最終代碼。
2. **平行宇宙 (Worktree)**：每個任務 (`/iso start task-name`) 創建一個獨立目錄 `.worktrees/<task-name>`。
3. **環境複製**：自動從根目錄複製 `.env` 至隔離區，確保配置一致。
4. **收斂機制**：任務完成後 (`/iso finish`)，自動 Merge 回 Main 並銷毀平行宇宙。

## 操作指南

### 1. Antigravity (擁有 `/iso` 指令)

擁有最高權限與便捷操作：

- **開啟任務**：`/iso start <task-name>` (自動建立分支 `agent/<task-name>`)
- **完成任務**：`/iso finish <task-name>` (自動 Merge + Remove)
- **放棄任務**：`/iso drop <task-name>` (強制刪除)

### 2. Codex / Claude (使用 Skill)

透過自然語言呼叫 `git-worktree-manager` Skill：

- **Start**: "Use git-worktree-manager to create a worktree for task 'api-fix'."
- **Finish**: "Finish task 'api-fix', merge and cleanup."

## 可操作清單

- [ ] **權限配置**：確保 `.agent/skills`, `.codex/skills`, `.claude/skills` 均有 `git-worktree-manager`。
- [ ] **忽略配置**：`.gitignore` 必須包含 `.worktrees/`。
- [ ] **衝突處理**：若 `/iso finish` 遇到 Merge Conflict，流程會暫停，需人工介入主目錄修復後再次執行 Finish。

## 參考

- Skill: `git-worktree-manager`
- Workflow: `/iso`
- Config: `workspace/knowledge/11.claude_code/11.3.skills_example.md`
