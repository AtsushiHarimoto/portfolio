# Moyin Vibe Coding Workflow (DESIGN -> Tests -> Code -> Verify)

This document outlines a "low-cost, traceable, and highly verifiable" automated code production workflow designed to perfectly fit the current collaboration tool matrix:

- You collaborate with an advanced LLM (acting as Reviewer) to produce the authoritative `2.DESIGN.md`.
- Codex pre-builds E2E test scaffolding (initially allowed as empty shells to define acceptance boundaries).
- Antigravity is assigned to implement source code precisely according to the design spec.
- Test results serve as the sole acceptance criterion; if tests fail, error logs are fed back to Antigravity for convergent fixes until all tests pass (Green State).

---

## 1. Goals and Boundary Constraints

### Core Goals

- Transform "concept -> architecture design -> code implementation -> deployment verification" into a highly reproducible automated pipeline.
- Significantly reduce information synchronization costs across multiple tools and model roles.
- Enforce a "tests are the delivery standard" philosophy, eliminating "looks fine on the surface but broken underneath" technical debt.

### Non-Goals

- Reject ill-considered "one-shot global refactoring."
- Do not rely on expensive models for long-running unattended agent tasks (manage compute resources and budget).
- No vendor lock-in to a single tool (if Codex quota runs out, swap in another Reviewer model to keep the pipeline running).

---

## 2. Core Disciplines (Must Be Hardcoded into Rule Files)

1. **Single Source of Truth (SSOT)**: The only reference for this iteration is `2.DESIGN.md`.
2. **Small Steps, Fast Iteration**: Each task flow focuses on a single feature or single bug closure.
3. **Test-Driven Principle**: Treat test scripts as the "contract"; actual code implementation is the "fulfillment."
4. **Pass-to-Merge**: Only when all tests pass may code be approved for merge into the main line.
5. **Rollback Ready**: All local changes must be safely revertible to the previous stable state via `git revert`.
6. **No Ghost Scopes**: Any requirement not explicitly written into the DESIGN is unconditionally refused.

---

## 3. Role Assignment (Current Configuration)

### 3.1 Architecture Planning (Review Layer)

**Input:** Raw requirements/problem descriptions, system status, resource constraints.
**Output:** Authoritative `2.DESIGN.md` (complete spec with high actionability).

> The Reviewer's core value: Precisely translating vague requirement language into testable, codeable engineering contracts.

### 3.2 Test Defense (Design Layer)

**Execution Owner:** Codex
**Input:** Approved `2.DESIGN.md`
**Output:** Test specification file `tests/e2e/xxx.spec.ts` (initial test scaffolding is acceptable, but must precisely cover core execution paths).

> Building test scaffolding first forces the establishment of completion standards and objective acceptance assertions before any coding begins.

### 3.3 Code Implementation (Coding Layer)

**Execution Owner:** Antigravity (using cost-effective models)
**Input:** Authoritative `2.DESIGN.md` + pre-built test scaffolding (strongly recommended).
**Output:** `src/xxx.vue` or `src/modules/...` final implementation code.

### 3.4 Acceptance Ruling (Verify Layer)

**Action:** Trigger test scripts in the local terminal.
**Ruling:**

- Red: Verification failed. Export crash logs (Stack Trace) and failed test case descriptions, then re-dispatch to Antigravity for convergent fixes.
- Green: Verification passed. Grant Merge and Release permissions, and record results in the state transition document.

---

## 4. Tooling Support (VibeDev CLI)

This workflow strongly recommends the `vibedev` CLI tool to accelerate pipeline execution:

> **Note**: The VibeDev system has been fully restructured as a pure CLI-driven tool; the Web UI interface is no longer maintained.

- **Pipeline Automation**: Deep support for multi-stage pipeline chaining (Design -> Code -> Review).
- **Health Check Probes**: Automated health status checks for APIs and microservices.
- **Prompt Templates Engine**: Built-in standardized and optimized prompt template library.

---

## 5. Directory Mapping and Artifact Conventions (Best Practice Template)

- `docs/DESIGN/<feature>.md`: This iteration's dedicated design contract (SSOT).
- `tests/e2e/<feature>.spec.ts`: Playwright test script for the feature (adjust based on project's testing framework).
- `src/...`: Affected or newly created feature source code.
- `.agent/rules/core.md`: Core agent constraint rules library.
- (Optional) `docs/PROJECT-STATE.md`: Global state control center (for cross-role information sync and handoffs).

> If maintaining `PROJECT-STATE.md` is not feasible due to project scale, the minimum requirement is that each iteration task has a corresponding DESIGN spec file to ensure technical decisions remain traceable.

---

## 6. Pipeline Execution Steps (Standardized SOP)

### Step 0: Branch Isolation

- Naming convention: `feat/<feature_name>` or `fix/<bug_id>`.
- Iron rule: All AI agent changes are isolated to a new branch. Direct commits to the main line are forbidden.

### Step 1: Architecture Planning (Review) -> Produce Authoritative 2.DESIGN.md

You and the LLM Reviewer collaboratively refine and solidify `2.DESIGN.md`, which must meet the standard of "highly testable and highly implementable."

**Compliant Delivery Standards**: The DESIGN document must explicitly contain:

- Core feature boundaries (clearly define "what to build" and "what absolutely not to build").
- UI visual and interaction design (including trigger routes, control buttons, and component state machines).
- Data flow and state management (e.g., Pinia store configuration, type declarations, persistence strategies).
- Business logic rules (flags, conditional logic, exception/error handling).
- Objective acceptance criteria (at least 3 specific, automatable test checkpoints).
- Estimated affected file matrix.

### Step 2: Test Defense (Design) -> Generate E2E Spec Scaffolding

Assign Codex to study the DESIGN and produce `tests/e2e/<feature>.spec.ts`.

**Compliant Delivery Standards**:

- Each "objective acceptance criterion" must map one-to-one to an independent `test(...)` test case.
- Initial `test.skip` or empty `TODO` placeholders are acceptable, but the "business logic goal being tested" must be precisely annotated in human-readable language.

### Step 3: Code Implementation (Coding) -> Precise Implementation from DESIGN Blueprint

Assign Antigravity to study the DESIGN spec (mandatory) and test scaffolding (strongly recommended), then implement `src/...`.

**Compliant Delivery Standards**:

- Strictly self-disciplined; never modify outside the DESIGN spec scope.
- Unauthorized large-scale refactoring during this phase is prohibited.
- Each iteration must deliver: actual changed file list + local verification method confirming changes are effective.

### Step 4: Acceptance Ruling (Verify) -> Test-Driven Closure

Trigger the E2E automated test suite in the local terminal:

- Red: Verification failed. Package crash logs, Call Stack traces, assertion error messages (Console errors and visual broken-layout screenshots are a plus) -> Re-dispatch error package to Antigravity for forced convergence.
- Green: Verification passed. Approve merge and record results in version control and status dashboard.

---

## 7. 2.DESIGN.md Structural Template (Strongly Recommended)

```markdown
# <Feature_Name> Architecture Design Specification (DESIGN)

## 0. Summary

- Core implementation goal (Goal):
- Spec boundary exclusions (Non-goals):

## 1. User Flow

- Entry point (Entry):
- Main action paths (Main actions):
- Edge cases and exceptions (Edge cases):

## 2. UI Specification

- Affected pages and components (Page/Component):
- State variations (States):
- Loading/Error/Empty state indicators (Loading/Error/Empty):

## 3. Data & State

- Global state keys (Store keys):
- Types and interface definitions (Types/interfaces):
- Persistence strategy (Persistence, if any):

## 4. Business Logic Rules

- Conditional branch rule list (Rule list, if/then):
- Form and data validation rules (Validation rules):

## 5. Affected Files Matrix

- src/...
- tests/e2e/...
- docs/...

## 6. Acceptance Criteria (Must Be Objectively Testable)

- AC1:
- AC2:
- AC3:

## 7. Final Release Checklist (Verify Checklist)

- Automated test trigger commands (Commands):
- Manual visual check steps (Manual checks):
```
