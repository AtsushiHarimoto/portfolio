# 03.4. Git Merge Topology Best Practices

> **Type**: Version control workflow  
> **Focus**: Explain why default fast-forward merges damage history and why `git merge --no-ff` preserves meaningful feature boundaries for rollback and auditing.

---

## Summary

Git’s default fast-forward merge flattens a feature branch straight into the mainline, erasing the context of when the branch was created or which commits belong to that release. Moyin enforces `--no-ff` to preserve merge commits, keeping the tree structure intact so each feature release remains atomic and easily revertible.

---

## 1. Topology comparison

### ❌ Fast-forward (default trap)

- When `dev` has no new commits, `git merge feature-branch` simply moves the pointer forward.  
- The graph becomes a straight line, eliminating the visibility of the feature’s development history.  
- Without a merge commit, it’s impossible to identify which commits can be removed during a rollback when an urgent bug arises.

### ✅ No Fast-Forward

Always merge using:

```bash
git merge --no-ff feature-branch -m "Merge feature/auth-system: upgrade to JWT dual auth"
```

- Git creates a conspicuous merge commit regardless of history.  
- The merge node encapsulates all child commits, preserving the branch’s context.  
- Rollbacks are atomic: `git revert <merge-commit>` cleanly removes the feature without upsetting unrelated commits.

---

## 2. Standard merge SOP

1. **Workspace audit**  
   ```bash
   git status  # must read “working tree clean”
   ```
2. **Review diff stats**  
   ```bash
   git log dev..feature-branch --oneline
   git diff --stat dev feature-branch
   ```
3. **Sync base branch**  
   ```bash
   git checkout dev
   git pull origin dev
   ```
4. **Enforce non-fast-forward merge**  
   Use a descriptive message for business context.
5. **Push & verify**  
   ```bash
   git push origin dev
   git log --oneline -n 3
   ```
6. **Delete merged branch**  
   ```bash
   git branch -d feature-branch
   git push origin --delete feature-branch
   ```

---

## 3. Disaster recovery

When a merged feature causes catastrophic regressions:

```bash
git log --oneline --merges
git revert -m 1 <merge-hash>
```

`-m 1` tells Git to keep the mainline while rolling back the feature branch, giving you a precise undo without rewriting history.
