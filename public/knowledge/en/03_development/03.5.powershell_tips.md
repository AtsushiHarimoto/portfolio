# 03.5. PowerShell 開發技巧與環境排障手冊 (Tips & Troubleshooting)

> **類型**: 終端機開發實務  
> **重點**: 紀錄於 Windows PowerShell 驅動 Moyin 專案時，最常遭遇之權限與路徑障礙，並提供高效的自訂指令 (Aliases) 腳本。

---

## 摘要

微軟生態系下之 PowerShell 雖然具備強大的物件導向特性，但在執行 Node.js、Git 等開源工具鏈時，常因其特有之執行策略 (Execution Policy) 與檔案鎖定機制而陷入窘境。本指南彙整了本機開發階段最關鍵之除錯指令與加速捷徑。

---

## 1. 強制抹除 `node_modules` 黑洞

於 Windows 環境開發前端專案，當套件依賴錯亂需推倒重來時，傳統之 PowerShell 不具備如同 Linux `rm -rf` 般的俐落。由於 Node 模組之檔案路徑極易超過系統深度限制 (MAX_PATH) 且牽涉權限鎖定，原生刪除指令經常報錯卡死。

### 🌟 業界標準解法：委由 `rimraf` 代勞

`rimraf` 是 npm 社群專為跨平台 (特別是 Windows 路徑血淚) 打造之深度抹除工具。無需全域安裝，透過 `npx` 即可無痕叫用：

```powershell
# 於前端專案根目錄下執行，過程絕對不會因路徑過深而中斷
npx rimraf .\node_modules\
```

### 備位方案：原生 PowerShell 參數

若堅持不涉入 Node 體系：

```powershell
# -Recurse 遞迴向下，-Force 強制解除唯讀鎖定
Remove-Item -Recurse -Force .\node_modules\
```

---

## 2. 建立專案專屬之快捷指令 (Profile Aliases)

為免除頻繁輸入冗長之絕對路徑，建議將高頻切換動作綁定至 PowerShell 的啟動設定檔 (`$PROFILE`)。

### 佈建步驟

1. 呼叫記事本開啟使用者設定檔（若無此檔則系統會提示建立）：

```powershell
notepad $PROFILE
```

2. 植入下列腳本至檔案底端並存檔：

```powershell
# Moyin Project Shortcuts (請避免於註解使用中文，以防 PS 5.1 之編碼亂碼)
$MOYIN_ROOT = "D:\AI-Novel-Projects\Moyin"

# 1. 快速導航與路徑切換 (Workspace Navigation)
function mo-api { Set-Location "$MOYIN_ROOT\projects\api" }
function mo-web { Set-Location "$MOYIN_ROOT\projects\moyin-web" }
function mo-game { Set-Location "$MOYIN_ROOT\projects\moyin-game-v1\website" }

# 2. 封裝 Linux 風格之強制刪除
function rmf {
    param([Parameter(Mandatory=$true)]$Path)
    Remove-Item -Recurse -Force $Path
}
```

重新啟動終端機後，輸入 `mo-api` 即可瞬間跳轉至後端目錄。

---

## 3. 跨平台 Node 執行環境避坑

Moyin 專案為典型的混合維護架構，同時涵蓋 **Node 18 (macOS/Linux)** 與 **Node 22 (Windows)** 開發者。

- **版本鎮壓依據 (`pnpm-lock.yaml`)**：當你在 Windows 端獲取自 Mac 同事推送的程式碼報錯時，**絕對禁止**逕自刪除 `pnpm-lock.yaml`！該檔案確保了雙端依賴樹之絕對一致性。
- **邊界警示 (`engines`)**：嚴格要求各子專案之 `package.json` 必須宣告 `"engines": { "node": ">=18.0.0" }` 底線。
- **跨平台宿怨排除**：若拉取遠端端點後，執行諸如 `node-sass` 或 `esbuild` 出現二進位碼不相容的 C++ 編譯錯誤，請毅然決然**徹底銷毀**當前模組並重裝：
  ```powershell
  npx rimraf .\node_modules\
  pnpm install
  ```

---

## 4. 系統級權限障礙排除

### 錯誤：無法載入檔案，因為這個系統上已停用指令碼執行

當您首次嘗試執行如 `.ps1` 安裝腳本或啟動 `pnpm` 時，遭遇紅色警告文字。此乃 Windows 出於資安理由的預設封鎖。

**解法**：開啟具有「系統管理員 (Administrator)」權限之 PowerShell，並解除本機限制：

```powershell
# 允許執行由本機撰寫的腳本，遠端下載者則仍需數位簽章
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

輸入 `Y` 確認後，即可順利執行後續專案之自動化建置腳本。
