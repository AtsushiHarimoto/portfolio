# 03.1. Cloudflare Tunnel for Temporary Public Deployment

> **Type**: Tooling & deployment craft  
> **Focus**: Outline how Cloudflare Tunnel lets you securely and quickly expose local dev servers to the public surface for temporary demos, webhook testing, or remote previews without firewall changes or public IPs.

---

## Summary

During development you often need to make `localhost` services reachable externally. Port forwarding and VPNs are brittle and carry security baggage. Cloudflare Tunnel elegantly removes those blockers: a single command spawns an HTTPS-protected `*.trycloudflare.com` URL without opening firewalls or requesting a public IP.

---

## Chapter 1: Installation & quick start

### 1.1 Install `cloudflared`

**macOS (Homebrew)**:

```bash
brew install cloudflared
```

**Windows/Linux and other OSes**:  
Download the appropriate binary from Cloudflare’s guide:
https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/

### 1.2 Launch a quick tunnel

No account binding is required—just point the tunnel at the desired port:

```bash
cloudflared tunnel --url http://localhost:5173
```

You’ll see output like:

```text
2026-01-06T02:30:00Z INF +---------------------------------------------+
2026-01-06T02:30:00Z INF | Your quick Tunnel has been created!       |
2026-01-06T02:30:00Z INF | https://random-subdomain-1234.trycloudflare.com |
2026-01-06T02:30:00Z INF +---------------------------------------------+
```

Use that `*.trycloudflare.com` URL to let remote users hit your dev server.

---

## Chapter 2: Adjust host policies for modern frameworks

Most front-end dev servers enforce CORS or host allowlists. To keep Tunnel traffic flowing, you must loosen those guards.

### 2.1 Vite (Moyin game frontend)

Vite blocks external hosts by default. Update `vite.config.js`:

**Option A — Dev-friendly wildcard**:

```javascript
export default defineConfig({
  server: {
    host: '0.0.0.0',
    allowedHosts: true,
  },
});
```

**Option B — Restrictive allowlist**:

```javascript
export default defineConfig({
  server: {
    host: '0.0.0.0',
    allowedHosts: ['.trycloudflare.com'],
  },
});
```

### 2.2 Vue CLI / Webpack Dev Server

Update `vue.config.js` or `webpack.config.js`:

```javascript
module.exports = {
  devServer: {
    allowedHosts: 'all',
  },
};
```

### 2.3 FastAPI / Moyin gateway

FastAPI / Uvicorn are already permissive: bind to `0.0.0.0` and the tunnel works out of the box.

```bash
uvicorn main:app --host 0.0.0.0 --port 8001
```

For defense-in-depth in production, add `TrustedHostMiddleware`:

```python
from fastapi.middleware.trustedhost import TrustedHostMiddleware

app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=['localhost', '127.0.0.1', '*.trycloudflare.com'],
)
```

---

## Chapter 3: Sample workflow (frontend + backend)

To demo the full Moyin stack remotely, expose both API and UI:

**Step 1: Tunnel the backend**

```bash
# Terminal 1 – run API
cd projects/moyin-gateway/web2api
python main.py

# Terminal 2 – tunnel port 8001
cloudflared tunnel --url http://localhost:8001
# e.g., https://api-xyz.trycloudflare.com
```

**Step 2: Tunnel the frontend**

```bash
# Terminal 3 – run Vite frontend
cd projects/moyin-game-v1/website
npm run dev

# Terminal 4 – tunnel port 5173
cloudflared tunnel --url http://localhost:5173
# e.g., https://frontend-abc.trycloudflare.com
```

**Step 3: Swap API base URL for tunnel**

In the frontend `.env.development`:

```env
VITE_API_BASE_URL=https://api-xyz.trycloudflare.com
```

---

## Chapter 4: When to use — and when to avoid

### ✅ Recommended

- Webhook testing (Stripe, Line Bot, etc.)  
- Cross-device previews (mobile/tablet)  
- Prototype demos for remote stakeholders

### ❌ Forbidden

- Exposing sensitive admin panels without authentication  
- Running a “production” service without rate limiting on the temporary URL

### Advanced: Named tunnels

Temporary tunnels rotate URLs. For a stable hostname, login to Cloudflare and create a named tunnel:

```bash
cloudflared tunnel login
cloudflared tunnel create moyin-dev
cloudflared tunnel route dns moyin-dev dev.moyin.example.com
cloudflared tunnel run moyin-dev
```
