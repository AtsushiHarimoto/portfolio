# 23. 時光機與流星雨：訊息佇列與事件溯源 (MQ & Event Sourcing)

> **類型**: 非同步架構與事件驅動設計科普
> **重點**: 徹底釐清架構師眼中的「RabbitMQ」與「Kafka」的核心維度落差。為何 RabbitMQ 只是用完即丟的「任務信差」，而 Kafka 卻能配合「事件溯源 (Event Sourcing)」成為記錄宇宙變動軌跡的防彈級「時光機」。

---

## 前言：何謂「事件驅動架構 (Event-Driven)」？

隨著分散式系統龐大化，讓服務之間採用緊湊的 `HTTP / REST API` 直接互相呼叫（同步耦合）猶如連環車禍的未爆彈：若寄信伺服器剛好掛掉，註冊伺服器也會因為等不到回應而被拖垮。
現代解決方案是：**各微服務不再直接講話，而是朝中介的「佈告欄」張貼事件，並各自依照興趣去欄位上拉取 (Broker / Pub-Sub)**。這就是事件驅動！

然而，市面上的中介佈告欄 (Message Broker) 多如牛毛，最常被混淆的就是 **RabbitMQ** 與 **Kafka**。它們在設計哲學上，宛如自行車與高鐵般截然不同。

---

## 1. RabbitMQ：使命必達的「拋棄式任務信差」

傳統 Message Queue (MQ) 的代表作，專為「排隊與卸載壓力」而生。

- **核心哲學 (Smart Broker / Dumb Consumer)**：這是一間極其聰明的郵局。它會記錄這封信要派給誰。當工人 (Consumer) 來把信領走，並回報「處理完畢 (Ack)」後，**這封信就會立刻被丟進碎紙機，徹底從世界上消失**。
- **最佳實戰場景**：**命令丟擲 (Commands)** 與 **非同步削峰**。
  例如：「寄發 Email」、「非同步裁切 50 張圖」、「將這筆錯誤 Log 寫到檔案」。你不關心這些歷史，你只在乎系統繁忙時它們能在後台乖乖排好隊，慢慢被消化完，且確保「至少不會憑空蒸發」。

---

## 2. Apache Kafka：永不磨滅的「宇宙歷史紀錄儀」

儘管 Kafka 也常被拿來排隊發信，但這無疑是大炮打小鳥。Kafka 其本質是**「高吞吐量的分散式串流日誌 (Distributed Commit Log)」**。

- **核心哲學 (Dumb Broker / Smart Consumer)**：這是一本不可篡改的神聖史冊 (Log)。當有資料寫入 Kafka (Append-Only)，它絕對不會像 RabbitMQ 那樣「被讀完就燒毀」。資料會被實打實地、持續不斷地儲存於硬碟上 (直到設定的數個月到期)。既然檔案永遠都在，工人 (Consumer) 就可以隨心所欲地控制自己的「閱讀進度條 (Offset)」。
- **超級外掛力：重播 (Replay)**：如果某個分析用戶行為的 AI 伺服器昨天寫出 Bug 崩潰了，資料算錯。沒關係！把 Bug 修好後，將進度條「倒帶回昨天早上 8 點」，Kafka 會重新把所有的歷史事件原封不動地再倒給你一遍，宛如搭乘時光機重歷其境。

---

## 3. 時光機的終極展現：事件溯源 (Event Sourcing)

傳統的資料庫，我們稱之為 **狀態儲存 (State-oriented)**。
試想一輛購物車，傳統資料庫 (如 MySQL) 只會儲存結果。

> `購物車表單：[ 使用者: Moyin, 內容: 蘋果 x 5 ]`

這種存法極端脆弱。你不知道 Moyin 之前是放了什麼進去，或者他有沒有放過香蕉又拿出來？所有的「行為軌跡」都被最新狀態無情蓋過去了。

在 Kafka 開啟的道路上，出現了最高階且極度防禦性的架構：**事件溯源 (Event Sourcing)**。
我們**不再儲存最終狀態，我們只單純保存一系列「已經發生的事件 (Facts)」**。

> **事件 1**: Moyin 創建了購物車 (時間 10:00)
> **事件 2**: Moyin 加入了香蕉 x 1 (時間 10:05)
> **事件 3**: Moyin 加入了蘋果 x 5 (時間 10:08)
> **事件 4**: Moyin 移除了香蕉 x 1 (時間 10:10)

### 💡 Event Sourcing 的恐怖優勢

1. **防禦無雙**：所有寫入都是「附加 (Append-Only)」無改寫無刪除，寫入速度逼近硬體極限（極度適合高併發金融交易台）。
2. **百分之百可被查核 (Audit Trail)**：沒有任何動作能被抹滅，這在銀行帳本系統是不可妥協的天條。
3. **視角重建 (Materalized View)**：要算出目前的購物車總額？只要從第一行事件順著數學邏輯跑到最後一行 (Replay) 就能算出「共有蘋果 x 5」。

各大巨頭如紐約時報 (New York Times) 便將全體新聞文章之編輯軌跡皆投遞入 Kafka 之事件源中，任何人皆能輕易還原任一秒鐘的系統斷面。

---

## 💡 Vibecoding 工地監工發包訣竅

面對複雜的非同步網路調用架構，切不可任由 AI 隨意選用 MQ 亂湊：

> 🗣️ `「這個背景轉碼微服務只是一次性派發工作，請你搭建輕量級的 RabbitMQ 或 Redis BullMQ 佇列即可，不准濫用 Kafka 耗費資源。」`
> 或
> 🗣️ `「這次要建置的是帳務核心微服務，我們不能只留下最後的餘額數字。這個架構必須嚴格採用【事件溯源 (Event Sourcing)】模式！將所有『入金/出金』交易視為不可變的 Event，並寫入 Kafka 或 EventStore 永久保存，供後續其他所有帳單對帳微服務 (Consumers) 無限次重新讀取校驗！」`
